// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../geometry ../../../../core/arrayUtils ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/quantizationUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/arcgisLayerUrl ../../../../layers/support/fieldUtils ../../statistics/support/predominanceUtils ../../statistics/support/utils ../utils ./LayerAdapter ./support/utils ../../../../tasks/GenerateRendererTask ../../../../tasks/support/GenerateRendererParameters ../../../../tasks/support/QuantizationParameters ../../../../tasks/support/Query ../../../../tasks/support/StatisticDefinition ../../../../tasks/support/UniqueValueDefinition".split(" "),
function(V,W,w,M,G,v,u,N,H,r,O,n,x,C,I,J,P,y,D,q,K,Q,m,R,E,S,T,F,U){return function(L){function f(a){return L.call(this,a)||this}M(f,L);f.prototype.destroy=function(){this._hasLocalSource=null};f.prototype._isStatsSupportedOnService=function(){var a=this.layer;return!a.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!P.isHostedAgolService(a.url)&&10.5>a.version?n.reject(new r("feature-layer-adapter:not-supported","Layer does not support statistics query")):n.resolve()};
f.prototype._fetchFeaturesFromMemory=function(a,c){var b=this.layer;return this._hasLocalSource?n.resolve(b.source):a?a.whenLayerView(b).then(function(a){var b=x.whenFalseOnce(a,"updating").then(function(){return a.queryFeatures(c)}).then(function(a){return a.features});return n.timeout(b,1E4,null)}):n.reject(new r("feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))};f.prototype._fetchFeaturesFromService=function(a){return this.layer.queryFeatures(a).then(function(a){return a&&
a.features})};f.prototype._fetchFeaturesForStats=function(a){var c=this;return K.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}).then(function(b){return c.getSampleFeatures({sampleSize:-1,view:a.view,requiredFields:b})})};f.prototype._hasRequiredFieldsInView=function(a,c){return u(this,void 0,void 0,function(){var b,e,g=this;return v(this,function(d){switch(d.label){case 0:return[4,c.whenLayerView(this.layer)];case 1:return b=d.sent(),[4,x.whenFalseOnce(b,
"updating")];case 2:return d.sent(),e=!0,a&&a.length&&(e=a.every(function(a){a=g.getField(a);return-1<b.availableFields.indexOf(a.name)})),[2,e]}})})};f.prototype._summaryStatsFromGenRend=function(a){var c=a.normalizationType,b=a.normalizationField;return this.classBreaks({field:a.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:c,normalizationField:"field"===c?b:void 0,minValue:a.minValue,maxValue:a.maxValue}).then(function(a){var b,c,e;
a.classBreakInfos.some(function(a){a.hasAvg&&(b=a);return!!b});b&&(e=b.maxValue-b.minValue,c=b.minValue+e/2,e*=4);return m.processSummaryStatisticsResult({min:a.minValue,max:a.maxValue,avg:c,stddev:e})})};f.prototype._getSummaryStatsQuery=function(a,c){var b=a.field,e=a.normalizationType,g=a.normalizationField,d=a.normalizationTotal;c=this.supportsSQLExpression&&c?m.msSinceUnixEpochSQL(this,b):a.sqlExpression;var d=m.getFieldExpr({field:b,normalizationType:e,normalizationField:g,normalizationTotal:d}),
h=c||d,d=h?q.getRangeExpr(h,a.minValue,a.maxValue):null,b=q.getSQLFilterForNormalization({field:b,normalizationField:g,normalizationType:e});a=q.mergeWhereClauses(a.sqlWhere,b);a=q.mergeWhereClauses(a,d);b=this.layer.createQuery();b.where=q.mergeWhereClauses(b.where,a);b.sqlFormat=c?"standard":null;b.outStatistics=m.statisticTypes.map(function(a){var b=new F;b.statisticType="variance"===a?"var":a;b.onStatisticField=h;b.outStatisticFieldName=a+"_value";return b});return b};f.prototype._summaryStatsFromServiceQuery=
function(a,c){return u(this,void 0,void 0,function(){var b,e,g,d;return v(this,function(h){switch(h.label){case 0:return[4,this._isStatsSupportedOnService()];case 1:h.sent();if("percent-of-total"!==a.normalizationType)return[3,3];b=a;return[4,this._getNormalizationTotal(a.field,a.normalizationType)];case 2:b.normalizationTotal=h.sent(),h.label=3;case 3:return e=this._getSummaryStatsQuery(a,c),[4,this.layer.queryFeatures(e)];case 4:return g=h.sent(),d=m.getSummaryStatisticsFromFeatureSet(g,c),[2,m.processSummaryStatisticsResult(d)]}})})};
f.prototype._summaryStatsFromClientQuery=function(a,c){return u(this,void 0,void 0,function(){var b,e,g,d,h,l,f,k;return v(this,function(p){switch(p.label){case 0:b=a.view;if(!b)throw new r("feature-layer-adapter:insufficient-data","view is required to query stats from layerView");return[4,b.whenLayerView(this.layer)];case 1:return e=p.sent(),[4,x.whenFalseOnce(e,"updating")];case 2:return p.sent(),[4,K.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];
case 3:return g=p.sent(),[4,this._hasRequiredFieldsInView(g,b)];case 4:return d=p.sent(),h=this._getSummaryStatsQuery(a,c),!this._hasLocalSource||d?[3,6]:[4,this.layer.queryFeatures(h)];case 5:return f=p.sent(),[3,8];case 6:return[4,e.queryFeaturesJSON(h)];case 7:f=p.sent(),p.label=8;case 8:return l=f,k=m.getSummaryStatisticsFromFeatureSet(l,c),[2,m.processSummaryStatisticsResult(k)]}})})};f.prototype._summaryStatsFromMemory=function(a,c){return u(this,void 0,void 0,function(){var b,e,g,d,h,l,f,k,
p,z,A;return v(this,function(t){switch(t.label){case 0:return b=a.field,e=a.valueExpression,g=a.view,d={field:b,valueExpression:e,normalizationField:a.normalizationField,view:g},(l=a.features)?[3,2]:[4,this._fetchFeaturesForStats(d)];case 1:l=t.sent(),t.label=2;case 2:f=(h=l)&&h.length;if(!f)throw new r("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");k=w({},a);return"percent-of-total"!==k.normalizationType?[3,4]:[4,m.calculateStatsFromMemory({field:b},
h)];case 3:p=t.sent();z=p.sum;if(null==z)throw new r("feature-layer-adapter:invalid","invalid normalizationTotal");k.normalizationTotal=z;t.label=4;case 4:return[4,m.calculateStatsFromMemory(k,h,c)];case 5:return A=t.sent(),[2,m.processSummaryStatisticsResult(A)]}})})};f.prototype._uvFromGenRenderer=function(a,c){var b=this,e=a.field,g=new U;g.attributeField=e;var d=new E;d.classificationDefinition=g;return this.generateRenderer(d).then(function(a){var c={},d=b.getField(e);a.uniqueValues.forEach(function(a){var b=
a.value;if(null==b||""===b||"string"===typeof b&&(""===b.trim()||"\x3cnull\x3e"===b.toLowerCase()))b=null;null==c[b]?c[b]={count:a.count,data:y.isNumericField(d)&&b?Number(b):b}:c[b].count+=a.count});return{count:c}}).then(function(b){return m.createUVResult(b,c,a.returnAllCodedValues)})};f.prototype._getUVQuery=function(a){var c=a.field,b=a.sqlExpression,e="countOF"+(c||"Expr"),g=new F;g.statisticType="count";g.onStatisticField=b?"1":c;g.outStatisticFieldName=e;e=this.layer.createQuery();e.where=
q.mergeWhereClauses(e.where,a.sqlWhere);e.sqlFormat=b?"standard":null;e.outStatistics=[g];e.groupByFieldsForStatistics=[c||b];return e};f.prototype._uvFromServiceQuery=function(a,c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getUVQuery(a))}).then(function(c){return m.getUniqueValuesFromFeatureSet(c,b,a.field)}).then(function(b){return m.createUVResult(b,c,a.returnAllCodedValues)})};f.prototype._uvFromClientQuery=function(a,c){var b=this,e=a.view;
return e?e.whenLayerView(this.layer).then(function(e){var d=x.whenFalseOnce(e,"updating").then(function(){return e.queryFeaturesJSON(b._getUVQuery(a))}).then(function(c){return m.getUniqueValuesFromFeatureSet(c,b,a.field)}).then(function(b){return m.createUVResult(b,c,a.returnAllCodedValues)});n.timeout(d,1E4,null);return d}):n.reject(new r("feature-layer-adapter:insufficient-data","view is required to query stats from layerView"))};f.prototype._uvFromMemory=function(a,c){var b={field:a.field,valueExpression:a.valueExpression,
view:a.view};return(a.features?n.resolve(a.features):this._fetchFeaturesForStats(b)).then(function(b){return m.calculateUniqueValuesFromMemory(a,b,c)})};f.prototype._calcBinsSQL=function(a,c){var b=[],e=c.length;c.forEach(function(c,d){c=q.mergeWhereClauses(a+" \x3e\x3d "+c[0],a+(d===e-1?" \x3c\x3d ":" \x3c ")+c[1]);b.push("WHEN ("+c+") THEN "+(d+1))});return["CASE",b.join(" "),"ELSE 0 END"].join(" ")};f.prototype._getNormalizationTotal=function(a,c){return a&&"percent-of-total"===c?this.summaryStatistics({field:a}).then(function(a){return a.sum}):
n.resolve(null)};f.prototype._getQueryParamsForExpr=function(a,c){if(!a.valueExpression&&!a.sqlExpression){var b=a.field,e=b?this.getField(b):null,e=y.isDateField(e);c={field:b,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:c};return{sqlExpression:e?m.msSinceUnixEpochSQL(this,b):m.getFieldExpr(c),sqlWhere:e?null:a.sqlWhere||q.getSQLFilterForNormalization(a)}}return{valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere}};
f.prototype._getDataRange=function(a,c,b){return null!=c&&null!=b?n.resolve({min:c,max:b}):this.summaryStatistics(a).then(function(a){return{min:a.min,max:a.max}})};f.prototype._histogramForExpr=function(a){var c=this;return this._getNormalizationTotal(a.field,a.normalizationType).then(function(b){var e=c._getQueryParamsForExpr(a,b);return c._getDataRange(e,a.minValue,a.maxValue).then(function(g){var d=g.min,h=g.max,l=a.numBins||10;g=m.getEqualIntervalBins(d,h,l);g=c._calcBinsSQL(e.sqlExpression,
g);var f=new F({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),k=c.layer.createQuery();k.where=q.mergeWhereClauses(k.where,e.sqlWhere);k.sqlFormat="standard";k.outStatistics=[f];k.groupByFieldsForStatistics=[g];k.orderByFields=[g];return c._isStatsSupportedOnService().then(function(){return c.layer.queryFeatures(k)}).then(function(a){return m.getHistogramFromFeatureSet(a,d,h,l,b)})})})};f.prototype._histogramForField=function(a){var c=this,b=null,b=null!=a.minValue&&
null!=a.maxValue?n.resolve({min:a.minValue,max:a.maxValue}):this.summaryStatistics(a).then(function(a){if(!a.count)throw new r("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field");return{min:a.min,max:a.max}});return b.then(function(b){return c._getBins({min:b.min,max:b.max},a.field,a.numBins)})};f.prototype._getBins=function(a,c,b){void 0===b&&(b=10);var e=a.min,g=a.max,d=a.normTotal,h=a.excludeZerosExpr,f=a.intervals||m.getEqualIntervalBins(e,
g,b);return this._queryBins(f,a.sqlExpr||c,h).then(function(a){return{bins:a.map(function(a,b){return{minValue:f[b][0],maxValue:f[b][1],count:a.value}}),minValue:e,maxValue:g,normalizationTotal:d}})};f.prototype._queryBins=function(a,c,b){for(var e=this,g=[],d=a.length,h=0;h<d;h++){var f=q.mergeWhereClauses(b,q.mergeWhereClauses(c+" \x3e\x3d "+a[h][0],null!==a[h][1]?c+(h===d-1?" \x3c\x3d ":" \x3c ")+a[h][1]:""));g.push(f)}return n.eachAlways(g.map(function(a){return e.queryFeatureCount(a)}))};f.prototype._binParamsFromGenRend=
function(a,c){var b=a.field,e=a.normalizationType,g=a.normalizationField,d=q.getSQLFilterForNormalization({field:b,normalizationType:e,normalizationField:g});a=new E({classificationDefinition:m.createCBDefn({field:b,normalizationType:e,normalizationField:g,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numBins||10}),where:q.mergeWhereClauses(d,c)});return this.generateRenderer(a).then(function(a){return m.generateBinParams({field:b,normalizationType:e,
normalizationField:g,normalizationTotal:a.normalizationTotal,classBreaks:a.classBreaks,where:d})})};f.prototype._histogramFromMemory=function(a){var c=this,b=a.field,e=a.normalizationType,g=a.valueExpression,d=a.classificationMethod,h=a.minValue,f=a.maxValue,t=a.view,k={field:b,valueExpression:g,normalizationField:a.normalizationField,view:t};return(a.features?n.resolve(a.features):this._fetchFeaturesForStats(k)).then(function(k){if(!k||!k.length)throw new r("feature-layer-adapter:insufficient-data",
"No features are available to calculate histogram");var l=null!=h&&null!=f,p=null;d&&"equal-interval"!==d||e?(l=w({},a),l.features=k,p=c._getBinParamsFromMemory(l)):p=l?n.resolve({min:h,max:f,source:"parameters"}):c.summaryStatistics({field:b,valueExpression:g,features:k,view:t}).then(function(a){return a.count?{min:a.min,max:a.max}:n.reject(new r("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return p.then(function(b){return m.calculateHistogramFromMemory(a,
b,k)})})};f.prototype._getBinParamsFromMemory=function(a){return u(this,void 0,void 0,function(){var c,b,e,g,d,h,f,t,k,p;return v(this,function(l){c=a.field;b=a.valueExpression;e=a.classificationMethod;g=a.standardDeviationInterval;d=a.normalizationType;h=a.normalizationField;f=a.minValue;t=a.maxValue;k=a.features;p=a.view;return[2,this._classBreaksFromMemory({field:c,valueExpression:b,normalizationType:d,normalizationField:h,classificationMethod:e,standardDeviationInterval:g,minValue:f,maxValue:t,
numClasses:a.numBins,features:k,view:p}).then(function(a){var b=a.normalizationTotal;a=a.classBreakInfos;var e=q.getSQLFilterForNormalization({field:c,normalizationType:d,normalizationField:h});return m.generateBinParams({field:c,normalizationType:d,normalizationField:h,normalizationTotal:b,classBreaks:a,where:e})})]})})};f.prototype._classBreaksFromGenRend=function(a){var c=a.field,b=a.normalizationType,e=a.normalizationField,g=a.normalizationTotal,d=q.getSQLFilterForNormalization({field:c,normalizationType:b,
normalizationField:e}),g=m.getFieldExpr({field:c,normalizationType:b,normalizationField:e,normalizationTotal:g}),g=q.getRangeExpr(g,a.minValue,a.maxValue),c=m.createCBDefn({field:c,normalizationType:b,normalizationField:e,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),b=new E;b.classificationDefinition=c;b.where=q.mergeWhereClauses(d,g);return this.generateRenderer(b).then(function(b){return m.resolveCBResult(a,b)})};
f.prototype._classBreaksFromInterpolation=function(a){for(var c=a.minValue,b=a.maxValue,e=a.numClasses||5,g=[],d=(b-c)/e,h=0;h<e;h++){var f=c+h*d;g.push({minValue:f,maxValue:f+d})}g[e-1].maxValue=b;a=m.resolveCBResult(a,{classBreaks:g,normalizationTotal:a.normalizationTotal});return n.resolve(a)};f.prototype._classBreaksFromMemory=function(a){return u(this,void 0,void 0,function(){var c,b,e,g,d,f,l,t,k,p,n;return v(this,function(h){switch(h.label){case 0:return c=a.field,b=a.normalizationField,e=
a.valueExpression,g=a.view,d={field:c,valueExpression:e,normalizationField:b,view:g},(l=a.features)?[3,2]:[4,this._fetchFeaturesForStats(d)];case 1:l=h.sent(),h.label=2;case 2:t=(f=l)&&f.length;if(!t)throw new r("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");k=w({},a);return"percent-of-total"!==k.normalizationType?[3,4]:[4,m.calculateStatsFromMemory({field:c},f)];case 3:p=h.sent();n=p.sum;if(null==n)throw new r("feature-layer-adapter:invalid","invalid normalizationTotal");
k.normalizationTotal=n;h.label=4;case 4:return[2,m.calculateClassBreaksFromMemory(k,f)]}})})};f.prototype._heatmapStatsFromMemory=function(a,c){var b=this,e=a.blurRadius,g=a.field,d=a.view,f=d.state,l=f.size,t=new S.default({extent:d.extent,tolerance:f.resolution}),f=new T({returnGeometry:!0,geometry:d.extent,quantizationParameters:t});return(a.features?n.resolve(a.features):this._fetchFeaturesFromMemory(d,f)).then(function(a){a=b._quantizeFeatures(a,t,d);if(!a||!a.length)return{count:0,min:null,
max:null,avg:null,stddev:null};if(a=m.calculateHeatmapStats(a,e,c,g,l[0],l[1]))return{count:a.count,min:a.min,max:a.max,avg:a.mean,stddev:a.stdDev};throw new r("feature-layer-adapter:invalid","unable to calculate heatmap statistics");})};f.prototype._quantizeFeatures=function(a,c,b){var e=this,f=I.toQuantizationTransform(c);c=b.spatialReference;var d=b.size,h=J.isWrappable(c);b=J.getInfo(c);var l=Math.round((b.valid[1]-b.valid[0])/f.scale[0]);return a.map(function(a){var b=new N.Point(O.unwrap(a.geometry));
I.quantizePoint(f,b,b,b.hasZ,b.hasM);a.geometry=h?e._wrapPoint(b,l,d[0]):b;return a})};f.prototype._wrapPoint=function(a,c,b){0>a.x?a.x+=c:a.x>b&&(a.x-=c);return a};f.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};f.prototype.getFieldUsageInfo=function(a){return this.getField(a)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null};f.prototype.getFieldDomain=function(a,c){return this.layer.getFieldDomain(a,
c)};f.prototype.summaryStatistics=function(a){var c=this,b=a.field,b=b?this.getField(b):null,e=y.isDateField(b),f=(b=a.valueExpression||a.sqlExpression)&&!a.sqlExpression,d=a.view,d=d&&"3d"===d.type;return this._hasLocalSource||a.features||f?f||a.features||d?this._summaryStatsFromMemory(a,e):this._summaryStatsFromClientQuery(a,e):this.supportsSQLExpression||!e&&!b?(a.normalizationType&&!this.supportsSQLExpression?this._summaryStatsFromGenRend(a):this._summaryStatsFromServiceQuery(a,e)).catch(function(){return c._summaryStatsFromMemory(a,
e)}):n.reject(new r("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"))};f.prototype.uniqueValues=function(a){var c=this,b=a.field,e=a.valueExpression,f=a.sqlExpression,d=(b?this.getField(b):null)&&this.getFieldDomain(b),h=e&&(!f||!this.supportsSQLExpression),l=(b=a.view)&&"3d"===b.type;return this._hasLocalSource||a.features||h?h||a.features||l?this._uvFromMemory(a,d):this._uvFromClientQuery(a,d):this._uvFromServiceQuery(a,d).catch(function(b){return a.field?
c._uvFromGenRenderer(a,d):b}).catch(function(){return h||a.features||l?c._uvFromMemory(a,d):c._uvFromClientQuery(a,d)})};f.prototype.histogram=function(a){var c=this,b=a.field,e=a.normalizationType,f=a.normalizationField,d=a.classificationMethod,h=b?this.getField(b):null,h=y.isDateField(h),l=a.valueExpression||a.sqlExpression,t=l&&!a.sqlExpression,k=this.supportsSQLExpression,p=!d||"equal-interval"===d,z=a.minValue,A=a.maxValue,v=null!=z&&null!=A,B=a.numBins||10;return this._hasLocalSource||a.features||
t?this._histogramFromMemory(a):(l||k)&&p?l&&!k?n.reject(new r("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):this._histogramForExpr(a):h&&p?n.reject(new r("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):e||!p?this._binParamsFromGenRend(a).then(function(d){if(!v)return c._getBins(d,b,B);if(z>d.max||A<d.min)throw new r("histogram:insufficient-data",
"Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field");if(p)return c._getBins({min:z,max:A,sqlExpr:d.sqlExpr,excludeZerosExpr:d.excludeZerosExpr},b,B);d=m.getFieldExpr({field:b,normalizationType:e,normalizationField:f,normalizationTotal:d.normTotal});d=q.getRangeExpr(d,z,A);return c._binParamsFromGenRend(a,d).then(function(a){return c._getBins(a,b,B)})}):this._histogramForField(a)};f.prototype.classBreaks=function(a){var c=this,b=!1!==a.analyzeData,e=this._hasLocalSource||
a.features||a.valueExpression;return b&&e?this._classBreaksFromMemory(a):(b?this._classBreaksFromGenRend(a):this._classBreaksFromInterpolation(a)).catch(function(){return c._classBreaksFromMemory(a)})};f.prototype.queryFeatureCount=function(a){if(this._hasLocalSource)return n.reject(new r("feature-layer-adapter:not-supported","Layer does not support count query"));var c=this.layer,b=c.createQuery();b.where=q.mergeWhereClauses(b.where,a);return c.queryFeatureCount(b)};f.prototype.generateRenderer=
function(a){var c=this.layer;if(this._hasLocalSource||10.1>c.version)return n.reject(new r("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var b=new R({url:c.parsedUrl.path,source:c.dynamicDataSource,gdbVersion:c.gdbVersion}),c=c.createQuery();a.where=q.mergeWhereClauses(a.where,c.where);return b.execute(a)};f.prototype.heatmapStatistics=function(a){var c=this,b=a.field,e=a.fieldOffset;return(b&&null==e?this.summaryStatistics({field:b}):
n.resolve(null)).then(function(b){var d=e||0;if(b){var f=b.min,g=b.max;b.count?f===g&&0===f?d=1:0>=g?d="abs":0>f&&(d=-1.01*f):d=1}return c._heatmapStatsFromMemory(a,d).then(function(a){return w({},a,{summaryStatistics:b,fieldOffset:d})})})};f.prototype.predominantCategories=function(a){return u(this,void 0,void 0,function(){var c,b,e,f,d,h,l,m,k,p,n,q,u,B,w,x,y;return v(this,function(g){switch(g.label){case 0:if(!this._hasLocalSource&&!this.supportsSQLExpression)throw new r("feature-layer-adapter:not-supported",
"Layer does not support advanced SQL expressions and standardized queries");c=a.fields;b=a.view;e=D.getArcadeForPredominantCategory(c);f=D.getSQLForPredominantCategoryName(c);d=b&&"3d"===b.type;return b&&this._hasLocalSource?d?[4,this._uvFromMemory({valueExpression:e,view:b})]:[3,2]:[3,5];case 1:return m=g.sent(),[3,4];case 2:return[4,this._uvFromClientQuery({valueExpression:e,view:b})];case 3:m=g.sent(),g.label=4;case 4:return l=m,[3,7];case 5:return[4,this._uvFromServiceQuery({sqlExpression:f.expression,
valueExpression:e})];case 6:l=g.sent(),g.label=7;case 7:h=l;k=h.uniqueValueInfos;p=k.map(function(a){return a.value});n=c.filter(function(a){return-1===p.indexOf(a)});q=0;for(u=n;q<u.length;q++)B=u[q],k.push({value:B,count:0});k.sort(function(a,b){return c.indexOf(a.value)-c.indexOf(b.value)});w=0;for(x=k;w<x.length;w++)y=x[w],y.value===D.noDominantCategoryField&&(y.value=null);return[2,{predominantCategoryInfos:k}]}})})};f.prototype.getSampleFeatures=function(a){return u(this,void 0,void 0,function(){var c,
b,e,f,d,h,l,m,k,p,n,q,r;return v(this,function(g){switch(g.label){case 0:c=a.view,b=a.sampleSize,e=a.requiredFields,f=a.returnGeometry,d=this.layer.createQuery(),h=1,d.outSpatialReference=a.spatialReference||c&&c.spatialReference,d.returnGeometry=!!f,d.outFields=e,l=[],m=!1,g.label=1;case 1:return g.trys.push([1,5,,6]),[4,this._hasRequiredFieldsInView(e,c)];case 2:return(m=g.sent())?[4,this._fetchFeaturesFromMemory(c,d)]:[3,4];case 3:l=g.sent();if(l.length&&0<b&&b<=l.length)return[2,H.pickRandom(l,
b,h)];g.label=4;case 4:return[3,6];case 5:return g.sent(),[3,6];case 6:return g.trys.push([6,10,,11]),this._hasLocalSource?[2,m?l:this._fetchFeaturesFromService(d)]:[4,this.queryFeatureCount()];case 7:k=g.sent();p=this.layer.capabilities.query.maxRecordCount;n=-1===b?k:b;n=p&&n>p?p:n;if(k<=l.length||l.length>=p)return[2,l];q=c.extent.width/c.width/c.scale*4E5;d.maxAllowableOffset=a.resolution||q;return k<=n?[2,this._fetchFeaturesFromService(d)]:2E4>=k?[4,this.layer.queryObjectIds()]:[3,9];case 8:return r=
g.sent(),d.objectIds=H.pickRandom(r,n,h),[2,this._fetchFeaturesFromService(d)];case 9:return this.layer.get("capabilities.query.supportsPagination")&&(d.num=n),[2,this._fetchFeaturesFromService(d)];case 10:return g.sent(),[2,l];case 11:return[2]}})})};f.prototype.load=function(a){var c=this;a=this.layer.load(a).then(function(a){c.geometryType=a.geometryType;c.objectIdField=a.objectIdField;c.supportsSQLExpression=a.get("capabilities.query.supportsSqlExpression");c._hasLocalSource=!a.url&&!!a.source;
c.hasQueryEngine=c._hasLocalSource;c.minScale=a.minScale;c.maxScale=a.maxScale;c.fullExtent=a.fullExtent});this.addResolvingPromise(a);return this.when()};G([C.property({constructOnly:!0})],f.prototype,"layer",void 0);return f=G([C.subclass("esri.renderers.smartMapping.support.adapters.FeatureLayerAdapter")],f)}(C.declared(Q))});