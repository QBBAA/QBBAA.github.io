// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../.. ../../../pointCloudRenderers ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../intl/substitute ./support/utils ../heuristics/ageUnit ../heuristics/outline ../heuristics/sizeRange ../statistics/support/ageUtils ../support/utils ../symbology/color ../../support/AuthoringInfo ../../support/AuthoringInfoVisualVariable ../../support/numberUtils ../../support/utils ../../visualVariables/ColorVariable".split(" "),
function(ia,y,v,r,q,H,B,C,m,D,t,S,h,T,K,L,G,l,x,E,U,V,M,W){function X(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g;return r(this,function(k){switch(k.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new m("color-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new m("color-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");
a=v({},b);c=[0,2,1,3];d=l.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new m("color-visual-variable:invalid-parameters","'layer' must be one of these types: "+l.getLayerTypeLabels(c).join(", "));return[4,d.load()];case 1:return k.sent(),e=d.geometryType,"mesh"===e||!a.worldScale||a.view&&"3d"===a.view.type?[4,l.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})]:[2,t.reject(h.createError("color-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true"))];
case 2:f=k.sent();if(g=h.verifyBasicFieldValidity(d,f,"color-visual-variable:invalid-parameters"))throw g;return[2,a]}})})}function Y(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g;return r(this,function(k){switch(k.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new m("color-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new m("color-continuous-renderer:missing-parameters",
"View is required when 'valueExpression' is specified");a=v({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;c=[0,2,1,3];d=l.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new m("color-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+l.getLayerTypeLabels(c).join(", "));return[4,d.load()];case 1:k.sent();e=d.geometryType;a.outlineOptimizationEnabled="polygon"===e?a.outlineOptimizationEnabled:!1;a.sizeOptimizationEnabled=
"point"===e||"multipoint"===e||"polyline"===e?a.sizeOptimizationEnabled:!1;if("mesh"===e)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==e)throw new m("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new m("color-continuous-renderer:invalid-parameters",
"'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");}return[4,l.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 2:f=k.sent();if(g=h.verifyBasicFieldValidity(d,f,"color-continuous-renderer:invalid-parameters"))throw g;return[2,a]}})})}function Z(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g,k;return r(this,function(n){switch(n.label){case 0:if(!b||
!b.layer||!b.field&&!b.valueExpression)throw new m("color-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(b.valueExpression&&!b.view)throw new m("color-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");a=v({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"equal-interval";a.normalizationType=
l.getNormalizationType(a);c=[0,2,1,3];d=l.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new m("color-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+l.getLayerTypeLabels(c).join(", "));e=null!=a.minValue&&null!=a.maxValue;if(!e&&(null!=a.minValue||null!=a.maxValue))throw new m("color-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");return[4,d.load()];case 1:n.sent();f=d.geometryType;a.outlineOptimizationEnabled=
"polygon"===f?a.outlineOptimizationEnabled:!1;if("mesh"===f)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==f)throw new m("color-continuous-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new m("color-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");
}return[4,l.getFieldsList({field:a.field,normalizationField:a.normalizationField})];case 2:g=n.sent();if(k=h.verifyBasicFieldValidity(d,g,"color-class-breaks-renderer:invalid-parameters"))throw k;return[2,a]}})})}function aa(b){b=v({},b);delete b.basemap;delete b.colorScheme;delete b.legendOptions;delete b.symbolType;delete b.defaultSymbolEnabled;delete b.colorMixMode;delete b.edgesType;b.analyzeData=!(null!=b.minValue&&null!=b.maxValue);return b}function ba(b){if(!b||!b.layer)return t.reject(h.createError("color-point-cloud-true-color-renderer:missing-parameters",
"'layer' parameter is required"));var a=v({},b);b=[4];var c=l.createLayerAdapter(a.layer,b);a.layer=c;a.density=a.density||25;a.size=a.size||"100%";return h.isValidPointSize(a.size)?c?c.load().then(function(){return a}):t.reject(h.createError("color-point-cloud-true-color-renderer:invalid-parameters","'layer' must be one of these types: "+l.getLayerTypeLabels(b).join(", "))):t.reject(h.createError("color-point-cloud-true-color-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}
function ca(b){if(!(b&&b.layer&&b.field))return t.reject(h.createError("color-point-cloud-continuous-renderer:missing-parameters","'layer' and 'field' parameters are required"));var a=b.field.toLowerCase();if("intensity"!==a&&"elevation"!==a)return t.reject(h.createError("color-point-cloud-continuous-renderer:invalid-parameters","'field' should be either 'intensity' or 'elevation'"));var c=v({},b);b=[4];a=l.createLayerAdapter(c.layer,b);c.layer=a;c.density=c.density||25;c.size=c.size||"100%";return h.isValidPointSize(c.size)?
a?a.load().then(function(){return c}):t.reject(h.createError("color-point-cloud-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+l.getLayerTypeLabels(b).join(", "))):t.reject(h.createError("color-point-cloud-continuous-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function N(b){b=v({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");delete b.symbolType;delete b.defaultSymbolEnabled;delete b.colorMixMode;delete b.edgesType;
b.worldScale=a;return b}function da(b){return q(this,void 0,void 0,function(){var a,c,d,e,f;return r(this,function(g){switch(g.label){case 0:if(!(b&&b.layer&&b.view&&b.startTime&&b.endTime))throw new m("color-age-renderer:missing-parameters","'layer', 'view', startTime', 'endTime' parameters are required");a=v({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;c=[0,2,1,3];d=l.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new m("color-age-renderer:invalid-parameters",
"'layer' must be one of these types: "+l.getLayerTypeLabels(c).join(", "));return[4,d.load()];case 1:g.sent();e=d.geometryType;a.outlineOptimizationEnabled="polygon"===e?a.outlineOptimizationEnabled:!1;a.sizeOptimizationEnabled="point"===e||"multipoint"===e||"polyline"===e?a.sizeOptimizationEnabled:!1;if("mesh"===e)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else if("3d-volumetric-uniform"===a.symbolType&&"point"!==e)throw new m("color-continuous-renderer:not-supported",
"3d-volumetric-uniform symbols are supported for point layers only");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new m("color-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");if(f=G.verifyDates(d,a.startTime,a.endTime,"color-age-renderer:invalid-parameters"))throw f;if(a.unit&&-1===G.supportedAgeUnits.indexOf(a.unit))throw new m("color-age-renderer:invalid-unit",
"Supported units are: "+G.supportedAgeUnits.join(", "));return[2,a]}})})}function A(b,a){return q(this,void 0,void 0,function(){var c,d,e,f,g,k,n;return r(this,function(p){switch(p.label){case 0:return c=b.colorScheme,e=d=null,[4,h.getBasemapInfo(b.basemap,b.view)];case 1:f=p.sent();d=D.isSome(f.basemapId)?f.basemapId:null;e=D.isSome(f.basemapTheme)?f.basemapTheme:null;if(c)return[2,{scheme:x.cloneScheme(c),basemapId:d,basemapTheme:e}];g=a||b.theme||"high-to-low";if(k=x.getSchemes({theme:g,basemap:d,
basemapTheme:e,geometryType:b.geometryType,worldScale:b.worldScale,view:b.view}))d=k.basemapId,e=k.basemapTheme,b.schemeId?(n=g+"/"+d+"/"+b.schemeId,c=x.getSchemeById({id:n,geometryType:b.geometryType})):c=k.primaryScheme;return[2,{scheme:c,basemapId:d,basemapTheme:e}]}})})}function O(b,a,c){for(var d=(a-b)/(c-1),e=[b],f=1;f<=c-2;f++)e.push(b+f*d);e.push(a);return V.round(e,{strictBounds:!0})}function ea(b,a){return q(this,void 0,void 0,function(){var c,d,e,f,g,k,n;return r(this,function(p){switch(p.label){case 0:return c=
a.layer,[4,A({basemap:a.basemap,colorScheme:a.colorScheme,geometryType:c.geometryType,schemeId:"elevation"===a.field.toLowerCase()?"point-cloud-elevation-scheme":"point-cloud-intensity-scheme"})];case 1:d=p.sent();e=d.scheme;if(!e)throw h.createError("color-point-cloud-continuous-renderer:insufficient-info","Unable to find color scheme");f=h.createColors(e.colors,5);if(5>f.length)throw h.createError("color-point-cloud-continuous-renderer:insufficient-info","Color scheme does not have enough colors");
k=(g=h.getDefaultDataRange(b,!1,!0))?O(g[0],g[1],5):h.createStopValues(b);n=M.createColorStops({values:k,isDate:!1,dateFormatOptions:null,colors:f,labelIndexes:[0,2,4]});return[2,{stops:n,basemapId:d.basemapId,basemapTheme:d.basemapTheme,statistics:b,defaultValuesUsed:!!g,colorScheme:x.cloneScheme(e)}]}})})}function fa(b,a,c){return q(this,void 0,void 0,function(){var d,e,f,g,k,n,p,m,w,l,q,t,z,u,F;return r(this,function(P){switch(P.label){case 0:return d=c.layer,e=c.field,f="function"===typeof e,
k=(g=e&&!f?d.getField(e):null)&&"date"===g.type,[4,A({basemap:c.basemap,theme:c.theme,geometryType:d.geometryType,colorScheme:c.colorScheme,worldScale:c.worldScale,view:c.view})];case 1:n=P.sent();p=n.scheme;if(!p)throw h.createError("color-visual-variable:insufficient-info","Unable to find color scheme");m=h.createColors(p.colors,5);if(5>m.length)throw h.createError("color-visual-variable:insufficient-info","Color scheme does not have enough colors");w=h.getDefaultDataRange(b,k,!0);l=-1<p.id.indexOf("seq-");
q=w?O(w[0],w[1],5):h.createStopValues(b,l);t=h.createColors(m,5);z=new W({field:e,valueExpression:c.valueExpression,valueExpressionTitle:c.valueExpressionTitle,normalizationField:a,stops:q.map(function(a,b){return{value:a,color:t[b]}}),legendOptions:c.legendOptions});u=new U({type:"color",minSliderValue:null!=c.minValue?c.minValue:b.min,maxSliderValue:null!=c.maxValue?c.maxValue:b.max,theme:p.theme});F=new E({visualVariables:[u]});return[2,{basemapId:n.basemapId,basemapTheme:n.basemapTheme,visualVariable:z,
statistics:b,defaultValuesUsed:!!w,colorScheme:x.cloneScheme(p),authoringInfo:F}]}})})}function Q(b,a,c,d,e,f){var g=f.field,k=f.layer.geometryType,n=f.defaultSymbolEnabled,p=x.cloneScheme(b.colorScheme),m=a&&a.opacity,w=[b.visualVariable.clone()];a&&a.visualVariables&&a.visualVariables.length&&w.push.apply(w,a.visualVariables.map(function(a){return a.clone()}));c&&c.minSize&&w.push(c.minSize);return{renderer:new B.ClassBreaksRenderer({classBreakInfos:[{minValue:-R,maxValue:R,symbol:h.createSymbol(k,
{type:f.symbolType,color:p.noDataColor,size:h.getSymbolSizeFromScheme(p,k),outline:h.getSymbolOutlineFromScheme(p,k,m),meshInfo:{colorMixMode:f.colorMixMode,edgesType:f.edgesType}})}],defaultLabel:n?H.other:null,defaultSymbol:n?h.createSymbol(k,{type:f.symbolType,color:p.noDataColor,size:h.getSymbolSizeFromScheme(p,k),outline:h.getSymbolOutlineFromScheme(p,k,m),meshInfo:{colorMixMode:f.colorMixMode,edgesType:f.edgesType}}):null,field:g,normalizationType:d,normalizationField:e,valueExpression:f.valueExpression,
valueExpressionTitle:f.valueExpressionTitle,visualVariables:w,authoringInfo:b.authoringInfo&&b.authoringInfo.clone()}),visualVariable:b.visualVariable.clone(),statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,colorScheme:x.cloneScheme(b.colorScheme),basemapId:b.basemapId,basemapTheme:b.basemapTheme}}function I(b){return q(this,void 0,void 0,function(){var a,c,d,e,f;return r(this,function(g){switch(g.label){case 0:return[4,X(b)];case 1:a=g.sent();d=(c=a.normalizationField)?"field":void 0;
if(!a.statistics)return[3,2];f=a.statistics;return[3,4];case 2:return[4,h.getSummaryStatistics({layer:a.layer,field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:d,normalizationField:c,minValue:a.minValue,maxValue:a.maxValue,view:a.view})];case 3:f=g.sent(),g.label=4;case 4:return e=f,[2,fa(e,c,a)]}})})}function ga(b,a){b=b.colorsForClassBreaks;var c;if(b&&0<b.length&&(b.some(function(b){b.numClasses===a&&(c=b.colors);return!!c}),!c)){var d=
b[b.length-1];b=a-d.numClasses;if(0<b){var e=d.colors[d.numClasses-1];c=d.colors.splice(0);for(d=1;d<=b;d++)c.push(e)}}c&&(c=h.createColors(c,c.length));return c}function ha(b,a){return q(this,void 0,void 0,function(){var c,d,e,f,g,k,n,p,l,w,q,t,v,z;return r(this,function(u){switch(u.label){case 0:return c=b.layer,d=b.defaultSymbolEnabled,e=c.geometryType,[4,A({basemap:b.basemap,geometryType:e,colorScheme:b.colorScheme,worldScale:-1<b.symbolType.indexOf("3d-volumetric"),view:b.view})];case 1:f=u.sent();
g=f.scheme;k=a.result;n=a.outlineResult;p=k.classBreakInfos;l=b.classificationMethod;w="standard-deviation"===l;q=b.normalizationType;if(!g)throw new m("color-class-breaks-renderer:insufficient-info","Unable to find color scheme");t=ga(g,p.length);if(!t||t.length!==p.length)throw new m("color-class-breaks-renderer:insufficient-info","Color scheme does not have enough colors");v=n&&n.opacity;z=new B.ClassBreaksRenderer({classBreakInfos:p.map(function(a,c){return{minValue:a.minValue,maxValue:a.maxValue,
symbol:h.createSymbol(e,{type:b.symbolType,color:t[c],size:h.getSymbolSizeFromScheme(g,e),outline:h.getSymbolOutlineFromScheme(g,e,v),meshInfo:{colorMixMode:b.colorMixMode,edgesType:b.edgesType}}),label:a.label}}),defaultLabel:d?H.other:null,defaultSymbol:d?h.createSymbol(e,{type:b.symbolType,color:g.noDataColor,size:h.getSymbolSizeFromScheme(g,e),outline:h.getSymbolOutlineFromScheme(g,e,v),meshInfo:{colorMixMode:b.colorMixMode,edgesType:b.edgesType}}):null,field:b.field,valueExpression:b.valueExpression,
valueExpressionTitle:b.valueExpressionTitle,normalizationType:q,normalizationField:b.normalizationField,normalizationTotal:"percent-of-total"===q?k.normalizationTotal:void 0,legendOptions:b.legendOptions,authoringInfo:new E({type:"class-breaks-color",classificationMethod:l,standardDeviationInterval:b.standardDeviationInterval})});w||M.setLabelsForClassBreaks({classBreakInfos:z.classBreakInfos,classificationMethod:l,normalizationType:q,round:!0});n&&n.visualVariables&&n.visualVariables.length&&(z.visualVariables=
n.visualVariables.map(function(a){return a.clone()}));return[2,{renderer:z,colorScheme:x.cloneScheme(g),classBreaksResult:k,defaultValuesUsed:a.defaultValuesUsed,basemapId:f.basemapId,basemapTheme:f.basemapTheme}]}})})}Object.defineProperty(y,"__esModule",{value:!0});var R=Math.pow(2,53)-1;y.createVisualVariable=I;y.createContinuousRenderer=function(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g,h,n,p;return r(this,function(k){switch(k.label){case 0:return[4,Y(b)];case 1:return a=k.sent(),
c=a.layer,d=a.view,[4,t.all([I(N(a)),a.outlineOptimizationEnabled?K({layer:c,view:d}):null,a.sizeOptimizationEnabled?L({layer:c,view:d}):null])];case 2:return e=k.sent(),f=e[0],g=e[1],h=e[2],p=(n=a.normalizationField)?"field":void 0,[2,Q(f,g,h,p,n,a)]}})})};y.createClassBreaksRenderer=function(b){return q(this,void 0,void 0,function(){var a,c;return r(this,function(d){switch(d.label){case 0:return[4,Z(b)];case 1:return a=d.sent(),[4,h.getClassBreaks(aa(a),a.outlineOptimizationEnabled)];case 2:return c=
d.sent(),[2,ha(a,c)]}})})};y.createPCTrueColorRenderer=function(b){return ba(b).then(function(a){return{renderer:new C.PointCloudRGBRenderer({field:"RGB",pointsPerInch:a.density,pointSizeAlgorithm:h.getPointSizeAlgorithm(a.size)})}})};y.createPCContinuousRenderer=function(b){return q(this,void 0,void 0,function(){var a,c,d,e,f;return r(this,function(g){switch(g.label){case 0:return[4,ca(b)];case 1:a=g.sent();if(!a.statistics)return[3,2];d=a.statistics;return[3,4];case 2:return[4,h.getSummaryStatistics({layer:a.layer,
field:a.field})];case 3:d=g.sent(),g.label=4;case 4:return c=d,[4,ea(c,a)];case 5:return e=g.sent(),f=new C.PointCloudStretchRenderer({field:a.field,pointsPerInch:a.density,pointSizeAlgorithm:h.getPointSizeAlgorithm(a.size),stops:e.stops}),[2,{renderer:f,basemapId:e.basemapId,basemapTheme:e.basemapTheme,statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,colorScheme:e.colorScheme}]}})})};y.createAgeRenderer=function(b){return q(this,void 0,void 0,function(){var a,c,d,e,f,g,k,n,p,m,l,q,x,
y,z,u,F,A,B,C,D,J,E;return r(this,function(r){switch(r.label){case 0:return[4,da(b)];case 1:return a=r.sent(),c=a.defaultSymbolEnabled,d=a.view,e=a.startTime,f=a.endTime,g=a.symbolType,k=a.colorMixMode,n=a.edgesType,p=a.minValue,m=a.maxValue,l=a.layer,[4,t.all([a.unit?{unit:a.unit,statistics:null}:T({view:d,layer:l,startTime:e,endTime:f,minValue:p,maxValue:m}),a.outlineOptimizationEnabled?K({layer:l,view:d}):null,a.sizeOptimizationEnabled?L({layer:l,view:d}):null])];case 2:return q=r.sent(),x=q[0],
y=q[1],z=q[2],u=x.unit,F=x.statistics,A=G.getAgeExpressions({layer:l,startTime:e,endTime:f,unit:u}).valueExpression,B=S.substitute(H["ageInfo_"+u],{unit:u,startTime:h.formatDate(e,u,l),endTime:h.formatDate(f,u,l)}),[4,I(N({layer:l,basemap:a.basemap,valueExpression:A,symbolType:g,statistics:F,legendOptions:{title:B},colorScheme:a.colorScheme,theme:a.theme,view:d,minValue:a.minValue,maxValue:a.maxValue}))];case 3:return C=r.sent(),D={layer:l,valueExpression:A,defaultSymbolEnabled:c,symbolType:g,colorMixMode:k,
edgesType:n},J=Q(C,y,z,null,null,D),E=J.renderer.authoringInfo.visualVariables,E.forEach(function(a){return h.updateAgeRendererAuthoringInfoVV(a,e,f,u)}),[2,v({},J,{unit:u})]}})})}});