// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../geometry ../PopupTemplate ../rasterRenderers ../core/Error ../core/maybe ../core/MultiOriginJSONSupport ../core/accessorSupport/decorators ../core/accessorSupport/ensureType ./Layer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./support/commonProperties ./support/DimensionalDefinition ./support/Field ./support/imageryRendererUtils ./support/RasterJobHandler ./support/TileInfo ./support/rasterDatasets/RasterFactory ../renderers/support/RasterSymbolizer ../support/popupUtils".split(" "),
function(P,Q,g,A,d,k,e,r,B,t,C,D,E,c,F,G,H,I,J,K,u,v,w,x,L,y,M,N,O){return function(z){function a(b,a){b=z.call(this,b)||this;b._rasterJobHandler={instance:null,refCount:0,connectionPromise:null};b._symbolizer=null;b.bandIds=null;b.fullExtent=null;b.interpolation="nearest";b.isReference=null;b.listMode="show";b.multidimensionalDefinition=null;b.raster=null;b.rasterInfo=null;b.spatialReference=null;b.tileInfo=null;b.title=null;b.type="imagery-tile";b.url=null;b.operationalLayerType="ArcGISTiledImageServiceLayer";
b.popupEnabled=!0;b.popupTemplate=null;b.renderer=null;return b}A(a,z);a.prototype.normalizeCtorArgs=function(b,a){return"string"===typeof b?g({url:b},a):b};a.prototype.load=function(b){var a=this,c=D.isSome(b)?b.signal:null;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},b).then(function(){return a._openRaster(c)},function(){return a._openRaster(c)}));return this.when()};Object.defineProperty(a.prototype,"hasTilingEffects",{get:function(){return this.renderer&&"dynamicRangeAdjustment"in
this.renderer&&this.renderer.dynamicRangeAdjustment},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"defaultPopupTemplate",{get:function(){return this.createPopupTemplate()},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"fields",{get:function(){return[new w({name:"Raster.PixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})]},enumerable:!0,configurable:!0});a.prototype.readRenderer=function(b,a,c){b=t.read(a&&a.layerDefinition&&a.layerDefinition.drawingInfo&&
a.layerDefinition.drawingInfo.renderer,c)||void 0;if(null!=b)return b};a.prototype.createPopupTemplate=function(b){return O.createPopupTemplate(this,b)};a.prototype.updateRenderer=function(){return e(this,void 0,void 0,function(){var b;return k(this,function(a){if(JSON.stringify(this._cachedRendererJson)===JSON.stringify(this.renderer))return[2];this._cachedRendererJson=this.renderer.toJSON();b=this._rasterJobHandler.instance;if(!b)return[2];this._symbolizer.bind();return[2,b.updateSymbolizer(this._symbolizer)]})})};
a.prototype.applyRenderer=function(b){return e(this,void 0,void 0,function(){var a,c;return k(this,function(d){switch(d.label){case 0:if(!(b&&b.pixels&&0<b.pixels.length))return[2,null];this.updateRenderer();return(c=this._rasterJobHandler.instance)?[4,c.symbolize(b)]:[3,2];case 1:return a=d.sent(),[3,3];case 2:a=this._symbolizer.symbolize(b),d.label=3;case 3:return[2,a]}})})};a.prototype.fetchTile=function(b,a,c,d){void 0===d&&(d={});return e(this,void 0,void 0,function(){return k(this,function(f){switch(f.label){case 0:return[4,
this._initJobHandler()];case 1:return f.sent(),this.multidimensionalDefinition&&(d=g({multidimensionalDefinition:this.multidimensionalDefinition},d)),[2,this.raster.fetchTile(b,a,c,d)]}})})};a.prototype.fetchPixels=function(b,a,c,d){return e(this,void 0,void 0,function(){return k(this,function(f){switch(f.label){case 0:return[4,this._initJobHandler()];case 1:return f.sent(),this.multidimensionalDefinition&&(d=g({multidimensionalDefinition:this.multidimensionalDefinition},d)),[2,this.raster.fetchPixels(b,
a,c,d)]}})})};a.prototype.increaseRasterJobHandlerUsage=function(){this._rasterJobHandler.refCount++};a.prototype.decreaseRasterJobHandlerUsage=function(){this._rasterJobHandler.refCount--;0>=this._rasterJobHandler.refCount&&this._shutdownJobHandler()};a.prototype._initJobHandler=function(){var a=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;var c=new L;this._rasterJobHandler.connectionPromise=c.initialize().then(function(){a._rasterJobHandler.instance=
c;a.raster.rasterJobHandler=c}).catch(function(){return null});return this._rasterJobHandler.connectionPromise};a.prototype._shutdownJobHandler=function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy();this._rasterJobHandler.instance=null;this._rasterJobHandler.connectionPromise=null;this._rasterJobHandler.refCount=0;this.raster.rasterJobHandler=null};a.prototype._openRaster=function(a){return e(this,void 0,void 0,function(){var b,c,d,e,h,l,g,p,m,q,n;return k(this,function(f){switch(f.label){case 0:return[4,
M.open(this.raster||{url:this.url,signal:a})];case 1:b=f.sent();this.url||(this.url=b.url);this.raster=b;c=b.rasterInfo;if(!c)throw new C("tile-imagery-layer:load","cannot load resources on "+this.url);d=c.spatialReference;e=c.pixelSize;h=c.storageInfo;l=h.tileInfo;if(!l){g=[];p=h.maximumPyramidLevel||0;m=Math.max(e.x,e.y);q=1/.0254*96*m;for(n=0;n<=p;n++)g.push({level:p-n,resolution:m,scale:q}),m*=2,q*=2;l=new y({origin:h.origin,size:[h.blockWidth,h.blockHeight],spatialReference:d,lods:g});h.tileInfo=
l}null==this.title&&(this.title=this.raster.datasetName);c.multidimensionalInfo&&this._configDefaultSlice();this._configDefaultRenderer();return[2,b]}})})};a.prototype._configDefaultSlice=function(){var a=this.raster.rasterInfo.multidimensionalInfo;this.multidimensionalDefinition=[new v({variableName:a.variables[0].name,dimensionName:a.variables[0].dimensions[0].name,values:a.variables[0].dimensions[0].values[0]})]};a.prototype._configDefaultRenderer=function(){var a=this.raster.rasterInfo,c=a.pixelType;
this.bandIds||(this.bandIds=x.getDefaultBandCombination(a));this.renderer||(this.renderer=x.createDefaultRenderer(a,this.bandIds));"u8"===c&&this.renderer&&"stretchType"in this.renderer&&"min-max"===this.renderer.stretchType&&this.renderer.dynamicRangeAdjustment&&(this.renderer.dynamicRangeAdjustment=!1,this.renderer.statistics=this.renderer.statistics||[[0,255],[0,255],[0,255]]);this._symbolizer?(this._symbolizer.renderer=this.renderer,this._symbolizer.rasterInfo=a):this._symbolizer=new N({renderer:this.renderer,
rasterInfo:a});this._symbolizer.bind()||(this._symbolizer=null)};d([c.property()],a.prototype,"_cachedRendererJson",void 0);d([c.property()],a.prototype,"_rasterJobHandler",void 0);d([c.property()],a.prototype,"_symbolizer",void 0);d([c.property({type:[F.Integer],json:{write:!0}})],a.prototype,"bandIds",void 0);d([c.property({type:r.Extent}),c.aliasOf("rasterInfo.extent")],a.prototype,"fullExtent",void 0);d([c.property({readOnly:!0,dependsOn:["renderer"]})],a.prototype,"hasTilingEffects",null);d([c.property({type:String,
json:{write:!0}})],a.prototype,"interpolation",void 0);d([c.property({type:Boolean,json:{read:!1}})],a.prototype,"isReference",void 0);d([c.property({type:["show","hide"]})],a.prototype,"listMode",void 0);d([c.property({type:[v]})],a.prototype,"multidimensionalDefinition",void 0);d([c.property()],a.prototype,"raster",void 0);d([c.property({readOnly:!0}),c.aliasOf("raster.rasterInfo")],a.prototype,"rasterInfo",void 0);d([c.property({type:r.SpatialReference}),c.aliasOf("rasterInfo.spatialReference")],
a.prototype,"spatialReference",void 0);d([c.property({type:y,dependsOn:["rasterInfo"]}),c.aliasOf("rasterInfo.storageInfo.tileInfo")],a.prototype,"tileInfo",void 0);d([c.property()],a.prototype,"title",void 0);d([c.property({readOnly:!0,json:{read:!1}})],a.prototype,"type",void 0);d([c.property(u.url)],a.prototype,"url",void 0);d([c.property({type:["ArcGISTiledImageServiceLayer"]})],a.prototype,"operationalLayerType",void 0);d([c.property(u.popupEnabled)],a.prototype,"popupEnabled",void 0);d([c.property({type:B,
json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],a.prototype,"popupTemplate",void 0);d([c.property({readOnly:!0,dependsOn:["title"]})],a.prototype,"defaultPopupTemplate",null);d([c.property({readOnly:!0,type:[w]})],a.prototype,"fields",null);d([c.property({types:t.rasterRendererTypes,json:{read:{source:"layerDefinition.drawingInfo.renderer"},write:{target:"layerDefinition.drawingInfo.renderer"}}})],a.prototype,"renderer",void 0);d([c.reader("renderer")],a.prototype,"readRenderer",null);
return a=d([c.subclass("esri.layers.TileImageryLayer")],a)}(c.declared(K.ScaleRangeLayer(J.RefreshableLayer(H.OperationalLayer(I.PortalLayer(E.MultiOriginJSONMixin(G)))))))});