// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../geometry","../rasterFunctions/rasterProjectionHelper"],function(v,h,m,n){function t(a,b,c){var d=Math.log(a.x/b.pixelSize.x)/Math.LN2,e=Math.log(a.y/b.pixelSize.y)/Math.LN2;a=b.storageInfo.maximumPyramidLevel||0;c="down"===c?Math.floor(Math.min(d,e)):"up"===c?Math.ceil(Math.max(d,e)):Math.round((d+e)/2);d=!1;0>c?c=0:c>a&&(c=a,d=0===a&&3<c);a=Math.pow(2,c);b=new m.Point({x:a*b.pixelSize.x,y:a*b.pixelSize.y,spatialReference:b.spatialReference});return{pyramidLevel:c,
pyramidResolution:b,excessiveReading:d}}function u(a,b){if(!f.has(a))return null;a=f.get(a);return null==a[b]?null:a[b]}Object.defineProperty(h,"__esModule",{value:!0});var f=new Map;h.register=function(a,b){b={extent:null,rasterInfo:b,cache:new Map};if(f.has(a))return a=f.get(a),a.push(b),a.length-1;f.set(a,[b]);return 0};h.unregister=function(a,b){f.has(a)&&(f.get(a)[b]=null)};h.deleteRaster=function(a){f.delete(a)};h.getBlock=function(a,b,c){if(!f.has(a))return null;var d=f.get(a);if(null==d[b]){for(var e=
0;e<d.length;e++)if(d[e].cache.has(c))return d[e].cache.get(c);return null}a=d[b].cache;if(a.has(c))return a.get(c);for(e=0;e<d.length;e++)if(e!==b&&d[e]&&d[e].cache.has(c))return b=d[e].cache.get(c),a.set(c,b),b;return null};h.putBlock=function(a,b,c,d){if(!f.has(a))return null;a=f.get(a);if(null==a[b])return null;a[b].cache.set(c,d)};h.update=function(a,b,c,d,e,g,f){void 0===f&&(f=null);a=u(a,b);b=a.extent;var h=a.cache,k=a.rasterInfo;if(!b||b.xmin!==c.xmin||b.xmax!==c.xmax||b.ymin!==c.ymin||b.ymax!==
c.ymax){var l=k.spatialReference;b=n.projectExtent(c,l,f);d=new m.Point({x:d,y:d,spatialReference:c.spatialReference});if(null===e&&(e=n.projectResolution(d,l,c,f),!e))return;g=t(e,k,g||"closest");e=g.pyramidLevel;g=g.pyramidResolution;l=Math.floor((b.xmin-k.storageInfo.origin.x)/g.x);f=Math.floor((k.storageInfo.origin.y-b.ymax)/g.y);var p=0<e?k.storageInfo.pyramidBlockWidth:k.storageInfo.blockWidth,q=0<e?k.storageInfo.pyramidBlockHeight:k.storageInfo.blockHeight,k=Math.floor(l/p);d=Math.floor(f/
q);l=Math.floor((l+Math.ceil((b.xmax-b.xmin)/g.x-.1)-1)/p);b=Math.floor((f+Math.ceil((b.ymax-b.ymin)/g.y-.1)-1)/q);var r=new Set;for(g=d-1;g<=b+1;g++)for(f=k-1;f<=l+1;f++)r.add(e+"/"+g+"/"+f);h.forEach(function(a,b){r.has(b)||h.delete(b)});a.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}}});