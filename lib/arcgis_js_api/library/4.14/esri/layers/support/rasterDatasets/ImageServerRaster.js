// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/declareExtendsHelper ../../../geometry ../../../request ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../RasterInfo ../RasterStorageInfo ../TileInfo ./BaseRaster ../rasterFunctions/pixelUtils ../../../tasks/support/FeatureSet".split(" "),function(V,W,H,G,I,N,F,v,L,O,P,x,M,Q,
R,S,T,U){return function(J){function c(){var m=null!==J&&J.apply(this,arguments)||this;m._levelOffset=0;m.sourceJSON=null;return m}N(c,J);c.prototype.open=function(m){return I(this,void 0,void 0,function(){var a,n,C,e,h,d,b,f,g,c,p,k,q,B,y,u,K,z,A,r,l,t,D,E;return H(this,function(w){switch(w.label){case 0:return[4,this.init()];case 1:w.sent();a=m&&m.signal;if(!this.sourceJSON)return[3,2];C={data:this.sourceJSON};return[3,4];case 2:return[4,v(this.url,{responseType:"json",query:{f:"json"},signal:a})];
case 3:C=w.sent(),w.label=4;case 4:n=C;n.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));this.sourceJSON=e=n.data;h="jpg jpeg png png8 png24 png32 mixed".split(" ");this.tileType=e.cacheType;null===this.tileType&&(-1<h.indexOf(e.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===e.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster");if(!e||!e.tileInfo)throw new L("imageserverraster:open","cannot initialize tiled image service");this.datasetName=e.name;return[4,
this._fetchRasterInfo({signal:a})];case 5:d=w.sent();if(O.isSome(d)){b=R.fromJSON(e.tileInfo);f=d.extent;g=d.pixelSize;c=Math.max(g.x,g.y);p=.5/d.width*g.x;q=k=void 0;B=b.lodAt(Math.max.apply(null,b.lods.map(function(a){return a.level})));0!==e.maxScale&&(k=b.lods.filter(function(a){return Math.abs(a.scale-e.maxScale)<p})[0]);k||(k=B);y=b.lodAt(Math.min.apply(null,b.lods.map(function(a){return a.level})));0!==e.minScale&&(q=b.lods.filter(function(a){return Math.abs(a.scale-e.minScale)<p})[0],this._levelOffset=
q.level-y.level);q||(q=y);if(Math.abs(g.x-g.y)>p||!b.lods.some(function(a){return Math.abs(a.resolution-c)<p}))g.x=g.y=k.resolution,d.width=Math.ceil((f.xmax-f.xmin)/g.x-.1),d.height=Math.ceil((f.ymax-f.ymin)/g.y-.1);u=k.level-q.level;K=b.size;z=K[0];A=K[1];r=b.origin;l=g.x;t=g.y;D=[{minCol:Math.floor((f.xmin-r.x+.1*l)/z/l),maxCol:Math.floor((f.xmax-r.x-.1*l)/z/l),minRow:Math.floor((r.y-f.ymax+.1*t)/A/t),maxRow:Math.floor((r.y-f.ymin-.1*t)/A/t)}];if(0<u)for(E=0;E<u;E++)l*=2,t*=2,D.push({minCol:Math.floor((f.xmin-
r.x+.1*l)/z/l),maxCol:Math.floor((f.xmax-r.x-.1*l)/z/l),minRow:Math.floor((r.y-f.ymax+.1*t)/A/l),maxRow:Math.floor((r.y-f.ymin-.1*t)/A/l)});d.storageInfo=new Q({blockWidth:b.size[0],blockHeight:b.size[1],pyramidBlockWidth:b.size[0],pyramidBlockHeight:b.size[1],compression:b.format,origin:b.origin,firstPyramidLevel:1,maximumPyramidLevel:u,tileInfo:b,blockBoundary:D});this._set("rasterInfo",d)}else throw new L("image-server-raster:open","cannot initialize image service");return[2]}})})};c.prototype.fetchRawTile=
function(m,a,n,c){void 0===c&&(c={});return I(this,void 0,void 0,function(){var e,h,d,b,f,g,C,p,k,q,B,y,u,v,z,A,r,l,t,D,E;return H(this,function(w){switch(w.label){case 0:return e=this.rasterInfo,h=e.storageInfo,d=e.extent,b=e.pixelSize,f=h.maximumPyramidLevel-m+this._levelOffset,g=this.url+"/tile/"+f+"/"+a+"/"+n,[4,this.request({url:g,responseType:"array-buffer"},c.signal)];case 1:return(C=w.sent())?[4,this.decodePixelBlock(C,{width:h.tileInfo.size[0],height:h.tileInfo.size[1],planes:null,pixelType:null,
isPoint:"Elevation"===this.tileType})]:[2,null];case 2:p=w.sent();k=h.blockBoundary[m];if("jpg"!==h.compression||n>k.minCol&&n<k.maxCol&&a>k.minRow&&a<k.maxRow)return[2,p];q=h.origin;B=h.blockWidth;y=h.blockHeight;u=Math.pow(2,m);v=Math.round((d.xmin-q.x)/(b.x*u))%B;z=Math.round((d.xmax-q.x)/(b.x*u))%B;A=Math.round((q.y-d.ymax)/(b.x*u))%y;r=Math.round((q.y-d.ymin)/(b.x*u))%y;l=n===k.minCol?v:0;t=a===k.minRow?A:0;D=n===k.maxCol?z:B;E=a===k.maxRow?r:y;T.setValidBoundary(p,{x:l,y:t},{width:D-l,height:E-
t});return[2,p]}})})};c.prototype._fetchRasterInfo=function(c){return I(this,void 0,void 0,function(){var a,n,m,e,h,d,b,f,g,x,p;return H(this,function(k){a=this.sourceJSON;n=Math.ceil((a.extent.xmax-a.extent.xmin)/a.pixelSizeX-.1);m=Math.ceil((a.extent.ymax-a.extent.ymin)/a.pixelSizeY-.1);e=F.SpatialReference.fromJSON(a.spatialReference||a.extent.spatialReference);if("Map"===this.tileType)return[2,new M({width:n,height:m,bandCount:3,extent:F.Extent.fromJSON(a.extent),spatialReference:e,pixelSize:new F.Point({x:a.pixelSizeX,
y:a.pixelSizeY,spatialReference:e}),pixelType:"u8",statistics:null})];h=c.slice;d=c.signal;b=a.hasRasterAttributeTable?v(this.url+"/rasterAttributeTable",{query:{slice:h,f:"json"},signal:d}).then(function(a){return U.fromJSON(a.data)}).catch(function(){return null}):!1;f=a.hasColormap?v(this.url+"/colormap",{query:{slice:h,f:"json"},signal:d}).then(function(a){return a.data&&a.data.colormap}):!1;g=a.hasHistograms?v(this.url+"/histograms",{query:{slice:h,f:"json"},signal:d}).then(function(a){return a.data&&
a.data.histograms}):!1;x=v(this.url+"/keyProperties",{query:{f:"json"},signal:d}).then(function(a){return a.data}).catch(function(){});p=a.hasMultidimensions?v(this.url+"/multidimensionalInfo",{query:{f:"json"},signal:d}).then(function(a){return a.data&&a.data.multidimensionalInfo}):!1;return[2,P.all([b,f,g,x,p]).then(function(b){var d=null;if(a.minValues&&a.minValues.length===a.bandCount)for(var d=[],c=0;c<a.minValues.length;c++)d.push({min:a.minValues[c],max:a.maxValues[c],avg:a.meanValues[c],stddev:a.stdvValues[c]});
return new M({width:n,height:m,bandCount:a.bandCount,extent:F.Extent.fromJSON(a.extent),spatialReference:e,pixelSize:new F.Point({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:e}),pixelType:a.pixelType.toLowerCase(),statistics:d,attributeTable:b[0]||null,colormap:b[1]||null,histograms:b[2]||null,keyProperties:b[3]||null,multidimensionalInfo:b[4]||null})})]})})};G([x.property({type:String,json:{write:!0}})],c.prototype,"datasetFormat",void 0);G([x.property()],c.prototype,"sourceJSON",void 0);G([x.property()],
c.prototype,"tileType",void 0);return c=G([x.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],c)}(x.declared(S))});