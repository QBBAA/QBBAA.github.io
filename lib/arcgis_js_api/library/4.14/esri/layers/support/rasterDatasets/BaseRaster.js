// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/assignHelper ../../../geometry ../../../request ../../../core/Error ../../../core/JSONSupport ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators ../commonProperties ../TileInfo ./RawBlockCache ../rasterFormats/RasterCodec ../rasterFunctions/pixelUtils ../rasterFunctions/rasterProjectionHelper".split(" "),
function(ca,da,S,w,H,v,J,L,T,M,U,V,W,X,Y,l,Z,aa,P,ba,Q,D){return function(K){function b(){var a=null!==K&&K.apply(this,arguments)||this;a.rasterJobHandler=null;a.datasetName=null;a.datasetFormat=null;a.rasterInfo=null;a.ioConfig={bandIds:null,sampling:"closest"};return a}S(b,K);b.prototype.init=function(){return v(this,void 0,void 0,function(){var a;return H(this,function(c){switch(c.label){case 0:return a=D.load(),this.addResolvingPromise(a),[4,this.when()];case 1:return c.sent(),[2]}})})};b.prototype.normalizeCtorArgs=
function(a){a&&a.ioConfig&&(a=J({},a,{ioConfig:J({resolution:null,bandIds:null,sampling:"closest",tileInfo:aa.create()},a.ioConfig)}));return a};Object.defineProperty(b.prototype,"url",{set:function(a){a=Y.urlToObject(a);this._set("url",a.path)},enumerable:!0,configurable:!0});b.prototype.open=function(a){return v(this,void 0,void 0,function(){return H(this,function(a){throw new M("BaseRaster:open-not-implemented","open() is not implemented");})})};b.prototype.fetchTile=function(a,c,d,f){void 0===
f&&(f={});return v(this,void 0,void 0,function(){var g,h,b,e;return H(this,function(k){g=f.tileInfo;h=g.lodAt(a);b=new L.Point({x:h.resolution,y:h.resolution,spatialReference:g.spatialReference});e=this._getTileExtent(b,c,d,g);return[2,this.fetchPixels(e,g.size[0],g.size[1],f)]})})};b.prototype.identify=function(a,c){void 0===c&&(c={});return v(this,void 0,void 0,function(){var d,f,g,b,R,e,k,q,t,u,x,n,m,I,p,A,r,B,E;return H(this,function(h){switch(h.label){case 0:d=this.rasterInfo;f=d.spatialReference;
g=d.pixelSize;b=d.extent;R=c.datumTransformation;e=this.rasterInfo.storageInfo;k=e.blockWidth;q=e.blockHeight;t=e.origin;u=e.blockBoundary;x=D.projectPoint(a,f,R);if(!b.intersects(x))return[2,{location:a,value:null}];n=u[0];m=Math.max(n.minRow,Math.min(n.maxRow,(t.y-x.y)/g.y/q));I=Math.max(n.minCol,Math.min(n.maxCol,(x.x-t.x)/g.x/k));return[4,this.fetchRawTile(0,Math.floor(m),Math.floor(I),c)];case 1:p=h.sent();if(!(p.pixels&&0<p.pixels.length))return[2,{location:a,value:null}];A=Math.min(q-1,Math.floor((m-
Math.floor(m))*q));r=Math.min(k-1,Math.floor((I-Math.floor(I))*k));B=A*q+r;E=!p.mask||p.mask[B]?p.pixels.map(function(a){return a[B]}):null;return[2,{location:a,value:E}]}})})};b.prototype.fetchPixels=function(a,c,d,b){void 0===b&&(b={});return v(this,void 0,void 0,function(){var g,h,f,e,k,q,t,u,x,n,m,I,p,A,r,B,E,v,C,l,F,G,z;return H(this,function(y){switch(y.label){case 0:g=this.rasterInfo.spatialReference;h=!a.spatialReference.equals(g);f=b.datumTransformation;e=new L.Point({x:(a.xmax-a.xmin)/c,
y:(a.ymax-a.ymin)/d,spatialReference:a.spatialReference});k=b.srcResolution||(h?D.projectResolution(e,g,a,f):e);if(!k)return[2,null];q=this._snapPyramid(k);t=q.pyramidLevel;u=q.pyramidResolution;if(x=q.excessiveReading)return[2,null];n=this.rasterInfo.storageInfo;m=h?D.projectExtent(a,g,f):a;I={x:Math.floor((m.xmin-n.origin.x)/u.x+.1),y:Math.floor((n.origin.y-m.ymax)/u.y+.1)};p=Math.ceil((m.xmax-m.xmin)/u.x-.1);A=Math.ceil((m.ymax-m.ymin)/u.y-.1);return 8<p/c||8<A/d?[2,null]:[4,this.fetchRawPixels(t,
I,{width:p,height:A},b)];case 1:r=y.sent();if(!r)return[2,null];B=0<t?n.pyramidBlockWidth:n.blockWidth;E=0<t?n.pyramidBlockHeight:n.blockHeight;if(v=!h&&1===r.pixelBlocks.length&&B===c&&E===d&&k.x===e.x&&k.y===e.y)return[2,{extent:a,srcExtent:m,pixelBlock:r.pixelBlocks[0],transformGrid:null}];C=D.getProjectionOffsetGrid(a,r.extent,e,f);F=!b.requestRawData;G={rows:C.spacing[0],cols:C.spacing[1]};return this.rasterJobHandler?[4,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:r.pixelBlocks,
srcMosaicSize:r.mosaicSize,destDimension:F?{width:c,height:d}:null,coefs:F?C.coefficients:null,sampleSpacing:F?G:null},b)]:[3,3];case 2:return l=y.sent(),[3,4];case 3:z=Q.mosaic(r.pixelBlocks,r.mosaicSize),l=F?Q.approximateTransform(z,{width:c,height:d},C.coefficients,G):z,y.label=4;case 4:return[2,{srcExtent:m,pixelBlock:l,transformGrid:C,extent:a}]}})})};b.prototype.fetchRawPixels=function(a,c,b,f){return v(this,void 0,void 0,function(){var d,h,l,e,k,q,t,u,x,n,m,v,p,A,r,B,E,w,C,D,F,G,z,y,J,K,N,
O,M;return H(this,function(g){switch(g.label){case 0:d=this.rasterInfo.storageInfo;h=d.origin;l=d.blockBoundary;e=0<a?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth;k=0<a?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight;q=Math.floor(c.x/e);t=Math.floor(c.y/k);u=Math.floor((c.x+b.width-1)/e);x=Math.floor((c.y+b.height-1)/k);n=this.rasterInfo;m=n.pixelSize;v=n.spatialReference;p=l[a];if(!p)return[2,null];A=p.minRow;r=p.minCol;
B=p.maxCol;E=p.maxRow;if(x<A||u<r||t>E||q>B)return[2,null];w=[];C=this.url;D=f.registryId;for(z=t;z<=x;z++)for(y=q;y<=u;y++)z>=A&&y>=r&&E>=z&&B>=y?(F=a+"/"+z+"/"+y,G=P.getBlock(C,D,F),V.isSome(G)||(G=this.fetchRawTile(a,z,y,f),P.putBlock(C,D,F,G)),w.push(G)):w.push(null);return 0===w.length?[2,null]:[4,X.all(w)];case 1:return J=g.sent(),K={height:(x-t+1)*e,width:(u-q+1)*k},N=m.x*Math.pow(2,a),O=m.y*Math.pow(2,a),M=new L.Extent({xmin:h.x+q*e*N,xmax:h.x+(u+1)*e*N,ymin:h.y-(x+1)*k*O,ymax:h.y-t*k*O,spatialReference:v}),
[2,{extent:M,pixelBlocks:J,mosaicSize:K}]}})})};b.prototype.fetchRawTile=function(a,c,b,f){return v(this,void 0,void 0,function(){return H(this,function(a){throw new M("BaseRaster:read-not-implemented","fetchRawTile() is not implemented");})})};b.prototype.decodePixelBlock=function(a,c){return this.rasterJobHandler?this.rasterJobHandler.decode({data:a,options:c}):ba.decode(a,c)};b.prototype.request=function(a,c){return v(this,void 0,void 0,function(){var b,f,g,h,l,e,k;return H(this,function(d){switch(d.label){case 0:b=
this.ioConfig.customFetchParameters,f=a.url,g=a.range,h=a.query,l=a.responseType,null==a.retryCount&&this.ioConfig.retryCount&&(a.retryCount=this.ioConfig.retryCount),e=g?{Range:"bytes\x3d"+g.from+"-"+g.to}:null,d.label=1;case 1:return d.trys.push([1,3,,4]),[4,T(f,{query:J({},h,b),headers:e,responseType:l,signal:c})];case 2:return k=d.sent().data,[2,k];case 3:return d.sent(),0<a.retryCount?(a.retryCount--,[2,this.request(a,c)]):[2,null];case 4:return[2]}})})};b.prototype._getTileExtent=function(a,
c,b,f){var d=f.origin,h=f.size[0],l=f.size[1];b=d.x+b*h*a.x;c=d.y-c*l*a.y;return new L.Extent({xmin:b,xmax:b+h*a.x,ymin:c-l*a.y,ymax:c,spatialReference:f.spatialReference})};b.prototype._snapPyramid=function(a){var b=Math.log(a.x/this.rasterInfo.pixelSize.x)/Math.LN2,d=Math.log(a.y/this.rasterInfo.pixelSize.y)/Math.LN2;a=this.rasterInfo.storageInfo.maximumPyramidLevel||0;b="down"===this.ioConfig.sampling?Math.floor(Math.min(b+.001,d+.001)):"up"===this.ioConfig.sampling?Math.ceil(Math.max(b-.001,d-
.001)):Math.round((b+d)/2);d=!1;0>b?b=0:b>a&&(b=a,d=0===a&&3<b);a=Math.pow(2,b);a=new L.Point({x:a*this.rasterInfo.pixelSize.x,y:a*this.rasterInfo.pixelSize.y,spatialReference:this.rasterInfo.spatialReference});return{pyramidLevel:b,pyramidResolution:a,excessiveReading:d}};w([l.property(Z.url)],b.prototype,"url",null);w([l.property({type:String,json:{write:!0}})],b.prototype,"datasetName",void 0);w([l.property({type:String,json:{write:!0}})],b.prototype,"datasetFormat",void 0);w([l.property()],b.prototype,
"rasterInfo",void 0);w([l.property()],b.prototype,"ioConfig",void 0);return b=w([l.subclass("esri.layers.support.rasterDatasets.BaseRaster")],b)}(l.declared(W.EsriPromiseMixin(U.JSONSupport)))});