// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports @dojo/framework/shim/number ../../core/maybe ../../core/now ../../core/PooledArray ../../core/watchUtils ./debugFlags".split(" "),function(e,g,q,r,t,l,u,v){function m(a){return a in g.taskPriorities?g.taskPriorities[a]:"number"===typeof a?a:1}Object.defineProperty(g,"__esModule",{value:!0});var d;g.newScheduler=function(a){return new k.Scheduler(a)};(function(a){a.REMOTE_CLIENT="remote client";a.STREAM_DATA_LOADER="stream data loader";a.TERRAIN_SURFACE="terrain surface";a.SURFACE_GEOMETRY_UPDATES=
"surface geometry updates";a.I3S_CONTROLLER="I3S controller";a.POINT_CLOUD_LAYER="point cloud";a.FEATURE_TILE_FETCHER="feature fetcher";a.FEATURE_FETCH_QUEUE="feature fetch queue";a.DECONFLICTOR_IMMEDIATE="fast deconflictor";a.DECONFLICTOR_DELAYED="delayed deconflictor";a.GRAPHICS_CORE="Graphics3D";a.FILTER_VISIBILITY="Graphics3D filter visibility";a.FEATURE_QUERY_ENGINE="feature query";a.SCALE_VISIBILITY="Graphics3D scale visibility";a.FRUSTUM_VISIBILITY="Graphics3D frustum visibility";a.POINT_OF_INTEREST_FREQUENT=
"POI frequent";a.POINT_OF_INTEREST_INFREQUENT="POI infrequent";a.LABELER="labeler";a.FEATURE_TILE_TREE="feature tile tree";a.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree";a.ELEVATION_ALIGNMENT="elevation alignment";a.TEXT_TEXTURE_ATLAS="text texture atlas";a.OVERLAY_MANAGER="overlay manager";a.LINE_OF_SIGHT_TOOL="line of sight tool";a[a.TEST_PRIO=1]="TEST_PRIO"})(e=g.Task||(g.Task={}));g.taskPriorities=(d={},d[e.REMOTE_CLIENT]=1,d[e.STREAM_DATA_LOADER]=1,d[e.FEATURE_FETCH_QUEUE]=1,d[e.TERRAIN_SURFACE]=
2,d[e.SURFACE_GEOMETRY_UPDATES]=2,d[e.I3S_CONTROLLER]=4,d[e.POINT_CLOUD_LAYER]=4,d[e.FEATURE_TILE_FETCHER]=4,d[e.DECONFLICTOR_IMMEDIATE]=4,d[e.DECONFLICTOR_DELAYED]=16,d[e.GRAPHICS_CORE]=6,d[e.FILTER_VISIBILITY]=8,d[e.FEATURE_QUERY_ENGINE]=8,d[e.SCALE_VISIBILITY]=8,d[e.FRUSTUM_VISIBILITY]=8,d[e.POINT_OF_INTEREST_FREQUENT]=6,d[e.POINT_OF_INTEREST_INFREQUENT]=30,d[e.LABELER]=12,d[e.FEATURE_TILE_TREE]=16,d[e.FEATURE_TILE_TREE_ACTIVE]=1,d[e.ELEVATION_ALIGNMENT]=12,d[e.TEXT_TEXTURE_ATLAS]=12,d[e.OVERLAY_MANAGER]=
12,d[e.LINE_OF_SIGHT_TOOL]=16,d);g.getTaskPriority=m;var w=1E3/30,k;(function(a){var d=function(){function c(b){var f=this;this._now=b;this._budget=null;this._state=1;this._tasks=new l;this._runQueue=new l;this._load=0;this._idleStateCallbacks=new l;this._idleUpdatesStartFired=!1;this._maxReschedule=n;this._forceTask=!1;this._safetyBudget=0;this._debug=!1;this._debugHandle=u.init(v,"SCHEDULER_LOG_SLOW_TASKS",function(b){return f._debug=b});this._budget=new a.Budget(b);var c=this;this._test={state:void 0,
FRAME_SAFETY_BUDGET:5,idleBudget:100,get budget(){return c._budget.budget},usedBudget:0,startTime:0,updateTask:function(b){return f._updateTask(b)},getState:function(b){return f._getState(b)},getRuntime:function(b){return f._getRuntime(b)}}}c.prototype.destroy=function(){this._debugHandle&&this._debugHandle.remove()};c.prototype.registerTask=function(b,a,c){var f=this,d=m(b),p=new e(b,a,c,d);this._tasks.push(p);return{remove:function(){return f._removeTask(p)},set task(b){p.setPriority(b)}}};c.prototype.registerIdleStateCallbacks=
function(b,a){var c=this,f={idleBegin:b,idleEnd:a};this._idleStateCallbacks.push(f);2===this.state&&this._idleUpdatesStartFired&&f.idleBegin();var d=this;return{remove:function(){return c._removeIdleStateCallbacks(f)},set idleBegin(b){d._idleUpdatesStartFired&&(f.idleEnd(),2===d._state&&b());f.idleBegin=b},set idleEnd(b){f.idleEnd=b}}};Object.defineProperty(c.prototype,"now",{get:function(){return this._now()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"load",{get:function(){return this._load},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"state",{get:function(){return r.isNone(this._test.state)?this._state:this._test.state},set:function(b){this._state!==b&&(this._state=b,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forEach(function(b){return b.idleEnd()})))},enumerable:!0,configurable:!0});c.prototype.updateBudget=function(b){this._test.usedBudget=0;this._test.startTime=b.elapsedFrameTime;this._safetyBudget=5;
var a=b.frameDuration,c=1;switch(this.state){case 2:this._safetyBudget=0;a=Math.max(100,b.frameDuration);c=30;break;case 1:a=Math.max(w,b.frameDuration)}a-=b.elapsedFrameTime+this._safetyBudget;b=2===this.state;if(!b&&0>a&&!this._forceTask)return this._forceTask=!0,!1;a=Math.max(a,c);this._budget.reset(a,b);this._maxReschedule=n;this._updateLoad();return this._schedule()};c.prototype.frame=function(){this._forceTask=!1;switch(this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=
!0,this._idleStateCallbacks.forEach(function(b){return b.idleBegin()}));this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed};c.prototype._removeIdleStateCallbacks=function(b){this._idleUpdatesStartFired&&b.idleEnd();this._idleStateCallbacks.removeUnordered(b)};c.prototype._removeTask=function(b){this._tasks.removeUnordered(b);this._runQueue.removeUnordered(b)};c.prototype._updateTask=function(b){this._tasks.forEach(function(a){a.name===
b&&a.setPriority(b)})};c.prototype._getState=function(b){if(this._runQueue.some(function(a){return a.name===b}))return h.SCHEDULED;var a=h.IDLE;this._tasks.forEach(function(c){c.name===b&&c.needsUpdate()&&(1>=c.schedule?a=h.READY:a!==h.READY&&(a=h.WAITING))});return a};c.prototype._getRuntime=function(b){var a=0;this._tasks.forEach(function(c){c.name===b&&(a+=c.runtime)});return a};c.prototype._runIdle=function(){this._run()};c.prototype._runInteracting=function(){this._run()};c.prototype._runAnimating=
function(){this._run()};c.prototype._updateLoad=function(){var b=0;this._tasks.forEach(function(a){return a.needsUpdate()?++b:b});this._load=.9*this._load+b*(1-.9)};c.prototype._schedule=function(){var b=this;if(0>=this._maxReschedule)return!1;this._runQueue.filterInPlace(function(b){if(b.needsUpdate())return!0;b.schedule=b.priority;return!1});for(var a=function(){var a=!1,d=0;c._tasks.forEach(function(c){if(c.needsUpdate())switch(a=!0,d=Math.max(d,c.priority),c.schedule){case 0:break;case 1:c.schedule=
0;b._runQueue.push(c);break;default:--c.schedule}});if(!a)return{value:!1};c._maxReschedule===n&&(c._maxReschedule=d);--c._maxReschedule},c=this;0===this._runQueue.length;){var d=a();if("object"===typeof d)return d.value}return!0};c.prototype._run=function(){do for(;0<this._runQueue.length;){var b=this._runQueue.pop();this._budget.resetProgress();var a=this._budget.now();b.update(this._budget);b.schedule=b.priority;b.runtime+=this._budget.now()-a;this._debug&&this._budget.elapsed>2*this._budget.budget&&
console.log("Task",b.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms");if(0>=this._budget.remaining)return}while(this._schedule())};Object.defineProperty(c.prototype,"test",{get:function(){return this._test},enumerable:!0,configurable:!0});return c}();a.Scheduler=d;var e=function(){function a(a,c,d,e){this.name=a;this.update=c;this.needsUpdate=d;this._priority=e;this.runtime=0;this.schedule=this._priority}Object.defineProperty(a.prototype,"priority",{get:function(){return this._priority},
enumerable:!0,configurable:!0});a.prototype.setPriority=function(a){var b=m(a);this.name=a;this._priority=b;0!==this.schedule&&(this.schedule=b)};return a}(),d=function(){function a(a){this.now=a;this._budget=this._begin=0;this._didWork=this._idle=!1;this._enabled=!0}a.prototype.run=function(a){if(this.done)return!1;!0===a()&&(this._didWork=!0);return!0};Object.defineProperty(a.prototype,"done",{get:function(){return this._didWork&&this.elapsed>=this._budget&&this._enabled},enumerable:!0,configurable:!0});
Object.defineProperty(a.prototype,"budget",{get:function(){return this._budget},enumerable:!0,configurable:!0});a.prototype.madeProgress=function(){this._didWork=!0};Object.defineProperty(a.prototype,"idleFrame",{get:function(){return this._idle},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=a},enumerable:!0,configurable:!0});a.prototype.reset=function(a,c){this._begin=this.now();this._budget=a;this._idle=
c;this._didWork=!1};Object.defineProperty(a.prototype,"remaining",{get:function(){return Math.max(this._budget-this.elapsed,0)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"elapsed",{get:function(){return this.now()-this._begin},enumerable:!0,configurable:!0});a.prototype.resetProgress=function(){this._didWork=!1};Object.defineProperty(a.prototype,"hasProgressed",{get:function(){return this._didWork},enumerable:!0,configurable:!0});return a}();a.Budget=d})(k||(k={}));var h;(function(a){a.SCHEDULED=
"s";a.READY="r";a.WAITING="w";a.IDLE="i"})(h=g.TaskState||(g.TaskState={}));g.noBudget=function(){var a=new k.Budget(t);a.enabled=!1;return a}();var n=q.MAX_SAFE_INTEGER});