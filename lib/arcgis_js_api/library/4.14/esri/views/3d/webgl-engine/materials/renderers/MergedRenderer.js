// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/iteratorUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../support/buffer/glUtil ../../lib/DefaultVertexAttributeLocations ../../lib/IntervalUtilities ../../lib/ResizableFloat32Array ../../lib/Util ../WaterGLMaterial ./Instance ./utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(t,M,z,w,r,A,B,x,C,v,D,E,m,F,G,H){function I(c,a,b,e){for(var l=
new Map,d=a.vertexBufferLayout.stride/4,n=function(b,e){var g=b.origin,f=c.get(g.id),k=l.get(g.id);null==k&&(k={optimalCount:null==f?0:f.optimalCount,sparseCount:null==f?0:f.buffer.size,toAdd:[],toRemove:[],origin:g.vec3},l.set(g.id,k));g=a.elementCount(b.data)*d;e?(k.optimalCount+=g,k.sparseCount+=g,k.toAdd.push(b)):(k.optimalCount-=g,k.toRemove.push(b))},h=0;h<b.length;h++){var f=b[h];n(f,!0)}for(b=0;b<e.length;b++)f=e[b],n(f,!1);return l}t=function(){function c(a,b,e,l){void 0===l&&(l=B.Default3D);
this.type="MergedRenderer";this._dataByOrigin=new Map;this._highlightCount=0;this._rctx=a;this._vertexAttributeLocations=l;this._material=e;this._materialRep=b;this._glMaterials=m.acquireMaterials(this._material,this._materialRep);this._bufferWriter=e.createBufferWriter()}c.prototype.dispose=function(){m.releaseMaterials(this._material,this._materialRep)};Object.defineProperty(c.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"hasHighlights",{get:function(){return 0<this._highlightCount},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasWater",{get:function(){return z.someMap(this._glMaterials,function(a){return a instanceof D.WaterGLMaterial})},enumerable:!0,configurable:!0});c.prototype.renderPriority=function(){return this._material.renderPriority};c.prototype.modify=function(a){var b=this,e=J;e.clear();this.updateGeometries(a.toUpdate,e);this.addAndRemoveGeometries(a.toAdd,a.toRemove,e);this.updateHighlightCount();
e.forEach(function(a){return b.updateDisplayedIndexRanges(a)})};c.prototype.addAndRemoveGeometries=function(a,b,e){var l=this,d=this._bufferWriter,n=d.vertexBufferLayout,h=n.stride/4,f=this._dataByOrigin,g=I(f,d,a,b);g.forEach(function(a,b){g.delete(b);var d=a.optimalCount,k=a.sparseCount,c=f.get(b);null==c&&(v.assert(0<d),c=l.createData(n,d,a.origin),f.set(b,c));if(0===d)c.vao.dispose(!0),c.vao=null,f.delete(b);else{var y=d<a.sparseCount/2;b=K;var m=c.buffer.size,p=c.buffer.array,d=c.buffer.resize(y?
d:k,!1);y||d?l.removeAndRebuild(c,a.toRemove,h,p,b):0<a.toRemove.length?(l.removeByErasing(c,a.toRemove,h,b),0<a.toAdd.length&&(b.end=m)):(b.begin=m,b.end=m);d=L;v.setMatrixTranslation3(d,-a.origin[0],-a.origin[1],-a.origin[2]);l.append(c,a.toAdd,h,d,b);a=c.vao.vertexBuffers.geometry;a.byteSize!==c.buffer.array.buffer.byteLength?a.setData(c.buffer.array):(k=b.begin,d=b.end,k<d&&(k*=4,a.setSubData(c.buffer.array,k,k,4*d)));(b.updatedDisplayedIndexRange||c.displayedIndexRanges)&&e.add(c)}})};c.prototype.updateGeometries=
function(a,b){for(var e=this._bufferWriter,c=e.vertexBufferLayout.stride/4,d=0;d<a.length;d++){var n=a[d],h=n.updateType,n=n.renderGeometry,f=this._dataByOrigin.get(n.origin.id),g=f&&f.instances.get(n.uniqueName);if(!g)break;h&1&&(g.displayedIndexRange=m.generateRenderGeometryVisibleIndexRanges(n),b.add(f));h&17&&(g.highlightedIndexRanges=m.generateRenderGeometryHighlightRanges(n),f.highlightCount=null);h&6&&(h=f.buffer.array,f=f.vao,m.calculateTransformRelToOrigin(n,u,p),e.write({transformation:u,
invTranspTransformation:p},n.data,e.vertexBufferLayout.createView(h.buffer),g.from),v.assert(g.from+e.elementCount(n.data)===g.to,"material VBO layout has changed"),f.vertexBuffers.geometry.setSubData(h,g.from*c*4,g.from*c*4,g.to*c*4))}};c.prototype.updateDisplayedIndexRanges=function(a){a.displayedIndexRanges=[];var b=!0;a.instances.forEach(function(e){e.displayedIndexRange?(a.displayedIndexRanges.push.apply(a.displayedIndexRanges,x.offsetIntervals(e.displayedIndexRange,e.from)),b=!1):a.displayedIndexRanges.push([e.from,
e.to-1])});a.displayedIndexRanges=b?null:x.mergeIntervals(a.displayedIndexRanges)};c.prototype.updateHighlightCount=function(){var a=this;this._highlightCount=0;this._dataByOrigin.forEach(function(b){if(null==b.highlightCount){var e=0;b.instances.forEach(function(a){a.highlightedIndexRanges&&++e});b.highlightCount=e}a._highlightCount+=b.highlightCount})};c.prototype.updateLogic=function(a){return this._material.update(a)};c.prototype.render=function(a,b,e,c){var d=this,n=this._rctx,h=this._glMaterials.get(b.pass),
f=4===b.pass;2===b.pass&&null===a&&(a=19);if(!h||1===h.ensureResources(n)||null!=a&&!h.beginSlot(a)||f&&0===this._highlightCount)return!1;h.bind(n,e);b=h.getTechnique().program;b.setUniformMatrix4fv("model",r.mat4f64.IDENTITY);b.hasUniform("modelNormal")&&b.setUniformMatrix4fv("modelNormal",r.mat4f64.IDENTITY);var g=!1;this._dataByOrigin.forEach(function(a){f&&0===a.highlightCount||(e.origin=a.origin,h.bindView(e),g=f?d.renderHighlightPass(h,a,c)||g:d.renderDefaultPass(h,a,c)||g)});return g};c.prototype.renderDefaultPass=
function(a,b,e){var c=this._rctx,d=b.displayedIndexRanges;if(d&&0===d.length)return!1;a=a.getTechnique();a.ensureAttributeLocations(b.vao);c.bindVAO(b.vao);d?m.drawArraysFaceRange(c,d,0,a.primitiveType,e):(b=4*b.buffer.size/G.getStride(b.vao.layout.geometry),m.drawArrays(c,a.primitiveType,0,b,e));return!0};c.prototype.renderHighlightPass=function(a,b,e){var c=this._rctx,d=b.vao,n=a.getTechnique();n.ensureAttributeLocations(d);c.bindVAO(d);var h=!1;b.instances.forEach(function(a){var b=a.highlightedIndexRanges;
if(b&&0!==b.length)for(var d=0;d<b.length;d++){var f=b[d];m.drawArrays(c,n.primitiveType,f.range?f.range[0]+a.from:a.from,f.range?f.range[1]-f.range[0]+1:a.to-a.from,e);h=!0}});return h};c.prototype.createData=function(a,b,c){return{instances:new Map,vao:new H(this._rctx,this._vertexAttributeLocations,{geometry:A.glLayout(a)},{geometry:F.createVertex(this._rctx,35044)}),buffer:new C.ResizableFloat32Array(b),optimalCount:0,origin:c,highlightCount:0}};c.prototype.removeAndRebuild=function(a,b,c,l,d){for(var e=
0;e<b.length;e++){var h=b[e].uniqueName,f=a.instances.get(h);a.optimalCount-=(f.to-f.from)*c;a.instances.delete(h)}var g=0,k=a.buffer.array;d.begin=0;d.end=0;var m=-1,q=-1,p=0;a.instances.forEach(function(a){var b=a.from*c,d=a.to*c,e=d-b;m!==q&&q!==b?(k.set(l.subarray(m,q),p),p+=q-m,m=b):-1===m&&(m=b);q=d;a.from=g/c;g+=e;a.to=g/c});m!==q&&k.set(l.subarray(m,q),p);d.end=g};c.prototype.removeByErasing=function(a,b,c,l){l.begin=Infinity;l.end=-Infinity;for(var d=-1,e=-1,h=0;h<b.length;h++){var f=b[h].uniqueName,
g=a.instances.get(f),k=g.from*c,g=g.to*c;d!==e&&e!==k?(a.buffer.erase(d,e),d=k):-1===d&&(d=k);e=g;a.instances.delete(f);a.optimalCount-=g-k;k<l.begin&&(l.begin=k);g>l.end&&(l.end=g)}d!==e&&a.buffer.erase(d,e)};c.prototype.append=function(a,b,c,l,d){d.updatedDisplayedIndexRange=!1;for(var e=this._bufferWriter,h=0;h<b.length;h++){var f=b[h],g=f.data;w.mat4.multiply(u,l,f.transformation);w.mat4.invert(p,u);w.mat4.transpose(p,p);var k=d.end;e.write({transformation:u,invTranspTransformation:p},g,e.vertexBufferLayout.createView(a.buffer.array.buffer),
d.end/c);var g=e.elementCount(g)*c,r=k+g;v.assert(null==a.instances.get(f.uniqueName));var q=m.generateRenderGeometryVisibleIndexRanges(f),t=m.generateRenderGeometryHighlightRanges(f);t&&(a.highlightCount=null);k=new E(f.name,k/c,r/c,q,t,void 0,void 0,f.idx);a.instances.set(f.uniqueName,k);q&&(d.updatedDisplayedIndexRange=!0);a.optimalCount+=g;d.end+=g}};Object.defineProperty(c.prototype,"test",{get:function(){return{material:this._material}},enumerable:!0,configurable:!0});return c}();var K={updatedDisplayedIndexRange:!1,
begin:0,end:0},L=r.mat4f64.create(),u=r.mat4f64.create(),p=r.mat4f64.create(),J=new Set;return t});