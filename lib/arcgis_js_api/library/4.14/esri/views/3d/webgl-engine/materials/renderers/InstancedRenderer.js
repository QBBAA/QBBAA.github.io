// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../support/buffer/glUtil ../../lib/DefaultVertexAttributeLocations ./Instance ./utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(A,B,r,t,u,v,h,w,x,y){function z(a,b){var d=new Map,e=function(c,b){var e=c.origin.id,g=c.data.id,f=d.get(e);f||(f={origin:c.origin.vec3,deltaByGeometry:new Map},d.set(e,f));e=f.deltaByGeometry.get(g);e||(e={renderData:c.data,toAdd:[],
toRemove:[]},f.deltaByGeometry.set(g,e));(b?e.toAdd:e.toRemove).push(c)};a.forEach(function(c){e(c,!0)});b.forEach(function(c){e(c,!1)});return d}function q(a,b,d){var e=b.elementCount(a),e=b.allocate(e);b.write({},a,e,0);d.setData(e.buffer)}return function(){function a(b,d,e,c){void 0===c&&(c=u.Default3D);this.type="InstancedRenderer";this._dataByOrigin=new Map;this._highlightCount=0;this._rctx=b;this._vertexAttributeLocations=c;this._material=e;this._materialRep=d;this._glMaterials=h.acquireMaterials(this._material,
this._materialRep);this._bufferWriter=e.createBufferWriter()}a.prototype.dispose=function(){h.releaseMaterials(this._material,this._materialRep)};Object.defineProperty(a.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"hasHighlights",{get:function(){return 0<this._highlightCount},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"hasWater",{get:function(){return!1},enumerable:!0,configurable:!0});
a.prototype.renderPriority=function(){return this._material.renderPriority};a.prototype.modify=function(b){this.updateGeometries(b.toUpdate);this.addAndRemoveGeometries(b.toAdd,b.toRemove);this.updateHighlightCount()};a.prototype.addAndRemoveGeometries=function(b,d){var e=this,c=this._rctx,p=this._bufferWriter,a=this._dataByOrigin;b=z(b,d);var g=p.vertexBufferLayout;b.forEach(function(b,d){var k=a.get(d);k||(k={origin:b.origin,highlightCount:0,dataByGeometry:new Map},a.set(d,k));b.deltaByGeometry.forEach(function(b,
d){var a=k.dataByGeometry.get(d);!a&&0<b.toAdd.length&&(a={vao:new y(c,e._vertexAttributeLocations,{geometry:t.glLayout(g)},{geometry:w.createVertex(c,35044)}),vertexCount:0,instances:new Map,highlightCount:0},q(b.renderData,p,a.vao.vertexBuffers.geometry),a.vertexCount=x.vertexCount(a.vao,"geometry"),k.dataByGeometry.set(d,a));var f=a.instances;b.toAdd.forEach(function(c){var b=r.mat4f64.create();h.calculateTransformRelToOrigin(c,b);var d=h.generateRenderGeometryVisibleIndexRanges(c),e=h.generateRenderGeometryHighlightRanges(c),
b=new v(c.name,0,a.vertexCount,d,e,b,c.instanceParameters,c.idx,c.data.id);f.set(c.uniqueName,b);k.highlightCount=null;a.highlightCount=null});b.toRemove.forEach(function(c){f.delete(c.uniqueName)});0===f.size&&(a.vao.dispose(),k.dataByGeometry.delete(d))});0===k.dataByGeometry.size&&a.delete(d)})};a.prototype.updateGeometries=function(b){var d=this._dataByOrigin,e=this._bufferWriter;b.forEach(function(c){var b=c.updateType;c=c.renderGeometry;var a=d.get(c.origin.id),g=a&&a.dataByGeometry.get(c.data.id),
f=g&&g.instances.get(c.uniqueName);f&&(b&1&&(f.displayedIndexRange=h.generateRenderGeometryVisibleIndexRanges(c)),b&17&&(f.highlightedIndexRanges=h.generateRenderGeometryHighlightRanges(c),a.highlightCount=null,g.highlightCount=null),b&2&&q(c.data,e,g.vao.vertexBuffers.geometry),b&4&&h.calculateTransformRelToOrigin(c,f.transformation,f.transformationNormal))})};a.prototype.updateHighlightCount=function(){var b=this;this._highlightCount=0;this._dataByOrigin.forEach(function(d){if(null==d.highlightCount){var a=
0;d.dataByGeometry.forEach(function(c){if(null==c.highlightCount){var b=0;c.instances.forEach(function(c){c.highlightedIndexRanges&&++b});c.highlightCount=b}a+=c.highlightCount});d.highlightCount=a}b._highlightCount+=d.highlightCount})};a.prototype.render=function(b,a,e,c){var d=this,h=this._rctx,g=this._glMaterials.get(a.pass),f=4===a.pass;if(!g||null!=b&&!g.beginSlot(b)||f&&0===this._highlightCount)return!1;g.bind(h,e);var m=!1;this._dataByOrigin.forEach(function(b){f&&0===b.highlightCount||(e.origin=
b.origin,g.bindView(e),b.dataByGeometry.forEach(function(b){m=f?d.renderHighlightPass(g,b,c)||m:d.renderDefaultPass(g,b,c)||m}))});h.bindVAO(null);return m};a.prototype.renderDefaultPass=function(b,a,e){var c=this._rctx,d=a.vao,n=a.vertexCount,g=b.getTechnique();g.ensureAttributeLocations(d);c.bindVAO(d);var f=!1;a.instances.forEach(function(a){var d=a.displayedIndexRange;d&&0===d.length||(b.bindInstance(a),d?h.drawArraysFaceRange(c,d,0,g.primitiveType,e):h.drawArrays(c,g.primitiveType,0,n,e),f=!0)});
return f};a.prototype.renderHighlightPass=function(b,a,e){var c=this._rctx,d=a.vao,n=a.vertexCount,g=b.getTechnique();if(0!==a.highlightCount){g.ensureAttributeLocations(d);c.bindVAO(d);var f=!1;a.instances.forEach(function(a){var d=a.highlightedIndexRanges;if(d&&0!==d.length)for(b.bindInstance(a),a=0;a<d.length;a++){var l=d[a];h.drawArrays(c,g.primitiveType,l.range?l.range[0]:0,l.range?l.range[1]-l.range[0]+1:n,e);f=!0}});return f}};return a}()});