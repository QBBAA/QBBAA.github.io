// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/arrayUtils","../../../../core/iteratorUtils","./Util"],function(w,x,u,v,q){return function(){function e(a){this._residentGeomRecords=new Map;this._dirtyGeomRecords=new Map;this._model=a}Object.defineProperty(e.prototype,"residentLayerCount",{get:function(){return this._residentGeomRecords.size},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"residentObjectCount",{get:function(){var a=0;this._residentGeomRecords.forEach(function(b){a+=
b.size});return a},enumerable:!0,configurable:!0});e.prototype.hasDirtyGeometryRecords=function(){return v.someMap(this._dirtyGeomRecords,function(a){return v.someMap(a,function(a){return a&&0<a.size})})};e.prototype.handleUpdate=function(a,b,c){q.assert(this[b],"ModelDirtySet doesn't know how to process "+b);return this[b](a,c)};e.prototype.shaderTransformationChanged=function(a){var b=this;(a=this._residentGeomRecords.get(a.id))&&a.forEach(function(a,d){(d=b._model.get(1,d))&&d.hasVolativeTransformation()&&
a.forEach(function(a){var b=0;for(a=a[1];b<a.length;b++)a[b].shaderTransformationChanged()})})};e.prototype.commit=function(){return this.commitLayers(u.keysOfMap(this._dirtyGeomRecords))};e.prototype.commitLayers=function(a){for(var b=this,c=[],d=[],e=[],h=function(h){var g=a[h];h=k._dirtyGeomRecords.get(g);if(!h)return"continue";h.forEach(function(a,h){var f=b._ensureGeomRecord(g,h);a.forEach(function(a,g){var k=a[0],n=a[1];a=a[2];var m=!1;if(n&2){var l=f.get(g);if(l){l=l[1];if(a&4)for(var p=b._model.get(1,
h),r=0;r<l.length;r++){var t=l[r];if(b._model.updateRenderGeometryTransformation(p,k,t)){m=!0;break}}if(!m)for(p=0;p<l.length;p++)t=l[p],e.push({renderGeometry:t,updateType:a})}else q.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(n&4||m)(l=f.get(g))?d.push.apply(d,l[1]):4===n&&q.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove"),l&&f.delete(g);if(n&1||m)n=[k,[]],p=b._model.get(1,h),b._model.getGeometryRenderGeometries(p,k,n[1]),c.push.apply(c,
n[1]),f.set(g,n)});0===f.size&&b._residentGeomRecords.get(g).delete(h)});0===k._residentGeomRecords.get(g).size&&k._residentGeomRecords.delete(g);k._dirtyGeomRecords.delete(g)},k=this,f=0;f<a.length;f++)h(f);return[c,d,e]};e.prototype.getResidentRenderGeometries=function(){return this.getResidentRenderGeometriesFilteredByLayers(u.keysOfMap(this._residentGeomRecords))};e.prototype.getResidentRenderGeometriesFilteredByLayers=function(a){for(var b=[],c=0;c<a.length;c++){var d=this._residentGeomRecords.get(a[c]);
d&&d.forEach(function(a){a.forEach(function(a){b.push.apply(b,a[1])})})}return b};e.prototype.visibilityChanged=function(a,b,c){if(null!=b)this._componentPropertyChanged(a,b,c,1);else{b=0;for(var d=a.geometryRecords;b<d.length;b++)this._componentPropertyChanged(a,d[b],c,1)}};e.prototype.componentHighlightChanged=function(a,b,c){if(null!=b)this._componentPropertyChanged(a,b,c,16);else{b=0;for(var d=a.geometryRecords;b<d.length;b++)this._componentPropertyChanged(a,d[b],c,16)}};e.prototype.vertexAttrsUpdated=
function(a,b,c){this._updateOrCreateDirtyRecord(a,b,c,2,0,0,2,5,2)};e.prototype.layerAdded=function(a){for(var b=a.getObjects(),c=0;c<b.length;c++)this.layerObjectAdded(a,b[c])};e.prototype.layerRemoved=function(a){for(var b=a.getObjects(),c=0;c<b.length;c++)this.layerObjectRemoved(a,b[c])};e.prototype.layerObjectAdded=function(a,b){a=a.id;for(var c=b.geometryRecords,d=0;d<c.length;d++)this.objGeometryAdded(b,c[d],a)};e.prototype.layerObjectRemoved=function(a,b){a=a.id;for(var c=b.geometryRecords,
d=0;d<c.length;d++)this.objGeometryRemoved(b,c[d],a)};e.prototype.layObjectReplaced=function(a,b){this.layerObjectRemoved(a,b[0]);this.layerObjectAdded(a,b[1])};e.prototype.objTransformation=function(a,b){var c=this;b=b||this._getParentLayerId(a);this._ensureGeomRecord(b,a.id).forEach(function(d){c._updateOrCreateDirtyRecord(a,d[0],b,2,0,0,2,5,4)})};e.prototype.objGeometryAdded=function(a,b,c){this._updateOrCreateDirtyRecord(a,b,c,1,4,0,0,0)};e.prototype.objGeometryRemoved=function(a,b,c){this._updateOrCreateDirtyRecord(a,
b,c,4,1,2,0,0)};e.prototype.objGeometryReplaced=function(a,b){this.objGeometryRemoved(a,b[0]);this.objGeometryAdded(a,b[1])};e.prototype.objGeometryTransformation=function(a,b){this.objGeometryReplaced(a,b)};e.prototype._componentPropertyChanged=function(a,b,c,d){this._updateOrCreateDirtyRecord(a,b,c,2,0,0,2,5,d)};e.prototype._updateOrCreateDirtyRecord=function(a,b,c,d,e,h,k,f,m){c=c||this._getParentLayerId(a);var g=b.id;a=this._ensureDirtyRecord(c,a.id);(c=a.get(g))?(b=c[1],b&e?a.delete(g):b&h?(c[1]=
d,c[2]=m):b&k?c[2]|=m:b&f||q.assert(!1,"ModelDirtySet.objGeometryAdded: inconsistent state")):a.set(g,[b,d,m])};e.prototype._ensureGeomRecord=function(a,b){var c=this._residentGeomRecords.get(a);c||(c=new Map,this._residentGeomRecords.set(a,c));a=c.get(b);a||(a=new Map,c.set(b,a));return a};e.prototype._ensureDirtyRecord=function(a,b){var c=this._dirtyGeomRecords.get(a);c||(c=new Map,this._dirtyGeomRecords.set(a,c));a=c.get(b);a||(a=new Map,c.set(b,a));return a};e.prototype._getParentLayerId=function(a){return a.parentLayer.id};
e.prototype.formatDebugInfo=function(a){if(a)return"";var b=["ADD","UPD",void 0,"REM"],c="";this._dirtyGeomRecords.forEach(function(a,e){a.forEach(function(a,d){0<c.length&&(c+="\n");c+=e+"."+d;var f=[];a.forEach(function(a){var b=a[1];f[b]||(f[b]=[]);f[b].push(a[0].geometry.id)});for(a=0;a<f.length;a++)if(f[a])for(c+=" "+b[a-1]+": ",d=0;d<f[a].length;d++)c+=f[a][d]+", "})});return c};return e}()});