// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4f64 ../../../../../geometry/support/aaBoundingBox ../../../support/debugFlags ../../../support/buffer/glUtil ../Camera ../DefaultVertexAttributeLocations ../intersectorUtils ../Util ./InstanceData ./InstanceOctree ./LevelSelector ./RenderInstanceData ../../materials/DefaultMaterial ../../materials/internal/MaterialUtil ../../materials/renderers/utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),
function(z,p,X,N,t,u,O,v,A,B,P,x,Q,w,k,R,S,C,T,U,y,V,D,W){function E(b,a,c,e){y.encodeDoubleVec3(b.modelOrigin,a,c.modelOriginHi,c.modelOriginLo,e);c.model.copyFrom(e,b.model,a);c.modelNormal.copyFrom(e,b.modelNormal,a);b.color&&c.color&&c.color.copyFrom(e,b.color,a);b.featureAttribute&&c.featureAttribute&&c.featureAttribute.copyFrom(e,b.featureAttribute,a)}Object.defineProperty(p,"__esModule",{value:!0});var F=function(b){var a=b.baseBoundingSphere.radius;b=b.levels.map(function(a){return a.minScreenSpaceRadius});
return new S.LevelSelector(a,b)};p.setLevelSelectorFactory=function(b){F=b};var G=function(){function b(a,c){var e=a.rctx,b=c.geometry;c=c.material;var g=b.data.toRenderData();this.materialRep=a.materialRep;c.setParameterValues({instancedDoublePrecision:!0});a=c.createBufferWriter();var h=a.vertexBufferLayout,d=a.elementCount(g),q=a.allocate(d);a.write({},g,q,0);this.geometry=b;this.material=c;this.glMaterials=y.acquireMaterials(c,this.materialRep);this.vertexBufferLayout=h;this.vbo=V.createVertex(e,
35044,q.buffer);this.vao=new W(e,x.Default3D,{geometry:B.glLayout(h)},{geometry:this.vbo});this.vertexCount=d}b.prototype.destroy=function(){y.releaseMaterials(this.material,this.materialRep);this.vbo.dispose();this.vao.dispose()};Object.defineProperty(b.prototype,"boundingInfo",{get:function(){return this.geometry.boundingInfo},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"triangleCount",{get:function(){return this.vertexCount/3},enumerable:!0,configurable:!0});b.prototype.intersect=
function(a,c,e,b,g,h){var d=this.geometry.id,f=g.toString();this.material.intersect(this.geometry,null,a.transform.transform,a,e,b,function(b,e,k,q){if(0<=b&&(null==c||c(a.rayBeginPoint,a.rayEndPoint,b))){var l={type:"external",metadata:{layerUid:h.layerUid,graphicUid:h.graphicUid(g)}};if(null==a.results.min.drapedLayerOrder||q>=a.results.min.drapedLayerOrder)if(null==a.results.min.dist||b<a.results.min.dist)a.results.min.set(l,f,b,e,a.transform.transform,q,null,d,k),a.results.min.intersector="LodRenderer";
0!==a.options.store&&(null==a.results.max.drapedLayerOrder||q>=a.results.max.drapedLayerOrder)&&(null==a.results.max.dist||b>a.results.max.dist)&&(a.results.max.set(l,f,b,e,a.transform.transform,q,null,d,k),a.results.min.intersector="LodRenderer");if(2===a.options.store){var m=new Q.IntersectorResult(a.results.min.ray);m.set(l,f,b,e,a.transform.transform,q,null,d,k);m.intersector="LodRenderer";a.results.all.push(m)}}})};return b}();p.LodComponentData=G;var H=function(){function b(a,c){var b=this;
this.components=[];this.minScreenSpaceRadius=c.minScreenSpaceRadius;c.components.forEach(function(c){b.components.push(new G(a,c))})}b.prototype.destroy=function(){this.components.forEach(function(a){a.destroy()})};b.prototype.intersect=function(a,c,b,f,g,h){this.components.forEach(function(e){e.intersect(a,c,b,f,g,h)})};Object.defineProperty(b.prototype,"boundingBox",{get:function(){if(!this._boundingBox){var a=v.empty();this.components.forEach(function(c){v.expand(a,c.boundingInfo.bbMin);v.expand(a,
c.boundingInfo.bbMax)});this._boundingBox=a}return this._boundingBox},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"boundingSphere",{get:function(){if(!this._boundingSphere){var a=this.boundingBox,c=u.vec3f64.create();v.center(a,c);this._boundingSphere={center:c,radius:.5*v.diameter(a)}}return this._boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"triangleCount",{get:function(){return this.components.reduce(function(a,c){return a+c.triangleCount},
0)},enumerable:!0,configurable:!0});return b}();p.LodLevelData=H;z=function(){function b(a,c,b,f){var e=this;this.type="Lod";this._levels=[];this._renderInstanceData=[];this._highlightRenderInstanceData=[];this._instanceIndex=0;this._slicePlane=!1;this._enableLevelSelection=!0;this._lastCamera=new P.default;this._updateCyclesWithStaticCamera=-1;this._needFullCycle=!1;this.canRender=!0;this._symbol=a;this._optionalFields=c;this._metadata=b;this._instanceBufferLayout=T.getInstanceBufferLayout({instancedDoublePrecision:!0,
instanced:c});this._glInstanceBufferLayout=B.glLayout(this._instanceBufferLayout,{divisor:1});this._instanceData=new k.InstanceData(this._optionalFields,f);this._instanceData.on("instance-added",function(){e.requestUpdateCycle()});this._instanceData.on("instance-removed",function(){e.requestUpdateCycle()});this._instanceData.on("instance-transform-changed",function(){e.requestUpdateCycle()});this._instanceData.on("instance-visibility-changed",function(){e.requestUpdateCycle(!0)});this._instanceData.on("instance-highlight-changed",
function(){e.requestUpdateCycle(!0)});this._enableLevelSelection=1<this._symbol.levels.length;p.lodRenderers.push(this)}b.prototype.destroy=function(){p.lodRenderers.splice(p.lodRenderers.indexOf(this),1)};Object.defineProperty(b.prototype,"levels",{get:function(){return this._levels},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"baseBoundingBox",{get:function(){return this._levels[this._levels.length-1].boundingBox},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"baseBoundingSphere",{get:function(){return this._levels[this._levels.length-1].boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"baseMaterial",{get:function(){return this._levels[this._levels.length-1].components[0].material},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"slicePlane",{get:function(){return this._slicePlane},set:function(a){this._slicePlane=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"intersectionHandlerId",
{get:function(){return this._metadata.layerUid},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"instanceData",{get:function(){return this._instanceData},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"memoryUsage",{get:function(){var a={cpu:0,gpu:0};this._renderInstanceData.forEach(function(c){c=c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});this._highlightRenderInstanceData.forEach(function(c){c=c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});return a},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"renderStats",{get:function(){var a=this,c=this._instanceData.size,b=[];this._levels.forEach(function(c,e){e=a._renderInstanceData[e].size+a._highlightRenderInstanceData[e].size;c=c.triangleCount;b.push({renderedInstances:e,renderedTriangles:e*c,trianglesPerInstance:c})});return{totalInstances:c,renderedInstances:b.reduce(function(a,c){return a+c.renderedInstances},0),renderedTriangles:b.reduce(function(a,c){return a+c.renderedTriangles},0),levels:b}},enumerable:!0,
configurable:!0});b.prototype.initializeRenderContext=function(a){var c=this;this._initContext=a;var b=a.rctx;this._symbol.levels.forEach(function(e){c._levels.push(new H(a,e));c._renderInstanceData.push(new C.RenderInstanceData(b,c._instanceBufferLayout));c._highlightRenderInstanceData.push(new C.RenderInstanceData(b,c._instanceBufferLayout))});this._levelSelector=F(this)};b.prototype.uninitializeRenderContext=function(){this.invalidateOctree();this._levels.forEach(function(a){a.destroy()});this._renderInstanceData.forEach(function(a){a.destroy()});
this._highlightRenderInstanceData.forEach(function(a){a.destroy()})};Object.defineProperty(b.prototype,"slots",{get:function(){return[5,7]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"needsHighlight",{get:function(){return 0<this._highlightRenderInstanceData.reduce(function(a,c){return a+c.size},0)},enumerable:!0,configurable:!0});b.prototype.prepareRender=function(a){this.runUpdates(a)};b.prototype.render=function(a){var c=a.rctx,b=5===a.slot?4:7===a.slot?6:null;if(b){if(!this.baseMaterial.isVisible()||
!this.baseMaterial.isVisibleInPass(a.pass))return!1;var f=a.camera,f={view:f.viewMatrix,proj:f.projectionMatrix,origin:[0,0,0],viewInvTransp:f.viewInverseTransposeMatrix,viewport:f.viewport,fovY:f.fovY,nearFar:[f.near,f.far],shadowMap:a.shadowMap,shadowMappingEnabled:!!a.shadowMap&&a.shadowMap.enabled,ssaoEnabled:!!a.ssaoHelper&&a.ssaoHelper.enabled,pixelRatio:f.pixelRatio,slicePlane:a.sliceHelper&&a.sliceHelper.plane,cameraAboveGround:f.aboveGround,hudVisibilityTexture:a.offscreenRenderingHelper?
a.offscreenRenderingHelper.hudVisibilityTexture:null};c.bindVAO();for(c=0;c<this._levels.length;++c)this.renderLevel(a,b,f,a.isHighlightPass?this._highlightRenderInstanceData[c]:this._renderInstanceData[c],c);return!0}};b.prototype.intersect=function(a,c,b,f){var e=this;if(this.baseMaterial.isVisible()){var h=u.vec3f64.create();t.vec3.subtract(h,f,b);var d=function(d){e._instanceData.getCombinedModelTransform(d,I);a.transform.set(I);t.vec3.transformMat4(J,b,a.transform.inverse);t.vec3.transformMat4(K,
f,a.transform.inverse);var h=e._instanceData.getState(d),g=e._instanceData.getLodLevel(d);w.assert(h&k.StateFlags.ACTIVE,"invalid instance state");w.assert(0<=g&&g<e._levels.length,"invaid lod level");e._levels[g].intersect(a,c,J,K,d,e._metadata)};this.baseMaterial.getParameters().verticalOffset?this.octree.forEach(d):this.octree.forEachAlongRay(b,h,d)}};b.prototype.queryDepthRange=function(a){return this.queryDepthRangeOctree(a)};b.prototype.notifyShaderTransformationChanged=function(){this.invalidateOctree()};
b.prototype.requestUpdateCycle=function(a){void 0===a&&(a=!1);this._updateCyclesWithStaticCamera=-1;a&&(this._needFullCycle=!0);this.needsUpdates&&this._initContext.requestRender()};Object.defineProperty(b.prototype,"needsUpdates",{get:function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera},enumerable:!0,configurable:!0});b.prototype.runUpdates=function(a){if(!A.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var c=a.equals(this._lastCamera);this._lastCamera.copyFrom(a);
c||this.requestUpdateCycle()}c=this._needFullCycle?this._instanceData.size:2E3;this._needFullCycle=!1;this.updateInstances(a,c);this.needsUpdates&&this._initContext.requestRender()}};Object.defineProperty(b.prototype,"octree",{get:function(){this._octree||(this._octree=this.buildOctree());return this._octree},enumerable:!0,configurable:!0});b.prototype.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)};b.prototype.buildOctree=function(){for(var a=new R.InstanceOctree(this._instanceData,
this.baseBoundingSphere),c=this._instanceData,c=c.view?c.view.state:null,b=0;b<this._instanceData.capacity;++b)c.get(b)&k.StateFlags.ACTIVE&&a.addInstance(b);return a};b.prototype.queryDepthRangeOctree=function(a){var c=a.eye,b=a.viewForward,f=this.octree.findClosest(b,"front-to-back",a.frustum),g=this.octree.findClosest(b,"back-to-front",a.frustum);return null!=f&&null!=g?(this._instanceData.view.boundingSphere.getVec(f,n),t.vec3.subtract(n,n,c),f=t.vec3.dot(n,b)-n[3],this._instanceData.view.boundingSphere.getVec(g,
n),t.vec3.subtract(n,n,c),c=t.vec3.dot(n,b)+n[3],{near:Math.max(a.near,f),far:Math.min(a.far,c)}):{near:Infinity,far:-Infinity}};b.prototype.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._renderInstanceData.forEach(function(a){a.startUpdateCylce()});this._highlightRenderInstanceData.forEach(function(a){a.startUpdateCylce()});this.needsUpdates&&this._initContext.requestRender()};b.prototype.updateInstances=function(a,c){var b=this._enableLevelSelection,f=this._levelSelector;
f.updateCamera(a);this._renderInstanceData.forEach(function(a){a.beginUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.beginUpdate()});a=this._instanceData;var g=this._instanceData.view,h=a.capacity,d=this._instanceIndex;c=Math.min(a.size,c);for(var q=0;q<c;++q){0===d&&this.startUpdateCycle();var r=g.state.get(d),l=0;if(r&k.StateFlags.ALLOCATED){var m=g.lodLevel.get(d);r&k.StateFlags.ACTIVE&&this._renderInstanceData[m].freeTail();r&k.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[m].freeTail();
if(r&k.StateFlags.REMOVE)a.freeInstance(d);else if(r&k.StateFlags.VISIBLE){m=0;b&&(g.modelOrigin.getVec(d,L),m=f.selectLevel(L,a.getCombinedMedianScaleFactor(d)));l=r&~(k.StateFlags.ACTIVE|k.StateFlags.HIGHLIGHT_ACTIVE|k.StateFlags.TRANSFORM_CHANGED);if(0<=m){var n=this._renderInstanceData[m],p=n.allocateHead();E(g,d,n.view,p);l|=k.StateFlags.ACTIVE;r&k.StateFlags.HIGHLIGHT&&(n=this._highlightRenderInstanceData[m],p=n.allocateHead(),E(g,d,n.view,p),l|=k.StateFlags.HIGHLIGHT_ACTIVE)}g.state.set(d,
l);g.lodLevel.set(d,m)}else l=r&~(k.StateFlags.ACTIVE|k.StateFlags.HIGHLIGHT_ACTIVE|k.StateFlags.TRANSFORM_CHANGED),g.state.set(d,l);this._octree&&(m=!!(r&k.StateFlags.ACTIVE),l=!!(l&k.StateFlags.ACTIVE),!m&&l?this._octree.addInstance(d):m&&!l?this._octree.removeInstance(d):m&&l&&r&k.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(d),this._octree.addInstance(d)));d=(d+1)%h}else d=(d+1)%h,c++}this._instanceIndex=d;this._renderInstanceData.forEach(function(a){a.endUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.endUpdate()})};
b.prototype.renderLevel=function(a,c,b,f,g){var e=this;this._levels[g].components.forEach(function(d){e.renderComponent(a,c,b,f,d,g)})};b.prototype.renderComponent=function(a,c,b,f,g,h){var d=g.glMaterials.get(a.pass);if(d&&d.beginSlot(c)&&0!==f.size){var e=a.rctx,k=e.capabilities.instancing,l=d.getTechnique();b.origin=[0,0,0];d.bind(e,b);e.bindVAO(g.vao);l.ensureAttributeLocations(g.vao);c=l.program;a.isHighlightPass&&(e.bindTexture(a.offscreenRenderingHelper?a.offscreenRenderingHelper.depthTexture:
null,5),c.setUniform1i("depthTex",5),c.setUniform4f("highlightViewportPixelSz",0,0,1/b.viewport[2],1/b.viewport[3]));d.bindView(b);A.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===a.pass&&(c.setUniform4fv("externalColor",M[Math.min(h,M.length-1)]),c.setUniform1i("colorMixMode",U.colorMixModes.replace));a=f.capacity;b=f.headIndex;h=f.tailIndex;var d=f.firstIndex,m=this._glInstanceBufferLayout;c=function(a,b){D.bindVertexBufferLayout(e,x.Default3D,f.buffer,m,a);k.drawArraysInstanced(l.primitiveType,0,
g.vertexCount,b-a);D.unbindVertexBufferLayout(e,x.Default3D,f.buffer,m)};g.material.getParameters().transparent&&null!=d?b>h?(w.assert(d>=h&&d<=b,"invalid firstIndex"),c(d,b),c(h,d)):b<h&&(d<=b?(w.assert(0<=d&&d<=b,"invalid firstIndex"),c(d,b),c(h,a),c(0,d)):(w.assert(d>=h&&d<=a,"invalid firstIndex"),c(d,a),c(0,b),c(h,d))):b>h?c(h,b):b<h&&(c(0,b),c(h,a));e.bindVAO(null)}};return b}();p.LodRenderer=z;p.lodRenderers=[];var L=u.vec3f64.create(),n=O.vec4f64.create(),I=N.mat4f64.create(),J=u.vec3f64.create(),
K=u.vec3f64.create(),M=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]]});