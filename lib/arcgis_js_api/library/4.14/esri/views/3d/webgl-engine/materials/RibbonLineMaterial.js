// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/geometryUtils ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/geometryDataUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./VisualVariableMaterialParameters ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/RibbonLineTechnique ../shaders/RibbonLineTechnique".split(" "),
function(N,ra,O,U,V,W,P,B,X,d,k,f,Y,Z,aa,ba,ca,da,ea,Q,fa,ga,h){function H(d,c,a,b,h){for(var F=0;F<h;F++)a[b++]=d[c++];return b}var G=V.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");N=function(k){function c(a,b){b=k.call(this,b)||this;b.techniqueConfig=new h.RibbonLineTechniqueConfiguration;b.params=Q.copyParameters(a,ha);b.validateParams();b.params.transparent=1>b.params.color[3]||b.params.transparent;b.layout=b.createLayout();return b}O(c,k);c.prototype.dispose=function(){};
c.prototype.setParameterValues=function(a){for(var b in a)"cap"===b?G.error("cap cannot be changed after creation"):"join"===b&&"round"===this.params[b]!==("round"===a[b])?G.error("join cannot be changed after creation"):"stipplePattern"===b&&!!this.params[b]!==!!a[b]?G.error("stippledness cannot be changed after creation"):this.params[b]=a[b];this.validateParams();this.parametersChanged()};c.prototype.getParameters=function(){return this.params};c.prototype.getPassParameters=function(){return this.params};
c.prototype.getTechniqueConfig=function(a){this.techniqueConfig.output=a;a=P.isSome(this.params.stipplePattern);this.techniqueConfig.stippleEnabled=a;this.techniqueConfig.stippleIntegerRepeatsEnabled=a&&this.params.stippleIntegerRepeats;this.techniqueConfig.stippleOffColorEnabled=a&&P.isSome(this.params.stippleOffColor);this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.roundJoins="round"===this.params.join;this.techniqueConfig.roundCaps="round"===this.params.cap;
this.techniqueConfig.transparent=this.params.transparent;this.techniqueConfig.polygonOffset=this.params.polygonOffset;this.techniqueConfig.writeDepth=this.params.writeDepth;this.techniqueConfig.vvColor=this.params.vvColorEnabled;this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled;this.techniqueConfig.vvSize=this.params.vvSizeEnabled;this.techniqueConfig.writeDepth=this.params.writeDepth;this.techniqueConfig.writeDepth=this.params.writeDepth;return this.techniqueConfig};c.prototype.intersect=
function(a,b,c,d,g,h,e,m,f){f?Q.intersectDrapedRenderLineGeometry(a,d,h,this.params.width,e):this.intersectLineGeometry(a,b,c,d,this.params.width,e)};c.prototype.intersectLineGeometry=function(a,b,c,k,g,p){if(k.options.selectionMode&&!Z.isAllHidden(b.componentVisibilities,a.componentOffsets))if(da.isTranslationMatrix(c)){b=a.data.getVertexAttr();a=b[h.RibbonVertexAttributeConstants.POSITION].data;this.params.vvSizeEnabled?g*=W.clamp(this.params.vvSizeOffset[0]+b[h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]*
this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0]):b[h.RibbonVertexAttributeConstants.SIZE]&&(g*=b[h.RibbonVertexAttributeConstants.SIZE].data[0]);var e=k.camera,m=ia;X.vec2.copy(m,k.point);g=g*e.pixelRatio/2+4*e.pixelRatio;d.vec3.set(E[0],m[0]-g,m[1]+g,0);d.vec3.set(E[1],m[0]+g,m[1]+g,0);d.vec3.set(E[2],m[0]+g,m[1]-g,0);d.vec3.set(E[3],m[0]-g,m[1]-g,0);for(var t=0;4>t;t++)e.unprojectPoint(E[t],y[t]);f.plane.fromPoints(e.eye,y[0],y[1],I);f.plane.fromPoints(e.eye,
y[1],y[2],J);f.plane.fromPoints(e.eye,y[2],y[3],K);f.plane.fromPoints(e.eye,y[3],y[0],L);b=Number.MAX_VALUE;for(var F=this.params.isClosed?a.length-2:a.length-5,t=0;t<F;t+=3){u[0]=a[t]+c[12];u[1]=a[t+1]+c[13];u[2]=a[t+2]+c[14];var r=(t+3)%a.length;q[0]=a[r]+c[12];q[1]=a[r+1]+c[13];q[2]=a[r+2]+c[14];if(!(0>f.plane.signedDistance(I,u)&&0>f.plane.signedDistance(I,q)||0>f.plane.signedDistance(J,u)&&0>f.plane.signedDistance(J,q)||0>f.plane.signedDistance(K,u)&&0>f.plane.signedDistance(K,q)||0>f.plane.signedDistance(L,
u)&&0>f.plane.signedDistance(L,q))){e.projectPoint(u,z);e.projectPoint(q,D);if(0>z[2]&&0<D[2]){d.vec3.subtract(x,u,q);var r=e.frustum,M=-f.plane.signedDistance(r.planes[4],u),r=M/d.vec3.dot(x,r.planes[4]);d.vec3.scale(x,x,r);d.vec3.add(u,u,x);e.projectPoint(u,z)}else if(0<z[2]&&0>D[2])d.vec3.subtract(x,q,u),r=e.frustum,M=-f.plane.signedDistance(r.planes[4],q),r=M/d.vec3.dot(x,r.planes[4]),d.vec3.scale(x,x,r),d.vec3.add(q,q,x),e.projectPoint(q,D);else if(0>z[2]&&0>D[2])continue;z[2]=0;D[2]=0;r=f.lineSegment.distance2(f.lineSegment.fromPoints(z,
D,R),m);r<b&&(b=r,d.vec3.copy(S,u),d.vec3.copy(T,q))}}c=k.rayBeginPoint;k=k.rayEndPoint;b<g*g&&(a=Number.MAX_VALUE,f.lineSegment.closestLineSegmentPoint(f.lineSegment.fromPoints(S,T,R),f.lineSegment.fromPoints(c,k,ja),C)&&(d.vec3.subtract(C,C,c),a=d.vec3.length(C),d.vec3.scale(C,C,1/a),a/=d.vec3.distance(c,k)),p(a,C))}else G.error("intersection assumes a translation-only matrix")};c.prototype.computeAttachmentOrigin=function(a,b){a=a.data;return(a="getVertexAttr"in a?a.getVertexAttr():"vertexAttr"in
a?a.vertexAttr:null)?aa.computeAttachmentOriginLines(a[h.RibbonVertexAttributeConstants.POSITION],null,b):null};c.prototype.createLayout=function(){var a=Y.newLayout().vec3f(h.RibbonVertexAttributeConstants.POSITION).f32(h.RibbonVertexAttributeConstants.SUBDIVISIONFACTOR).vec2f(h.RibbonVertexAttributeConstants.UV0).vec3f(h.RibbonVertexAttributeConstants.AUXPOS1).vec3f(h.RibbonVertexAttributeConstants.AUXPOS2);this.params.vvSizeEnabled?a.f32(h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE):a.f32(h.RibbonVertexAttributeConstants.SIZE);
this.params.vvColorEnabled?a.f32(h.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE):a.vec4f(h.RibbonVertexAttributeConstants.COLOR);this.params.vvOpacityEnabled&&a.f32(h.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE);return a};c.prototype.createBufferWriter=function(){return new ka(this.layout,this.params)};c.prototype.createRenderer=function(a,b){return new fa(a,b,this,h.ribbonVertexAttributeLocations)};c.prototype.getGLMaterial=function(a){return 0===a.output||4===a.output?new la(a):
void 0};c.prototype.validateParams=function(){this.params.width&&1<this.params.width&&(this.params.width=Math.round(this.params.width));"miter"!==this.params.join&&(this.params.miterLimit=0)};return c}(ca.Material);var la=function(d){function c(a){a=d.call(this,a)||this;a.updateParameters();return a}O(c,d);c.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(ga.RibbonLineTechnique,this.material.getTechniqueConfig(this.output),this.technique)};c.prototype.beginSlot=
function(a){return 0===this.output?a===(this.technique.configuration.writeDepth?6:9):4===a};c.prototype.bind=function(a,b){a.bindProgram(this.technique.program);this.technique.bindPipelineState(a);this.technique.bindPass(a,this.material.getPassParameters(),b)};return c}(ba.GLMaterial),ha=U({width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,
isClosed:!1},ea.Default),ka=function(){function f(c,a){this.params=a;this.numJoinSubdivisions=this.numCapSubdivisions=0;this.vertexBufferLayout=c;if(!a.isClosed)switch(this.params.cap){case "butt":this.numCapSubdivisions=0;break;case "square":this.numCapSubdivisions=1;break;case "round":this.numCapSubdivisions=ma}switch(this.params.join){case "miter":case "bevel":this.numJoinSubdivisions=a.stipplePattern?1:0;break;case "round":this.numJoinSubdivisions=na}}f.prototype.allocate=function(c){return this.vertexBufferLayout.createBuffer(c)};
f.prototype.elementCount=function(c){var a=2*this.numCapSubdivisions+2,b=c.indices[h.RibbonVertexAttributeConstants.POSITION].length/2+1,d=this.params.isClosed,a=d?2:2*a,b=d?b:b-1;if(c.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS])for(c=c.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS].data,d=d?0:1;d<b;++d)a+=4+2*c[d];else a+=b*(2*this.numJoinSubdivisions+4);return a+2};f.prototype.write=function(c,a,b,f){var k=this,g=oa,p=pa,e=qa,m=a.vertexAttr[h.RibbonVertexAttributeConstants.POSITION].data,
t=a.indices&&a.indices[h.RibbonVertexAttributeConstants.POSITION];t&&t.length!==2*(m.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");t=null;a.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS]&&(t=a.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS].data);var u=1,r=0;this.params.vvSizeEnabled?r=a.vertexAttr[h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]:a.vertexAttr[h.RibbonVertexAttributeConstants.SIZE]&&(u=a.vertexAttr[h.RibbonVertexAttributeConstants.SIZE].data[0]);
var q=[1,1,1,1],x=0;this.params.vvColorEnabled?x=a.vertexAttr[h.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE].data[0]:a.vertexAttr[h.RibbonVertexAttributeConstants.COLOR]&&(q=a.vertexAttr[h.RibbonVertexAttributeConstants.COLOR].data);var y=0;this.params.vvOpacityEnabled&&(y=a.vertexAttr[h.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE].data[0]);a=m.length/3;c=c.transformation;var n=new Float32Array(b.buffer);b=this.vertexBufferLayout.stride/4;var l=f*b;f=l;var w=function(a,b,c,d,e,
f){n[l++]=b[0];n[l++]=b[1];n[l++]=b[2];n[l++]=d;n[l++]=e;n[l++]=f;n[l++]=a[0];n[l++]=a[1];n[l++]=a[2];n[l++]=c[0];n[l++]=c[1];n[l++]=c[2];k.params.vvSizeEnabled?n[l++]=r:n[l++]=u;k.params.vvColorEnabled?n[l++]=x:(n[l++]=q[0],n[l++]=q[1],n[l++]=q[2],n[l++]=q[3]);k.params.vvOpacityEnabled&&(n[l++]=y)},l=l+b;d.vec3.set(p,m[0],m[1],m[2]);c&&d.vec3.transformMat4(p,p,c);var z=this.params.isClosed;if(z){var v=m.length-3;d.vec3.set(g,m[v],m[v+1],m[v+2]);c&&d.vec3.transformMat4(g,g,c)}else{d.vec3.copy(g,p);
d.vec3.set(e,m[3],m[4],m[5]);c&&d.vec3.transformMat4(e,e,c);for(v=0;v<this.numCapSubdivisions;++v){var A=1-v/this.numCapSubdivisions;w(g,p,e,A,1,-4);w(g,p,e,A,1,4)}w(g,p,e,0,0,-4);w(g,p,e,0,0,4);d.vec3.copy(g,p);d.vec3.copy(p,e)}for(var D=z?a:a-1,v=z?0:1;v<D;v++){A=(v+1)%a*3;d.vec3.set(e,m[A+0],m[A+1],m[A+2]);c&&d.vec3.transformMat4(e,e,c);w(g,p,e,0,1,-1);w(g,p,e,0,1,1);for(var C=t?t[v]:this.numJoinSubdivisions,B=0;B<C;++B)A=(B+1)/(C+1),w(g,p,e,A,1,-2),w(g,p,e,A,1,2);w(g,p,e,1,0,-2);w(g,p,e,1,0,2);
d.vec3.copy(g,p);d.vec3.copy(p,e)}if(z)l=H(n,f+b,n,l,2*b);else for(w(g,p,e,0,1,-5),w(g,p,e,0,1,5),v=0;v<this.numCapSubdivisions;++v)A=(v+1)/this.numCapSubdivisions,w(g,p,e,A,1,-5),w(g,p,e,A,1,5);H(n,f+b,n,f,b);l=H(n,l-b,n,l,b)};return f}(),ma=3,na=1,u=k.vec3f64.create(),q=k.vec3f64.create(),x=k.vec3f64.create(),C=k.vec3f64.create(),ia=k.vec3f64.create(),z=B.createRenderScreenPointArray3(),D=B.createRenderScreenPointArray3(),S=k.vec3f64.create(),T=k.vec3f64.create(),R=f.lineSegment.create(),ja=f.lineSegment.create(),
oa=k.vec3f64.create(),pa=k.vec3f64.create(),qa=k.vec3f64.create(),E=[B.createRenderScreenPointArray3(),B.createRenderScreenPointArray3(),B.createRenderScreenPointArray3(),B.createRenderScreenPointArray3()],y=[k.vec3f64.create(),k.vec3f64.create(),k.vec3f64.create(),k.vec3f64.create()],I=f.plane.create(),J=f.plane.create(),K=f.plane.create(),L=f.plane.create();return N});