// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4 ../../../../../geometry/support/aaBoundingBox ../../lib/ComponentUtils ../../lib/screenSizePerspectiveUtils ../../lib/Util".split(" "),function(ha,d,ba,O,H,ca,da,
A,B,J,I,P,ea,Q){function R(a,b,c,f,u,e){var h=M(b,c,S);I.setMin(x,a.getBBMin());I.setMax(x,a.getBBMax());H.isSome(u)&&u.applyToAABB(x);if(K(x,b,h,f)){var h=a.getPrimitiveIndices(),t=a.getIndices(),d=a.getPosition(),g=h?h.length:t.length/3;if(g>fa&&(a=a.getChildren(),void 0!==a)){for(h=0;8>h;++h)void 0!==a[h]&&R(a[h],b,c,f,u,e);return}L(b,c,0,g,t,d,h,u,e)}}function L(a,b,c,f,u,e,h,t,d){var g,m,k;if(h){var n,l,r=e.data,x=e.offsetIdx;e=e.strideIdx;var A=a[0],B=a[1];a=a[2];var F=b[0]-A,G=b[1]-B;for(b=
b[2]-a;c<f;++c){var C=h[c],v=3*C;l=x+e*u[v++];var q=r[l++],p=r[l++];g=r[l];l=x+e*u[v++];var y=r[l++];m=r[l++];n=r[l];l=x+e*u[v];v=r[l++];k=r[l++];l=r[l];H.isSome(t)&&(g=t.applyToVertex(q,p,g),q=g[0],p=g[1],g=g[2],n=t.applyToVertex(y,m,n),y=n[0],m=n[1],n=n[2],l=t.applyToVertex(v,k,l),v=l[0],k=l[1],l=l[2]);y-=q;m-=p;n-=g;v-=q;k-=p;l-=g;var z=G*l-k*b,E=b*v-l*F,D=F*k-v*G,w=y*z+m*E+n*D;if(!(Math.abs(w)<=T)){q=A-q;p=B-p;g=a-g;z=q*z+p*E+g*D;if(0<w){if(0>z||z>w)continue}else if(0<z||z<w)continue;E=p*n-m*
g;g=g*y-n*q;p=q*m-y*p;q=F*E+G*g+b*p;if(0<w){if(0>q||z+q>w)continue}else if(0<q||z+q<w)continue;p=(v*E+k*g+l*p)/w;0<=p&&(y=N(y,m,n,v,k,l,U),d(p,y,C))}}}else for(h=e.data,r=e.offsetIdx,x=e.strideIdx,e=a[0],A=a[1],B=a[2],a=b[0]-e,F=b[1]-A,G=b[2]-B,b=c,c*=3;b<f;++b)if(k=r+x*u[c++],q=h[k++],p=h[k++],g=h[k],k=r+x*u[c++],C=h[k++],y=h[k++],m=h[k],k=r+x*u[c++],n=h[k++],v=h[k++],k=h[k],H.isSome(t)&&(g=t.applyToVertex(q,p,g),q=g[0],p=g[1],g=g[2],m=t.applyToVertex(C,y,m),C=m[0],y=m[1],m=m[2],k=t.applyToVertex(n,
v,k),n=k[0],v=k[1],k=k[2]),C-=q,y-=p,m-=g,n-=q,v-=p,k-=g,w=F*k-v*G,z=G*n-k*a,E=a*v-n*F,l=C*w+y*z+m*E,!(Math.abs(l)<=T)){q=e-q;p=A-p;g=B-g;w=q*w+p*z+g*E;if(0<l){if(0>w||w>l)continue}else if(0<w||w<l)continue;z=p*m-y*g;g=g*C-m*q;p=q*y-C*p;q=a*z+F*g+G*p;if(0<l){if(0>q||w+q>l)continue}else if(0<q||w+q<l)continue;p=(n*z+v*g+k*p)/l;0<=p&&(C=N(C,y,m,n,v,k,U),d(p,C,b))}}function N(a,b,c,f,u,e,h){A.vec3.set(V,a,b,c);A.vec3.set(W,f,u,e);A.vec3.cross(h,V,W);A.vec3.normalize(h,h);return h}function M(a,b,c){return A.vec3.set(c,
1/(b[0]-a[0]),1/(b[1]-a[1]),1/(b[2]-a[2]))}function K(a,b,c,f){return X(a,b,c,f,Infinity)}function X(a,b,c,f,u){var e=(a[0]-f-b[0])*c[0],h=(a[3]+f-b[0])*c[0],d=Math.min(e,h),e=Math.max(e,h),h=(a[1]-f-b[1])*c[1],r=(a[4]+f-b[1])*c[1],e=Math.min(e,Math.max(h,r));if(0>e)return!1;d=Math.max(d,Math.min(h,r));if(d>e)return!1;h=(a[2]-f-b[2])*c[2];a=(a[5]+f-b[2])*c[2];e=Math.min(e,Math.max(h,a));if(0>e)return!1;d=Math.max(d,Math.min(h,a));return d>e?!1:d<u}function Y(a,b){b=b?Y(b):{};for(var c in a){var f=
a[c];f&&f.forEach&&(f=ga(f));null==f&&c in b||(b[c]=f)}return b}function ga(a){var b=[];a.forEach(function(a){return b.push(a)});return b}Object.defineProperty(d,"__esModule",{value:!0});var Z=da.mat4f64.create(),x=I.create(),D=Q.VertexAttrConstants;d.intersectTriangleGeometry=function(a,b,c,f,d,e,h){b=b&&b.componentVisibilities;c=c.tolerance;if(1<a.componentCount)a:{var u=M(f,d,S),r=a.componentCount,g=a.componentOffsets,m=a.getIndices(D.POSITION),k=a.getAttribute(D.POSITION),n=a.boundingInfo;if(n&&
(I.setMin(x,n.getBBMin()),I.setMax(x,n.getBBMax()),H.isSome(e)&&e.applyToAABB(x),!K(x,f,u,c)))break a;for(n=0;n<r;n++)if(!b||P.getVisibility(b,n)){if(a.getComponentAABB){var l=a.getComponentAABB(n,x);H.isSome(e)&&e.applyToAABB(l);if(!K(l,f,u,c))continue}L(f,d,g[n]/3,g[n+1]/3,m,k,void 0,e,h)}}else if(!b||P.getVisibility(b,0))a.boundingInfo?(Q.assert("triangle"===a.data.primitiveType),R(a.boundingInfo,f,d,c,e,h)):(b=a.getIndices(D.POSITION),a=a.getAttribute(D.POSITION),L(f,d,0,b.length/3,b,a,void 0,
e,h))};var S=B.vec3f64.create(),T=Math.pow(2,-52),U=B.vec3f64.create();d.intersectTriangles=L;var V=B.vec3f64.create(),W=B.vec3f64.create();d.computeNormal=N;d.computeInvDir=M;d.intersectAabbInvDir=K;d.intersectAabbInvDirBefore=X;d.transformToWorld=function(a,b,c){return J.vec4.set(c,a[0]-b[0],a[1]-b[1],a[2]-b[2],1)};d.transformToView=function(a,b,c,f){ca.mat4.translate(Z,c,b);return J.vec4.transformMat4(f,a,Z)};d.transformToProjection=function(a,b,c,f){f[0]=a[0]+c[0];f[1]=a[1]+c[1];f[2]=a[2]+c[2];
f[3]=a[3];return J.vec4.transformMat4(f,f,b)};d.transformToNDC=function(a,b){return J.vec4.scale(b,a,1/Math.abs(a[3]))};d.verticalOffsetAtDistance=function(a,b,c,f,d){var e=(c.screenLength||0)*a.pixelRatio;d&&(e=ea.scale(e,f,b,d));return O.glClamp(e*Math.tan(.5*a.fovY)/(.5*a.fullHeight)*b,c.minWorldLength||0,null!=c.maxWorldLength?c.maxWorldLength:Infinity)};d.acquireIfNotUndefined=function(a,b,c){if(void 0!==a)return b.acquire(a,c)};d.releaseIfNotUndefined=function(a,b){void 0!==a&&b.release(a)};
var aa=B.vec3f64.create();d.bindSlicePlane=function(a,b,c){H.isSome(b)?(A.vec3.subtract(aa,b.origin,a),c.setUniform3fv("slicePlaneOrigin",aa),c.setUniform3fv("slicePlaneBasis1",b.basis1),c.setUniform3fv("slicePlaneBasis2",b.basis2)):c.setUniform3fv("slicePlaneBasis1",B.vec3f64.ZEROS)};d.bindHighlightRendering=function(a,b,c){a.bindTexture(b.highlightDepthTexture,5);c.setUniform1i("depthTex",5);c.setUniform4f("highlightViewportPixelSz",0,0,1/b.viewport[2],1/b.viewport[3])};d.bindScreenSizePerspective=
function(a,b,c){void 0===c&&(c="screenSizePerspectiveAlignment");if(a){var f=a.parameters;b.setUniform4f(c,f.divisor,f.offset,f.minPixelSize,a.paddingPixelsOverride)}};d.copyParameters=Y;d.updateParameters=function(a,b){var c=!1,f;for(f in b){var d=b[f];void 0!==d&&(c=!0,Array.isArray(d)?a[f]=d.slice():a[f]=d)}return c};(function(a){function b(a){return(a.shadowMappingEnabled?1:0)|(a.ssaoEnabled?2:0)}a.create=function(a,f){for(var c=[],e=0;2>e;e++)for(var d=0;2>d;d++){var t=b({shadowMappingEnabled:1===
e,ssaoEnabled:1===d}),r=b({shadowMappingEnabled:1===e,ssaoEnabled:1===d&&a.receiveSSAO});c[t]=c[r]||f({receiveShadows:1===e,receiveSSAO:1===d&&a.receiveSSAO})}return{programs:c.filter(function(a){return null!=a}),byParameter:c}};a.lookup=function(a,d){return a.byParameter[b(d)]};a.programs=function(a){return a.programs}})(d.BindParametersMap||(d.BindParametersMap={}));d.intersectDrapedRenderLineGeometry=function(a,b,c,d,u){if(b.options.selectionMode){b=a.getAttribute(D.POSITION).data;var e=a.getAttribute(D.SIZE),
f=c[0];c=c[1];a=(((e&&e.data[0])+d)/2+4)*a.pixelRatio;d=Number.MAX_VALUE;for(e=0;e<b.length-5;e+=3){var t=b[e],r=b[e+1],g=f-t,m=c-r,t=b[e+3]-t,r=b[e+4]-r,k=O.clamp((t*g+r*m)/(t*t+r*r),0,1),g=t*k-g,m=r*k-m,m=g*g+m*m;m<d&&(d=m)}d<a*a&&u()}};d.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var fa=1E3;d.defaultPBRMaterialParameters={roughnessFactor:.6,metallicFactor:0,reflectanceFactor:.2};d.defaultPBRTreeMaterialParameters={roughnessFactor:1,metallicFactor:0,reflectanceFactor:.2};d.getDefaultPBRMaterialParameters=
function(a,b){return ba({usePBR:a},b?d.defaultPBRTreeMaterialParameters:d.defaultPBRMaterialParameters)}});