// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/types/mat4 ../../../../geometry/support/aaBoundingRect ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/geometryDataUtils ../lib/GLMaterialTexture ../lib/Material ../lib/screenSizePerspectiveUtils ../lib/Util ./internal/bufferWriterUtils ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/HUDMaterial.glsl ../shaders/HUDMaterialTechnique".split(" "),
function(M,J,A,N,Y,O,Z,aa,P,ba,Q,h,C,ca,da,ea,fa,ga,R,ha,F,c,v,G,ia,S,H){M=function(w){function b(a,b){b=w.call(this,b)||this;b.techniqueConfig=new H.HUDMaterialTechniqueConfiguration;b.params=G.copyParameters(a,ja);return b}A(b,w);b.prototype.dispose=function(){};b.prototype.setParameterValues=function(a){for(var b in a)"textureId"===b&&c.assert(!!this.params.textureId,"Can only change texture of material that already has a texture"),this.params[b]=a[b];this.parametersChanged()};b.prototype.getParameters=
function(){return this.params};b.prototype.getTechniqueConfig=function(a){this.techniqueConfig.output=a;this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.verticalOffset=!!this.params.verticalOffset;this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective;this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0;this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset;this.techniqueConfig.occlusionTestEnabled=
this.params.occlusionTest;this.techniqueConfig.sdf=this.params.textureIsSignedDistanceField;this.techniqueConfig.vvSize=!!this.params.vvSizeEnabled;this.techniqueConfig.vvColor=!!this.params.vvColorEnabled;0===a&&(this.techniqueConfig.debugDrawBorder=!!this.params.debugDrawBorder);4===a&&(this.techniqueConfig.binaryHighlightOcclusion=this.params.binaryHighlightOcclusion);return this.techniqueConfig};b.prototype.intersect=function(a,b,f,g,T,d,n,c,l){l?this.intersectDrapedRenderHudGeometry(a,d,n,c):
this.intersectHudGeometry(a,b,f,g,n,c)};b.prototype.intersectDrapedRenderHudGeometry=function(a,b,f,g){var e=a.getAttribute(c.VertexAttrConstants.POSITION),d=a.getAttribute(c.VertexAttrConstants.SIZE),n=this.params,w=S.calculateAnchorPosForRendering(n),l=1,p=1;g&&(p=g(U),l=p[0],p=p[5]);l*=a.pixelRatio;p*=a.pixelRatio;g=ka*a.pixelRatio;for(var r=0;r<e.data.length/e.size;r++){var q=r*e.size;h.vec3.set(m,e.data[q],e.data[q+1],e.data[q+2]);q=r*d.size;t[0]=d.data[q]*l;t[1]=d.data[q+1]*p;var q=m[0],u=m[1],
z=void 0;n.textureIsSignedDistanceField&&(z=n.outlineSize*a.pixelRatio/2);this._isInsideIconBoundaries(b,q,u,g,z,n,w)&&f()}};b.prototype.intersectHudGeometry=function(a,b,f,g,T,d){if(g.options.selectionMode&&g.options.hud&&!fa.isAllHidden(b.componentVisibilities,a.componentOffsets)){var e=a.data;a=this.params;var w=b=1;O.mat3.fromMat4(I,f);if(d){w=d(U);b=w[0];w=w[5];d=I;var l=d[0],p=d[1],r=d[2],q=d[3],v=d[4],z=d[5],y=d[6],k=d[7],x=d[8],B=1/Math.sqrt(l*l+p*p+r*r),E=1/Math.sqrt(q*q+v*v+z*z),A=1/Math.sqrt(y*
y+k*k+x*x);d[0]=l*B;d[1]=p*B;d[2]=r*B;d[3]=q*E;d[4]=v*E;d[5]=z*E;d[6]=y*A;d[7]=k*A;d[8]=x*A}d=e.getVertexAttr()[c.VertexAttrConstants.POSITION];l=e.getVertexAttr()[c.VertexAttrConstants.SIZE];p=e.getVertexAttr()[c.VertexAttrConstants.NORMAL];e=e.getVertexAttr()[c.VertexAttrConstants.AUXPOS1];c.assert(3<=d.size);r=g.point;q=g.camera;v=S.calculateAnchorPosForRendering(a);b*=q.pixelRatio;w*=q.pixelRatio;z="screen"===this.params.centerOffsetUnits;for(y=0;y<d.data.length/d.size;y++)k=y*d.size,h.vec3.set(m,
d.data[k],d.data[k+1],d.data[k+2]),h.vec3.transformMat4(m,m,f),k=y*l.size,t[0]=l.data[k]*b,t[1]=l.data[k+1]*w,h.vec3.transformMat4(m,m,q.viewMatrix),k=y*e.size,h.vec3.set(u,e.data[k+0],e.data[k+1],e.data[k+2]),z||(m[0]+=u[0],m[1]+=u[1],0!==u[2]&&(k=u[2],h.vec3.normalize(u,m),h.vec3.subtract(m,m,h.vec3.scale(u,u,k)))),k=y*p.size,h.vec3.set(V,p.data[k],p.data[k+1],p.data[k+2]),this.applyVerticalOffsetTransformation(m,V,I,q,K),q.applyProjection(m,D),-1<D[0]&&(k=Math.floor(D[0])+this.params.screenOffset[0],
x=Math.floor(D[1])+this.params.screenOffset[1],z&&(k+=u[0],0!==u[1]&&(x+=F.applyScaleFactor(u[1],K.factorAlignment))),F.applyPrecomputedScaleFactorVec2(t,K.factor,t),B=la*q.pixelRatio,E=void 0,a.textureIsSignedDistanceField&&(E=a.outlineSize*q.pixelRatio/2),this._isInsideIconBoundaries(r,k,x,B,E,a,v)&&(x=g.ray,h.vec3.transformMat4(W,m,aa.mat4.invert(ma,q.viewMatrix)),D[0]=r[0],D[1]=r[1],q.unprojectPoint(D,m),k=C.vec3f64.create(),h.vec3.copy(k,x.direction),B=1/h.vec3.length(k),h.vec3.scale(k,k,B),
x=h.vec3.distance(x.origin,m)*B,T(x,k,-1,1,!0,W)))}};b.prototype.computeAttachmentOrigin=function(a,b){a=a.data;var f="getVertexAttr"in a?a.getVertexAttr():"vertexAttr"in a?a.vertexAttr:null;if(!f)return null;var e=c.VertexAttrConstants.POSITION,f=f[e];a="getIndices"in a?a.getIndices(e):"indices"in a?a.indices[e]:null;return ga.computeAttachmentOriginPoints(f,a,b)};b.prototype._isInsideIconBoundaries=function(a,b,f,g,c,d,n){b=b-g-(0<n[0]?t[0]*n[0]:0);var e=b+t[0]+2*g;f=f-g-(0<n[1]?t[1]*n[1]:0);g=
f+t[1]+2*g;d.textureIsSignedDistanceField&&(d=d.distanceFieldBoundingBox,b+=t[0]*d[0],f+=t[1]*d[1],e-=t[0]*(1-d[2]),g-=t[1]*(1-d[3]),b-=c,e+=c,f-=c,g+=c);return a[0]>b&&a[0]<e&&a[1]>f&&a[1]<g};b.prototype.createBufferWriter=function(){return new na(this)};b.prototype.createRenderer=function(a,b){return new ia(a,b,this)};b.prototype.normalAndViewAngle=function(a,b,f,g){void 0===g&&(g=L);h.vec3.transformMat3(g.normal,a,b);h.vec3.transformMat4(g.normal,g.normal,f.viewInverseTransposeMatrix);g.cosAngle=
h.vec3.dot(X,oa);return g};b.prototype.updateScaleInfo=function(a,b){var f=this.params;f.screenSizePerspective?a.factor=F.precomputeScaleFactor(L.cosAngle,b,f.screenSizePerspective,a.factor):(a.factor.scale=1,a.factor.factor=0,a.factor.minPixelSize=0,a.factor.paddingPixels=0);f.screenSizePerspectiveAlignment?a.factorAlignment=F.precomputeScaleFactor(L.cosAngle,b,f.screenSizePerspectiveAlignment,a.factorAlignment):(a.factorAlignment.factor=a.factor.factor,a.factorAlignment.scale=a.factor.scale,a.factorAlignment.minPixelSize=
a.factor.minPixelSize,a.factorAlignment.paddingPixels=a.factor.paddingPixels)};b.prototype.applyVerticalOffsetTransformation=function(a,b,f,g,c,d){var e=this.params;ca.isMat4(f)&&(f=O.mat3.fromMat4(I,f));if(!e.verticalOffset||!e.verticalOffset.screenLength)return c&&(e.screenSizePerspective||e.screenSizePerspectiveAlignment)?(g=h.vec3.length(a),this.updateScaleInfo(c,g)):c&&(c.factor.scale=1,c.factorAlignment.scale=1),d?h.vec3.copy(d,a):a;b=this.normalAndViewAngle(b,f,g);f=h.vec3.length(a);g=G.verticalOffsetAtDistance(g,
f,e.verticalOffset,b.cosAngle,e.screenSizePerspectiveAlignment||e.screenSizePerspective);c&&this.updateScaleInfo(c,f);return h.vec3.add(d||a,a,h.vec3.scale(b.normal,b.normal,g))};b.prototype.getGLMaterial=function(a){if(0===a.output)return new pa(a);if(4===a.output)return new qa(a)};b.prototype.calculateRelativeScreenBounds=function(a,b,f){void 0===f&&(f=da.create());var c=this.params,e=f;void 0===e&&(e=ra);ba.vec2.copy(e,c.anchorPos);e[0]*=-a[0];e[1]*=-a[1];e[0]+=c.screenOffset[0]*b;e[1]+=c.screenOffset[1]*
b;f[2]=f[0]+a[0];f[3]=f[1]+a[1];return f};b.shouldRenderVisibilityDuringRenderPass=function(a){return 0===a||4};return b}(ha.Material);J=function(c){function b(a){a=c.call(this,R.makeCtorParameters(a,a.material.getParameters()))||this;a.updateParameters();return a}A(b,c);b.prototype.beginSlot=function(a){return a===(this.params.drawInSecondSlot?16:15)};b.prototype.updateParameters=function(){this.params=G.copyParameters(this.material.getParameters());this.updateTexture(this.params.textureId);this.selectProgram()};
b.prototype.selectProgram=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(H.HUDMaterialTechnique,this.material.getTechniqueConfig(this.output),this.technique)};b.prototype.bind=function(a,b){var c=this.technique.program;a.bindProgram(c);this.technique.bindPipelineState(a);this.bindTexture(a,c);this.bindTextureScale(a,c);this.technique.bindPass(a,this.params,b);G.bindHighlightRendering(a,b,this.technique.program)};return b}(R);var pa=function(c){function b(a){a=c.call(this,N({},
a,{output:0}))||this;a.isOcclusionSlot=!1;return a}A(b,c);b.prototype.beginSlot=function(a){var b=this.params.drawInSecondSlot?16:15;if(this.params.occlusionTest)return this.isOcclusionSlot=10===a,10===a||a===b;this.isOcclusionSlot=!1;return a===b};b.prototype.getTechnique=function(){return this.isOcclusionSlot?this.occlusionTechnique:this.technique};b.prototype.selectProgram=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(H.HUDMaterialTechnique,this.material.getTechniqueConfig(this.output),
this.technique);this.occlusionTechnique=this.techniqueRep.acquireAndReleaseExisting(H.HUDMaterialTechnique,this.material.getTechniqueConfig(6),this.occlusionTechnique)};b.prototype.bind=function(a,b){if(this.isOcclusionSlot)a.bindProgram(this.occlusionTechnique.program),this.occlusionTechnique.bindPipelineState(a),this.occlusionTechnique.bindPass(a,this.params,b);else{var c=this.technique.program;a.bindProgram(c);this.technique.bindPipelineState(a);this.bindTexture(a,c);this.bindTextureScale(a,c);
this.technique.bindPass(a,this.params,b)}};b.prototype.bindView=function(a){(this.isOcclusionSlot?this.occlusionTechnique:this.technique).bindDraw(a)};return b}(J),qa=function(c){function b(a){return c.call(this,N({},a,{output:4}))||this}A(b,c);return b}(J),K={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},ra=Q.vec2f64.create(),m=C.vec3f64.create(),V=C.vec3f64.create(),D=Y.createRenderScreenPointArray3(),X=C.vec3f64.create(),
W=C.vec3f64.create(),I=Z.mat3f64.create(),ma=P.mat4f64.create(),u=C.vec3f64.create(),L={normal:X,cosAngle:0},U=P.mat4f64.create(),la=1,ka=2,t=[0,0],oa=C.vec3f64.fromValues(0,0,1),ja={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,
vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:Q.vec2f64.fromValues(.5,.5),shaderPolygonOffset:1E-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",debugDrawBorder:!1},sa=ea.newLayout().vec3f(c.VertexAttrConstants.POSITION).vec3f(c.VertexAttrConstants.NORMAL).vec2f(c.VertexAttrConstants.UV0).vec4u8(c.VertexAttrConstants.COLOR).vec2f(c.VertexAttrConstants.SIZE).vec4f(c.VertexAttrConstants.AUXPOS1).vec4f(c.VertexAttrConstants.AUXPOS2),
na=function(){function h(b){this.material=b;this.vertexBufferLayout=sa}h.prototype.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};h.prototype.elementCount=function(b){return 6*b.indices[c.VertexAttrConstants.POSITION].length};h.prototype.write=function(b,a,e,f){v.writePosition(a.indices[c.VertexAttrConstants.POSITION],a.vertexAttr[c.VertexAttrConstants.POSITION].data,b.transformation,e.position,f,6);v.writeNormal(a.indices[c.VertexAttrConstants.NORMAL],a.vertexAttr[c.VertexAttrConstants.NORMAL].data,
b.invTranspTransformation,e.normal,f,6);b=a.vertexAttr[c.VertexAttrConstants.UV0].data;var g=void 0,h=void 0,d=void 0,n=void 0;null==b||4>b.length?(b=this.material.getParameters(),h=g=0,d=b.texCoordScale[0],n=b.texCoordScale[1]):(g=b[0],h=b[1],d=b[2],n=b[3]);var d=Math.min(1.99999,d+1),n=Math.min(1.99999,n+1),m=a.indices[c.VertexAttrConstants.POSITION].length,l=e.uv0;b=f;for(var p=0;p<m;++p)l.set(b,0,g),l.set(b,1,h),b+=1,l.set(b,0,d),l.set(b,1,h),b+=1,l.set(b,0,d),l.set(b,1,n),b+=1,l.set(b,0,d),l.set(b,
1,n),b+=1,l.set(b,0,g),l.set(b,1,n),b+=1,l.set(b,0,g),l.set(b,1,h),b+=1;v.writeColor(a.indices[c.VertexAttrConstants.COLOR],a.vertexAttr[c.VertexAttrConstants.COLOR].data,4,e.color,f,6);g=a.indices[c.VertexAttrConstants.SIZE];h=a.vertexAttr[c.VertexAttrConstants.SIZE].data;d=g.length;n=e.size;b=f;for(p=0;p<d;++p)for(var m=h[2*g[p]],l=h[2*g[p]+1],r=0;6>r;++r)n.set(b,0,m),n.set(b,1,l),b+=1;a.indices[c.VertexAttrConstants.AUXPOS1]&&a.vertexAttr[c.VertexAttrConstants.AUXPOS1]&&v.writeBufferVec4(a.indices[c.VertexAttrConstants.AUXPOS1],
a.vertexAttr[c.VertexAttrConstants.AUXPOS1].data,e.auxpos1,f,6);a.indices[c.VertexAttrConstants.AUXPOS2]&&a.vertexAttr[c.VertexAttrConstants.AUXPOS2]&&v.writeBufferVec4(a.indices[c.VertexAttrConstants.AUXPOS2],a.vertexAttr[c.VertexAttrConstants.AUXPOS2].data,e.auxpos2,f,6)};return h}();return M});