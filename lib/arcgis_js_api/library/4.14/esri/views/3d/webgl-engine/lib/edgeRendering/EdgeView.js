// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/arrayUtils ../../../../../core/mathUtils ../../../../../core/promiseUtils ../../../../../core/typedArrayUtil ../../../../../core/workers ../../../../../core/libs/gl-matrix-2/mat3 ../../../../../core/libs/gl-matrix-2/mat3f64 ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../support/buffer/utils ../../core/shaderLibrary/attributes/VertexPosition.glsl ../../core/util/TwoVectorPosition ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ../PreinterleavedGeometryData ../TextureBackedBuffer/BufferManager ./bufferLayouts ./edgeBufferWriters ./EdgeProcessingWorker ./EdgeRenderer ./strokes ./util ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject".split(" "),
function(I,J,ea,p,z,R,K,D,S,T,E,L,U,M,A,F,V,W,X,Y,Z,aa,N,O,ba,w,P,ca,x,da,u,H,Q){Object.defineProperty(J,"__esModule",{value:!0});I=function(){function d(a,c,b){this.rctx=a;this.techniqueRepository=c;this.callbacks=b;this.profilingCallback=null;this.perObjectData=new Map;this.renderers=new Map;this.localOrigins=new aa.LocalOriginManager(new Y);this.gpuMemoryUsage=this.numberOfRenderedEdges=0;this.worker=new ca;this.workerThread=null;this.destroyed=!1;this.tmpModelPosition=F.vec3f64.create();this.tmpCameraPosition=
F.vec3f64.create();this.componentColorManager=new ba.BufferManager(this.rctx,2)}d.prototype.initialize=function(){var a=this;T.open("EdgeProcessingWorker").then(function(b){a.destroyed?b.close():a.workerThread=b});for(var c=w.VertexLayout.createBuffer(4),b=0;4>b;b++)c.sideness.set(b,0,0===b||3===b?0:1),c.sideness.set(b,1,0===b||1===b?0:1);this.verticesBufferObject=H.createVertex(this.rctx,35044,c.buffer)};d.prototype.destroy=function(){this.destroyed||(this.workerThread&&(this.workerThread.close(),
this.workerThread=null),this.verticesBufferObject&&(this.verticesBufferObject.dispose(),this.verticesBufferObject=null),this.destroyed=!0)};d.prototype.getUsedMemory=function(){return this.gpuMemoryUsage};Object.defineProperty(d.prototype,"numberOfRenderedPrimitives",{get:function(){return this.numberOfRenderedEdges},enumerable:!0,configurable:!0});d.prototype.shouldRender=function(){return 0<this.renderers.size};d.prototype.addComponentObject=function(a,c,b,f,e,k,q,d){return p(this,void 0,void 0,
function(){var g,h,l;return z(this,function(n){switch(n.label){case 0:if(this.hasObject(a))return[2];g=[];l={loaded:D.create(function(a){return h=a}),renderables:[],center:b};this.perObjectData.set(a,l);g.push(this.addComponentGeometry(c,l,f,e,k,q,d));return[4,D.all(g)];case 1:return n.sent(),this.callbacks.setNeedsRender(),h(),[2]}})})};d.prototype.addObject=function(a,c,b,f,e){return p(this,void 0,void 0,function(){var k,q,d,g,h,l,n;return z(this,function(m){switch(m.label){case 0:if(this.hasObject(a))return[2];
k=[];d={loaded:D.create(function(a){return q=a}),renderables:[]};this.perObjectData.set(a,d);if(e&&e.mergeGeometries&&1<a.geometries.length&&this.canMergeGeometries(a))k.push(this.addObjectMergedGeometries(a,d,c,b));else for(g=0;g<a.geometries.length;g++)if(h=a.geometries[g],l=a.geometryRecords[g],n=l.material,n.supportsEdges){if(h.data instanceof O)throw Error("Deprecated");k.push(this.addGeometryNonPreinterleaved(a,d,h.data,l,c[0],b,f))}return[4,D.all(k)];case 1:return m.sent(),this.callbacks.setNeedsRender(),
q(),[2]}})})};d.prototype.hasObject=function(a){return this.perObjectData.has(a)};d.prototype.updateAllComponentOpacities=function(a,c){return p(this,void 0,void 0,function(){var b,f,e=this;return z(this,function(k){switch(k.label){case 0:return b=c instanceof Array?function(a){return c[a]}:function(){return c},[4,this.getObjectEntry(a)];case 1:return f=k.sent(),f.renderables.forEach(function(a){for(var c=a.components.meta.length,f=0;f<c;f++){var k=b(f),d=a.components.meta[f],n=d.index;d.material.opacity=
k;a.components.buffer.textureBuffer.setDataElement(n,1,3,255*k)}e.updateTransparency(a)}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.updateAllComponentMaterials=function(a,c,b,f){return p(this,void 0,void 0,function(){var e,k,d,r,g,h=this;return z(this,function(l){switch(l.label){case 0:return e=a instanceof N,k=!!b.slicePlaneEnabled,d=u.determineRendererType(c),r=x.EdgeRenderer.getKey(d,k,e),[4,this.getObjectEntry(a)];case 1:return g=l.sent(),g.renderables.forEach(function(b){if(r!==b.rendererKey){var e=
h.renderers.get(b.rendererKey),g=h.acquireRenderer(d,k,a instanceof N);e.removeRenderable(b);e.refCount.decrement();b.rendererKey=r;g.addRenderable(b)}for(e=0;e<c.length;e++)b.components.meta[e].material=c[e];f&&h.updateComponentBuffer(b.components);h.updateTransparency(b)}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.updateObjectVisibility=function(a,c){return p(this,void 0,void 0,function(){var b;return z(this,function(f){switch(f.label){case 0:return[4,this.getObjectEntry(a)];case 1:return b=
f.sent(),b.renderables.forEach(function(a){a.visible=c}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.removeObject=function(a){var c=this,b=this.perObjectData.get(a);b&&(this.perObjectData.delete(a),b.loaded.then(function(){b.renderables.forEach(function(a){c.removeRenderable(a)});c.callbacks.setNeedsRender()}))};d.prototype.getObjectEntry=function(a){return p(this,void 0,void 0,function(){var c;return z(this,function(b){switch(b.label){case 0:c=this.perObjectData.get(a);if(!c)throw"no object";
return[4,c.loaded];case 1:return b.sent(),[2,c]}})})};d.prototype.removeAll=function(){var a=this;this.perObjectData.forEach(function(c,b){a.removeObject(b)})};d.prototype.render=function(a,c){var b=this;this.localOrigins.updateViewMatrices(a.view);var f=a.viewInvTransp,e=F.vec3f64.create(),k=new X.TwoVectorPosition,d=new W.VertexPosition.ViewProjectionTransform,r=L.mat3f64.create();A.vec3.set(e,f[3],f[7],f[11]);k.set(e);A.vec3.copy(d.worldFromView_TH,k.high);A.vec3.copy(d.worldFromView_TL,k.low);
E.mat3.fromMat4(d.viewFromCameraRelative_RS,a.view);U.mat4.copy(d.projFromView,a.proj);f=L.mat3f64.create();E.mat3.transpose(f,d.viewFromCameraRelative_RS);E.mat3.invert(r,f);this.renderers.forEach(function(a){0===a.refCount.value&&(b.renderers.delete(a.key),a.dispose())});this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();var g=0,h=0;this.renderers.forEach(function(a){return a.forEachRenderable(function(a){g+=a.statistics.averageEdgeLength;h++},c)});if(0!==h){var f=
a.view,e=40*g/h,k=u.estimateLengthAtDistance(a.viewport[3],a.fovY,1,3.5*a.pixelRatio),l={distanceFalloffFactor:e,minimumEdgeLength:k,transparency:c,viewProjectionTransform:d,transformNormal_ViewFromGlobal:r};this.updateObjectCameraDistances(a);this.numberOfRenderedEdges=0;this.renderers.forEach(function(c){b.renderRegularEdges(c,a,l);b.renderSilhouetteEdges(c,a,l)});a.view=f}};d.prototype.updateTransparency=function(a){var c=u.determineEdgeTransparency(a.components.meta),b=u.determineObjectTransparency(a.components.meta);
if(c!==a.edgeTransparency||b!==a.objectTransparency)a.edgeTransparency=c,a.objectTransparency=b,this.renderers.get(a.rendererKey).setRenderablesDirty()};d.prototype.computeModelTransformWithLocalOrigin=function(a,c,b){a.getCombinedStaticTransformation(c,b);c.origin?this.localOrigins.register(c.origin):(a=A.vec3.set(this.tmpModelPosition,b[12],b[13],b[14]),c.origin=this.localOrigins.acquire(a));Z.applyToModelMatrix(c.origin.vec3,b);return b};d.prototype.updateComponentBuffer=function(a){var c=a.meta;
a=a.buffer;for(var b=0;b<c.length;b++){var f=c[b].material,e=c[b].index,d=K.clamp(Math.round(f.size*x.LINE_WIDTH_FRACTION_FACTOR),0,255),q=K.clamp(f.extensionLength,-x.EXTENSION_LENGTH_OFFSET,255-x.EXTENSION_LENGTH_OFFSET)+x.EXTENSION_LENGTH_OFFSET,r="solid"===f.type?0:1,g=255*f.opacity,f=f.color;a.textureBuffer.setData(e,0,255*f[0],255*f[1],255*f[2],255*f[3]);a.textureBuffer.setData(e,1,d,q,r,g)}};d.prototype.createComponentBuffers=function(a){for(var c=[],b=this.componentColorManager.getBuffer(a.length),
f=0;f<a.length;f++){var e=a[f],d=b.acquireIndex();c.push({index:d,material:e})}a={meta:c,buffer:b};this.updateComponentBuffer(a);return a};d.prototype.extractEdges=function(a,c,b,f,e){return this.worker.process({data:c,originalIndices:e,writerSettings:a,skipDeduplicate:b},f?null:this.workerThread)};d.prototype.createEdgeResources=function(a){var c={};if(0<a.regular.lodInfo.lengths.length){var b=new Q(this.rctx,w.EdgeShaderAttributeLocations,{vertices:w.glVertexLayout,instances:P.RegularEdgeBufferWriter.glLayout},
{vertices:this.verticesBufferObject,instances:H.createVertex(this.rctx,35044,a.regular.instancesData.buffer)});c.regular={vao:b,lod:a.regular.lodInfo}}0<a.silhouette.lodInfo.lengths.length&&(b=new Q(this.rctx,w.EdgeShaderAttributeLocations,{vertices:w.glVertexLayout,instances:P.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:H.createVertex(this.rctx,35044,a.silhouette.instancesData.buffer)}),c.silhouette={vao:b,lod:a.silhouette.lodInfo});return c};d.prototype.disposeEdgeResources=
function(a){a.regular&&(a.regular.vao.vertexBuffers.instances.dispose(),a.regular.vao.dispose(!1),a.regular.vao=null);a.silhouette&&(a.silhouette.vao.vertexBuffers.instances.dispose(),a.silhouette.vao.dispose(!1),a.silhouette.vao=null)};d.prototype.addGeometryNonPreinterleaved=function(a,c,b,f,e,d,q){return p(this,void 0,void 0,function(){var k,g,h,l;return z(this,function(n){k=b.getAttribute("position");g=this.computeModelTransformWithLocalOrigin(a,f,M.mat4f64.create());h=f.origin;l={position:k,
indices:b.getIndices("position"),modelTransform:g,origin:h};return[2,this.addNonPreinterleaved(c,l,e,d,q)]})})};d.prototype.addNonPreinterleaved=function(a,c,b,f,e){void 0===e&&(e=!1);return p(this,void 0,void 0,function(){var d,q,r,g,h,l,n,m,G,v,C,y,t,B,p;return z(this,function(k){switch(k.label){case 0:d=this.acquireRenderer(b.type,f.slicePlaneEnabled||!1);q=c.modelTransform;r=c.origin;g=c.indices;h=c.position;l=h.data.length/h.strideIdx;n=w.EdgeInputBufferLayout.createBuffer(l);for(m=0;m<l;m++)n.position.set(m,
0,h.data[h.offsetIdx+m*h.strideIdx+0]),n.position.set(m,1,h.data[h.offsetIdx+m*h.strideIdx+1]),n.position.set(m,2,h.data[h.offsetIdx+m*h.strideIdx+2]);G=this.createComponentBuffers([b]);u.fillComponenBufferIndices(G.meta,[0,n.componentIndex.count],n.componentIndex);return[4,this.extractEdges(d.writerSettings,n,!1,e,g)];case 1:return v=k.sent(),C=this.createEdgeResources(v),y=C.regular,t=C.silhouette,B=(y?y.vao.size:0)+(t?t.vao.size:0),p={regular:y,silhouette:t,transform:{modelMatrix:q,origin:r},statistics:{gpuMemoryUsage:B,
averageEdgeLength:v.averageEdgeLength},components:G,visible:!0,edgeTransparency:u.determineEdgeTransparency(G.meta),objectTransparency:u.determineObjectTransparency(G.meta),distanceToCamera:0,rendererKey:d.key},a.renderables.push(p),d.addRenderable(p),this.gpuMemoryUsage+=B,[2]}})})};d.prototype.addComponentGeometry=function(a,c,b,f,e,d,q){return p(this,void 0,void 0,function(){var k,g,h,l,n,m,p,v,C,y,t;return z(this,function(r){switch(r.label){case 0:return k=u.determineRendererType(d),g=this.acquireRenderer(k,
q.slicePlaneEnabled||!1,!1),h=w.EdgeInputBufferLayout.createBuffer(b.count),V.vec3.copy(h.position,b),l=this.createComponentBuffers(d),u.fillComponenBufferIndices(l.meta,e,h.componentIndex,f),n=g.writerSettings,[4,this.extractEdges(n,h,!0,!1,f)];case 1:return m=r.sent(),p=this.createEdgeResources(m),v=p.regular,C=p.silhouette,y=(v?v.vao.size:0)+(C?C.vao.size:0),t={regular:v,silhouette:C,transform:a,statistics:{gpuMemoryUsage:y,averageEdgeLength:m.averageEdgeLength},components:l,visible:!0,edgeTransparency:u.determineEdgeTransparency(l.meta),
objectTransparency:u.determineObjectTransparency(l.meta),distanceToCamera:0,rendererKey:g.key},c.renderables.push(t),g.addRenderable(t),this.gpuMemoryUsage+=y,[2]}})})};d.prototype.canMergeGeometries=function(a){for(var c=null,b=null,f=0;f<a.geometries.length;f++){var e=a.geometryRecords[f];if(e.material.supportsEdges){if(a.geometries[f].data instanceof O)return!1;if(!c)c=e.transformation;else if(!R.equals(c,e.transformation))return!1;if(!b&&e.origin)b=e;else if(b&&e.origin&&b.origin.id!==e.origin.id)return!1}}return!0};
d.prototype.addObjectMergedGeometries=function(a,c,b,f){return p(this,void 0,void 0,function(){var e,d,q,r,g,h,l,n,m,p,v,u,y,t,B,w,x,A,D,E,F;return z(this,function(k){switch(k.label){case 0:e=new Map;d=0;r=q=null;for(g=0;g<a.geometries.length;g++)if(h=a.geometries[g],l=a.geometryRecords[g],n=l.material,n.supportsEdges&&(!r&&l.origin&&(r=l),m=h.data.getIndices("position"),d+=m?m.length:0,m&&null==q||q===Uint16Array))q=S.isUint16Array(m)?Uint16Array:Uint32Array;p=d?new q(d):null;v=[];for(g=u=0;g<a.geometries.length;g++)if(h=
a.geometries[g],y=a.geometryRecords[g],n=y.material,n.supportsEdges){t=h.data.getAttribute("position");m=h.data.getIndices("position");B=e.get(t.data);if(null==B){B=v.length/3;for(w=t.offsetIdx;w<t.data.length;w+=t.strideIdx)v.push(t.data[w+0]),v.push(t.data[w+1]),v.push(t.data[w+2]);e.set(t.data,B)}if(m)for(x=0;x<m.length;x++)p[u++]=B+m[x]}A=r||a.geometryRecords[0];D=this.computeModelTransformWithLocalOrigin(a,A,M.mat4f64.create());E=A.origin;for(g=0;g<a.geometryRecords.length;g++)a.geometryRecords[g].origin=
E;F={position:{data:v,offsetIdx:0,strideIdx:3},indices:p,modelTransform:D,origin:E};return[4,this.addNonPreinterleaved(c,F,b[0],f)];case 1:return k.sent(),[2]}})})};d.prototype.acquireRenderer=function(a,c,b){void 0===b&&(b=!0);var d=x.EdgeRenderer.getKey(a,c,b),e=this.renderers.get(d);this.strokesTexture||(this.strokesTexture=da.generateStrokesTexture(this.rctx));e||(e=new x.EdgeRenderer(this.rctx,this.techniqueRepository,{type:a,slicePlaneEnabled:c,strokesTexture:this.strokesTexture,legacy:b}),
this.renderers.set(d,e));e.refCount.increment();return e};d.prototype.removeRenderable=function(a){var c=this.renderers.get(a.rendererKey);c.removeRenderable(a);c.refCount.decrement();this.disposeEdgeResources(a);"origin"in a.transform&&this.localOrigins.release(a.transform.origin);this.gpuMemoryUsage-=a.statistics.gpuMemoryUsage;for(var c=0,b=a.components.meta;c<b.length;c++)a.components.buffer.releaseIndex(b[c].index)};d.prototype.updateObjectCameraDistances=function(a){var c=this;a=a.viewInvTransp;
A.vec3.set(this.tmpCameraPosition,a[3],a[7],a[11]);this.perObjectData.forEach(function(a,d){d="getCenter"in d?d.getCenter():a.center;var b=A.vec3.distance(d,c.tmpCameraPosition);a.renderables.forEach(function(a){return a.distanceToCamera=b})})};d.prototype.renderRegularEdges=function(a,c,b){var d=this;a.bindRegularEdges(c,b);a.forEachRenderable(function(e){if(e.visible&&e.regular){var f=u.computeEdgeCount(e.regular.lod.lengths,e.distanceToCamera,b);"origin"in e.transform&&(c.view=d.localOrigins.getViewMatrix(e.transform.origin));
a.renderRegularEdges(e,c,f);d.numberOfRenderedEdges+=f}},b.transparency)};d.prototype.renderSilhouetteEdges=function(a,c,b){var d=this;a.bindSilhouetteEdges(c,b);a.forEachRenderable(function(e){if(e.visible&&e.silhouette){var f=u.computeEdgeCount(e.silhouette.lod.lengths,e.distanceToCamera,b);"origin"in e.transform&&(c.view=d.localOrigins.getViewMatrix(e.transform.origin));a.renderSilhouetteEdges(e,c,f);d.numberOfRenderedEdges+=f}},b.transparency)};return d}();J.EdgeView=I});