// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/assignHelper ../../../core/tsSupport/decorateHelper ../../../Color ../../../core/Accessor ../../../core/maybe ../../../core/ObjectPool ../../../core/PooledArray ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingBox ../support/imageUtils ../support/buffer/BufferView ./PatchGeometryFactory ./PatchRenderData ./TileRenderer ./TileTexture ./tileUtils ../webgl-engine/core/shaderLibrary/ShaderOutputOptions ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/screenSizePerspectiveUtils ../webgl-engine/lib/tracer ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/shaders/TerrainTechnique".split(" "),
function(N,na,V,oa,t,W,X,D,O,x,u,Y,P,Z,n,p,Q,k,J,aa,ba,R,ca,da,ea,y,fa,ga,S,ha,K,F,L){function T(n,b,a){Q.vec4.set(a,n[0]*b[2]+b[0],n[1]*b[3]+b[1],n[2]*b[2],n[3]*b[3])}var M=Z.vec2f64.create(),G=J.create(),q=k.vec4f64.create(),v=k.vec4f64.create(),B=k.vec4f64.create(),ia=function(){return function(){this.extent=k.vec4f64.create();this.maxLevel=this.minLevel=0;this.callback=null}}();N=function(k){function b(a){a=k.call(this,a)||this;a.type="Terrain";a.tileSize=256;a.rctx=null;a.renderDataPool=new O(ca.PatchRenderData);
a.patchGroups=new x({allocator:function(a){return a||{root:null,origin:null,patches:new x}},deallocator:function(a){a.root=null;a.origin=null;a.patches.clear();return a}});a.patchGroupsDirty=!0;a.patchGroupsMap=new Map;a.tileIterator=new y.IteratorPreorder;a.highestVisibleLODTile=null;a.visible=!0;a._opaque=!0;a._skirtScale=1;a._renderingDisabled=!1;a._renderOrder=1;a._velvetOverground=!0;a._wireframe=!1;a.castShadows=!0;a.emptyTex=null;a.tileRenderer=null;a.tileBackgroundInitialized=!1;a.tileBackgroundUpdating=
!1;a.stencilEnabledLayerExtents=[];a.numTrianglesRendered=0;a.numTilesRendered=0;a.numTilesCulled=0;a.numOriginsRendered=0;a.clippingExtent=null;a.needsHighlight=!1;a.visibleScaleRangeQueries=new x({initialSize:10});a.visibleScaleRangeQueriesInvPtr=0;a.visibleScaleRangeQueryQueue=new x({initialSize:30});a.visibleScaleRangeQueryPool=new O(ia,!1);return a}V(b,k);b.prototype.destroy=function(){R.clearCaches()};b.prototype.install=function(a){a.addRenderPlugin([3,8],this)};b.prototype.uninstall=function(a){a.removeRenderPlugin(this)};
Object.defineProperty(b.prototype,"updating",{get:function(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"canRender",{get:function(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this._renderingDisabled},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"overlayEnabled",{get:function(){return this.shaderTechniqueConfig.overlayEnabled},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"renderingDisabled",{set:function(a){this._renderingDisabled=!!a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"opaque",{get:function(){return this._opaque&&!this.shaderTechniqueConfig.slice},set:function(a){this._opaque!==a&&(this._opaque=a,this.setNeedsRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"skirtScale",{set:function(a){this._skirtScale=a;this.setNeedsRender()},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"renderPatchBorders",{set:function(a){this.shaderTechniqueConfig.tileBorders!==a&&(this.shaderTechniqueConfig.tileBorders=a,this._updateAllProgramsAndPipelines())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"cullBackFaces",{set:function(a){this.shaderTechniqueConfig.backfaceCullingEnabled!==a&&(this.shaderTechniqueConfig.backfaceCullingEnabled=a,this._updateAllProgramsAndPipelines(),this.setNeedsRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"renderOrder",{get:function(){return this._renderOrder},set:function(a){this._renderOrder=a;this.setNeedsRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"velvetOverground",{set:function(a){this._velvetOverground!==a&&(this._velvetOverground=a,this._updateAllProgramsAndPipelines())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"intersectionHandlerId",{get:function(){return S.TERRAIN_ID},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"slicePlane",{get:function(){return this.shaderTechniqueConfig.slice},set:function(a){this.shaderTechniqueConfig.slice!==a&&(this.shaderTechniqueConfig.slice=a,this._updateAllProgramsAndPipelines())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"blendingEnabled",{set:function(a){this.shaderTechniqueConfig.blendingEnabled!==a&&(this.shaderTechniqueConfig.blendingEnabled=a,this._updateAllProgramsAndPipelines())},enumerable:!0,configurable:!0});b.prototype.setDebugScreenSizePerspective=
function(a){this.shaderTechniqueConfig.screenSizePerspective!==a&&(this.shaderTechniqueConfig.screenSizePerspective=a,this._updateAllProgramsAndPipelines())};b.prototype.setRootTiles=function(a){this.rootTiles=a;this.setNeedsRender()};b.prototype.setNeedsHighlight=function(a){this.needsHighlight=a;this.setNeedsRender()};b.prototype.setStencilEnabledLayerExtents=function(a){this.stencilEnabledLayerExtents=a;this.setNeedsRender()};b.prototype.setTileSize=function(a){this.tileSize=a;this.tileRenderer&&
(this.tileRenderer.tileSize=a);this.setNeedsRender()};b.prototype.loadTile=function(a){a.renderData||(a.renderData=this.renderDataPool.acquire(),a.renderData.init(a),a.renderData.localOrigin=this._getLocalOriginOfTile(a));this.updateTileGeometry(a);this.updateTileTexture(a)};b.prototype.queryVisibleLevelRange=function(a,c,b,f){var e=this.visibleScaleRangeQueryPool.acquire();Q.vec4.copy(e.extent,a);e.minLevel=c?c:-Number.MAX_VALUE;e.maxLevel=null!=b?b:Number.MAX_VALUE;e.callback=f;this.visibleScaleRangeQueryQueue.push(e);
this.setNeedsRender()};b.prototype.updateTileTexture=function(a){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(a),a.resetPendingUpdate(32))};b.prototype.updateTileGeometry=function(a){for(var c=0,b=a.layerInfo[0];c<b.length;c++)b[c].pendingUpdates&=-17;a.resetPendingUpdate(16);a.renderData.updateGeometry(this.rctx,this._wireframe)&&this.setNeedsRender()};b.prototype.unloadTile=function(a){a.renderData&&(a.renderData.releaseTexture(),this.releaseTileGeometry(a.renderData),
a.renderData=null,a.setMemoryDirty(),this.setNeedsRender())};b.prototype._getLocalOriginOfTile=function(a){var c=Math.max(0,7*Math.floor((a.lij[0]-3)/7));if("spherical"===this.manifold&&0===c)return p.vec3f64.ZEROS;for(;a.parent&&a.lij[0]>c;)a=a.parent;return a.centerAtSeaLevel};b.prototype.setVisibility=function(a){this.visible=a;this.setNeedsRender()};b.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,
numOriginsRendered:this.numOriginsRendered}};b.prototype.setWireframe=function(a){var c=this;this._wireframe!==a&&(this._wireframe=a,this.rootTiles&&(y.traverseTilesPreorder(this.rootTiles,function(b){b.renderData&&b.renderData.updateGeometry(c.rctx,a)}),this.setNeedsRender()))};b.prototype.setNeedsRender=function(a){void 0===a&&(a=1);this.patchGroupsDirty=!0;this.initContext.requestRender(a)};b.prototype.setTileBackground=function(a){this.tileBackground=a;this._updateTileBackground()};b.prototype.initializeRenderContext=
function(a){var c=this;this.initContext=a;this.rctx=a.rctx;this.shaderTechniques=a.shaderTechniqueRep;this.shaderTechniqueConfig=new L.TerrainTechniqueConfiguration;this._updateAllProgramsAndPipelines();this.shaderTechniques=a.shaderTechniqueRep;this.tileRenderer=new da(this.rctx,this.tileSize,this.shaderTechniques,function(){return c.setNeedsRender()});this.tileBackground&&this._updateTileBackground();this.emptyTex=new ea.TileTexture(ga.createEmptyTexture(this.rctx))};b.prototype.uninitializeRenderContext=
function(){null!=this.emptyTex&&(this.emptyTex.release(),this.emptyTex=null);this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)};b.prototype.intersect=function(a,c,b,f){if(this.rootTiles&&(!a.options.selectOpaqueTerrainOnly||!a.options.selectionMode||this._opaque)){var e=ja,d=ka;n.vec3.subtract(e,f,b);n.vec3.set(d,1/e[0],1/e[1],1/e[2]);var w=a.results.min,l=a.results.max,m=a.results.terrain,u=0===a.options.store,r=null,p=this.clippingExtent,h=this.tileIterator;h.reset(this.rootTiles);
for(var E=D.isSome(a.options.verticalOffset)?a.options.verticalOffset.terrain:null,k=function(){var g=h.next();if(null===g.renderData)return"continue";if(a.options.invisibleTerrain){if(!g.visible&&p&&!g.intersectsExtent(p))return"continue"}else if(!g.visible)return"continue";var k=g.renderData.geometryInfo,z=g.renderData.localOrigin,A=-t._skirtScale*k.skirtLength;J.set(G,k.boundingBox);D.isSome(E)&&(E.localOrigin=z,E.applyToAABB(G));if(0!==A){var C=g.up;J.expandWithOffset(G,A*C[0],A*C[1],A*C[2])}n.vec3.subtract(H,
b,z);if(!F.intersectAabbInvDirBefore(G,H,d,a.tolerance,u&&null!=w.dist?w.dist:Infinity))return"continue";var q=function(a,c,b,e){a.set(void 0,y.tile2str(c),b,e,P.mat4f64.IDENTITY,void 0);a.intersector=la;a.target={type:"external",metadata:{tile:c}}},C=function(d,h){0<=d&&(a.options.backfacesTerrain||0>n.vec3.dot(h,e))&&(a.options.invisibleTerrain||!a.options.selectionMode||null==c||c(b,f,d))&&((null==m.dist||d<m.dist)&&q(m,g,d,h),a.options.storeTerrainResults&&(2===a.options.store&&(D.isNone(r)?(r=
new S.IntersectorResult(a.ray),q(r,g,d,h),a.results.all.push(r)):d<r.dist&&q(r,g,d,h)),(null==w.dist||d<w.dist)&&q(w,g,d,h),0!==a.options.store&&(null==l.dist||d>l.dist)&&q(l,g,d,h)))},v=ma;n.vec3.subtract(v,f,z);var z=k.indices,x=k.vertexAttributes,B={data:x.getField("position",ba.BufferViewVec3f).typedBuffer,size:3,offsetIdx:0,strideIdx:x.stride/4},k=k.numWithoutSkirtIndices/3;F.intersectTriangles(H,v,0,k,z,B,null,E,C);0!==A&&R.intersectSkirts(H,v,k,z.length/3,z,x,"spherical"===t.manifold?function(a){return n.vec3.scale(a,
a,A/n.vec3.length(a))}:function(a){return n.vec3.set(a,0,0,A)},E,C)},t=this;!h.done;)k()}};b.prototype.render=function(a){if(a.slot!==(this.opaque?3:8))return!1;K.trace("# BEGIN RENDER TERRAIN");var c=a.pass,b=1===a.scenelightingData.globalFactor,f=this._updatePatchGroups();m.overlayEnabled=!1;m.used=!0;switch(c){case 0:m.overlayEnabled=!0;m.used=!1;c=a.shadowMap&&a.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==c&&(this.shaderTechniqueConfig.receiveShadows=c,this._updateAllProgramsAndPipelines());
c=!this.overlayRenderer.isEmpty();this.shaderTechniqueConfig.overlayEnabled!==c&&(this.shaderTechniqueConfig.overlayEnabled=c,this._updateAllProgramsAndPipelines());this._renderMaterialPass(a,0,f,m);break;case 3:this.castShadows&&b&&this._renderAuxiliaryPass(a,3,f,m);break;case 1:this._renderAuxiliaryPass(a,1,f,m);break;case 2:this._renderAuxiliaryPass(a,2,f,m);break;case 4:this.needsHighlight&&(m.overlayEnabled=!0,this._renderAuxiliaryPass(a,4,f,m),a.rctx.clearSafe(256))}K.trace("# END RENDER TERRAIN");
0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender();return!0};b.prototype._renderMaterialPass=function(a,c,b,f){var e=this,d=a.rctx,w=a.camera;this._setTerrainTechnique(c);var l=this.shaderTechnique.program;a.rctx.bindProgram(l);d.bindProgram(l);a.shadowMap&&a.shadowMap.bind(l);a.ssaoHelper&&a.ssaoHelper.setUniforms(l);l.setUniform1i("tex",0);l.setUniform1i("texOld",1);this._bindOverlayUniforms(l);l.setUniformMatrix4fv("viewNormal",w.viewInverseTransposeMatrix);l.setUniformMatrix4fv("proj",
w.projectionMatrix);a.scenelightingData.setUniforms(l,!0);c=w.viewMatrix;n.vec3.set(I,c[12],c[13],c[14]);n.vec3.normalize(I,I);l.setUniform3fv("viewDirection",I);this.numOriginsRendered=this.numTrianglesRendered=this.numTilesCulled=this.numTilesRendered=0;this._prepareScaleRangeQueries();this.opaque?this._renderPatchGroups(a,l,b,f):a.offscreenRenderingHelper.renderToTargets(function(){return e._renderPatchGroups(a,l,b,f)},a.offscreenRenderingHelper.tmpColor,a.offscreenRenderingHelper.mainDepth,[0,
0,0,0]);this._processScaleRangeQueries()};b.prototype._renderAuxiliaryPass=function(a,c,b,f){this._setTerrainTechnique(c);c=this.shaderTechnique.program;a.rctx.bindProgram(c);if(4===a.pass){var e=a.offscreenRenderingHelper;a.rctx.bindTexture(e.depthTexture,6);c.setUniform1i("depthTex",6);c.setUniform4f("highlightViewportPixelSz",0,0,1/e.width,1/e.height)}else if(c.setUniformMatrix4fv("viewNormal",a.camera.viewInverseTransposeMatrix),1===a.pass||3===a.pass)M[0]=a.camera.near,M[1]=a.camera.far,c.setUniform2fv("nearFar",
M);this._renderPatchGroupsAuxiliary(a,c,b,f)};b.prototype._updateTileBackground=function(){var a=this;if(this.tileRenderer){this.tileBackgroundUpdating=!0;var c=function(){a.tileBackgroundInitialized=!0;a.tileBackgroundUpdating=!1;a.rootTiles&&y.traverseTilesPreorder(a.rootTiles,function(c){return a.tileRenderer.updateTileTexture(c)});a.setNeedsRender()};if("string"===typeof this.tileBackground){var b=this.tileBackground;aa.requestImage(b).then(function(e){b===a.tileBackground&&a.tileRenderer&&(a.tileRenderer.setBackground(e),
c())})}else{var f=this.tileBackground?W.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(f);c()}}};b.prototype._updatePatchGroups=function(){var a=this,c=this.patchGroups;if(!this.patchGroupsDirty)return c;this.highestVisibleLODTile=null;this._renderCollectOrigins(c);if(0!==this.renderOrder){for(var b=0;b<c.length;b++)y.sortTiles(this.renderOrder,c.data[b].patches);c.sort(function(c,b){var e=a.renderOrder;c=0===c.patches.length?-e:0===b.patches.length?e:y.compareTiles(c.patches.data[0],
b.patches.data[0],e);return c})}this.patchGroupsDirty=!1;return c};b.prototype._renderCollectOrigins=function(a){var c=this.rootTiles,b="spherical"===this.manifold;a.clear();for(var f=0;f<c.length;f++){var g=c[f],d=a.pushNew();d.root=g;d.origin=b?p.vec3f64.ZEROS:g.centerAtSeaLevel;d.patches.clear();this._renderCollectOriginsForRoot(a,d)}a.filterInPlace(function(a){return 0<a.patches.length})};b.prototype._renderCollectOriginsForRoot=function(a,c){var b=this.tileIterator;b.resetOne(c.root);var f=this.patchGroupsMap;
f.clear();for(f.set(c.origin,c);!b.done;){c=b.next();var g=c.renderData;if(g&&!c.visible)this.numTilesCulled++,b.skipSubtree();else{if(0===c.lij[0]%7){var d=a.pushNew();d.root=c;d.origin=c.centerAtSeaLevel;f.set(c.centerAtSeaLevel,d);d.patches.clear()}if(!c.rendered)this.numTilesCulled++;else if(g){(d=f.get(g.localOrigin))&&d.patches.push(c);if(!this.highestVisibleLODTile||c.vlevel>this.highestVisibleLODTile.vlevel)this.highestVisibleLODTile=c;b.skipSubtree()}}}};b.prototype._scaleQueriesForTile=
function(a){var c=a.extent;a=a.lij[0];for(var b=0;b<this.visibleScaleRangeQueriesInvPtr;){var f=this.visibleScaleRangeQueries.data[b],g=f.extent;a>=f.minLevel&&a<=f.maxLevel&&g[0]<=c[2]&&g[2]>=c[0]&&g[1]<=c[3]&&g[3]>=c[1]?(this.visibleScaleRangeQueries.swapElements(b,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):b++}};b.prototype._tileIntersectsStencilEnabledLayer=function(a){for(var c=0,b=this.stencilEnabledLayerExtents;c<b.length;c++)if(a.intersectsExtent(b[c]))return!0;
return!1};b.prototype._renderPatchGroupsAuxiliary=function(a,c,b,f){this.shaderTechnique.bindPipelineState(a.rctx);var e=0<this.stencilEnabledLayerExtents.length;c.setUniformMatrix4fv("proj",a.camera.projectionMatrix);c.setUniform1f("skirtScale",this._skirtScale);f.overlayEnabled&&this._bindOverlayUniforms(c);for(var d=0;d<b.length;d++){var k=b.data[d];this._bindViewForPatchGroup(c,k,a.camera.eye,a.camera.viewMatrix);for(var l=0;l<k.patches.length;l++)this._renderPatch(a.rctx,c,k.patches.data[l],
4,e,f)}a.rctx.bindVAO(null)};b.prototype._renderPatchGroups=function(a,c,b,f){var e=a.rctx,d=a.camera,k=d.viewMatrix;this.shaderTechnique.bindPipelineState(e);if(this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){var l=ha.getSettings("spherical"===this.manifold?"global":"local");l.update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:d.fovY});F.bindScreenSizePerspective(l,c,"screenSizePerspective")}l=0<this.stencilEnabledLayerExtents.length;c.setUniform1f("skirtScale",
this._skirtScale);for(var n=this._wireframe?1:4,m=0;m<b.length;m++){var r=b.data[m],q=r.patches;if(0!==q.length){this._bindViewForPatchGroup(c,r,d.eye,k);var h=a.sliceHelper&&a.sliceHelper.plane;h&&F.bindSlicePlane(r.origin,h,c);a.shadowMap&&a.shadowMap.bindView(c,r.origin);this.numOriginsRendered++;for(r=0;r<q.length;r++)if(h=q.data[r],!D.isNone(h.renderData.textureReference)){K.trace("# RENDER TILE "+y.tile2str(h)+", screenDepth:"+h.screenDepth);T(h.renderData.geometryInfo.uvOffsetAndScale,h.renderData.texOffsetAndScale,
B);c.setUniform4fv("texOffsetAndScale",B);e.bindTexture(h.renderData.textureReference.texture,0);var p=h.renderData.oldTextureReference;if(this.shaderTechniqueConfig.blendingEnabled&&D.isSome(p)){this.setNeedsRender();var t=h.renderData.textureBlendFactor;T(h.renderData.geometryInfo.uvOffsetAndScale,h.renderData.oldTexOffsetAndScale,B);c.setUniform1f("blend",t);c.setUniform4fv("oldTexOffsetAndScale",B);e.bindTexture(p.texture,1)}else c.setUniform1f("blend",1),e.bindTexture(this.emptyTex.texture,1);
c.setUniform1f("opacity",h.renderData.opacity);p=this._renderPatch(e,c,h,n,l,f);h.renderOrder=this.numTilesRendered;this.numTilesRendered++;this.numTrianglesRendered+=p/3;this._scaleQueriesForTile(h)}}}e.bindVAO(null)};b.prototype._renderPatch=function(a,c,b,f,g,d){d.overlayEnabled&&(this._bindOverlayTextures(c,b.renderData.overlays,d.used),c.setUniform1f("overlayOpacity",b.renderData.overlayOpacity));g&&(this._tileIntersectsStencilEnabledLayer(b)?this.stencilShaderTechnique.bindPipelineState(a):
this.shaderTechnique.bindPipelineState(a));g=0===this._skirtScale?b.renderData.geometryInfo.numWithoutSkirtIndices:b.renderData.vao.indexBuffer.size;a.bindVAO(b.renderData.vao);c.assertCompatibleVertexAttributeLocations(b.renderData.vao);a.drawElements(f,g,b.renderData.vao.indexBuffer.indexType,0);return g};b.prototype._bindViewForPatchGroup=function(a,b,e,f){a.setUniform3fv("origin",b.origin);Y.mat4.translate(U,f,b.origin);a.setUniformMatrix4fv("view",U);a.setUniform3f("camPos",e[0]-b.origin[0],
e[1]-b.origin[1],e[2]-b.origin[2])};b.prototype._bindOverlayUniforms=function(a){a.setUniform1i("ovInnerColorTex",2);a.setUniform1i("ovOuterColorTex",3);a.setUniform1i("ovInnerWaterTex",4);a.setUniform1i("ovOuterWaterTex",5)};b.prototype._bindOverlayTextures=function(a,b,e){for(var c=0;2>c;c++){var g=2*c,d=b[c],k=e?d.highlightRenderTargetId:d.renderTargetId;k?(q[g]=d.texOffset[0],q[g+1]=d.texOffset[1],v[g]=d.texScale[0],v[g+1]=d.texScale[1],g=this.overlayRenderer.getRenderTargetTexture(k),this.rctx.bindTexture(g,
2+c),(d=d.waterMaskRenderTargetId)?(d=this.overlayRenderer.getRenderTargetTexture(d),this.rctx.bindTexture(d,4+c)):this.rctx.bindTexture(this.emptyTex.texture,4+c)):(q[g]=0,q[g+1]=0,v[g]=0,v[g+1]=0,this.rctx.bindTexture(this.emptyTex.texture,2+c),this.rctx.bindTexture(this.emptyTex.texture,4+c))}a.setUniform4fv("overlayTexOffset",q);a.setUniform4fv("overlayTexScale",v)};b.prototype._setTerrainTechnique=function(a){this.shaderTechniqueConfig.output=a;0===a&&(a="spherical"===this.manifold,this.shaderTechniqueConfig.overlayEnabled=
this.overlayEnabled,this.shaderTechniqueConfig.atmosphere=a&&this._velvetOverground);this.shaderTechniqueConfig.stencilEnabled=!1;this.shaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(L.TerrainTechnique,this.shaderTechniqueConfig,this.shaderTechnique);this.shaderTechniqueConfig.stencilEnabled=!0;this.stencilShaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(L.TerrainTechnique,this.shaderTechniqueConfig,this.stencilShaderTechnique)};b.prototype._updateAllProgramsAndPipelines=
function(){var a=this;fa.ShaderOutputTypes.forEach(function(b){b=b.output;0!==b&&1!==b&&3!==b&&2!==b&&4!==b||a._setTerrainTechnique(b)});this.setNeedsRender()};b.prototype.releaseTileGeometry=function(a){a.releaseGeometry()&&this.setNeedsRender();this.renderDataPool.release(a)};b.prototype._prepareScaleRangeQueries=function(){for(var a=this.visibleScaleRangeQueries,b=this.visibleScaleRangeQueryQueue;a.length<a.data.length&&0<b.length;){var e=b.pop();a.push(e)}this.visibleScaleRangeQueriesInvPtr=a.length};
b.prototype._processScaleRangeQueries=function(){for(var a=this.visibleScaleRangeQueries,b=this.visibleScaleRangeQueryPool,e=0;e<a.length;e++){var f=a.data[e];b.release(f);f.callback(e>=this.visibleScaleRangeQueriesInvPtr);f.callback=null}a.clear()};Object.defineProperty(b.prototype,"test",{get:function(){return{tileRenderer:this.tileRenderer}},enumerable:!0,configurable:!0});t([u.property()],b.prototype,"tileBackgroundInitialized",void 0);t([u.property()],b.prototype,"tileBackgroundUpdating",void 0);
t([u.property({constructOnly:!0})],b.prototype,"manifold",void 0);t([u.property({constructOnly:!0})],b.prototype,"overlayRenderer",void 0);t([u.property({readOnly:!0,dependsOn:["tileBackgroundInitialized","tileBackgroundUpdating"]})],b.prototype,"updating",null);return b=t([u.subclass("esri.views.3d.terrain.TerrainRenderer")],b)}(u.declared(X));var m={overlayEnabled:!1,used:!0},U=P.mat4f64.create(),I=p.vec3f64.create(),ja=p.vec3f64.create(),ka=p.vec3f64.create(),H=p.vec3f64.create(),ma=p.vec3f64.create(),
la="TerrainRenderer";return N});