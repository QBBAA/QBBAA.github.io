// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/iteratorUtils ../../../core/Logger ../../../core/PooledArray ../../../core/accessorSupport/decorators/declared ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4f64 ../support/debugFlags ../webgl-engine/core/shaderTechnique/CommonUniformStore ../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository ../webgl-engine/lib/AutoDisposable ../webgl-engine/lib/Camera ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/GLMaterialRep ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/RenderContext ../webgl-engine/lib/renderStats ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/TextureTechnique ../webgl-engine/lighting/Lightsources ../webgl-engine/lighting/SceneLighting ../webgl-engine/materials/ColorMaterial ../webgl-engine/materials/HUDMaterial ../webgl-engine/materials/lineStippleUtils ../webgl-engine/materials/RibbonLineMaterial ../../webgl/FramebufferObject ../../webgl/Texture ../../webgl/Util".split(" "),
function(v,h,C,w,l,D,E,F,q,r,G,x,H,I,t,J,K,L,y,M,N,O,P,Q,z,R,S,T,U,V,W,X,Y,A){Object.defineProperty(h,"__esModule",{value:!0});var u=D.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");v=function(h){function c(b){var a=h.call(this)||this;a._clearColor=G.vec4f64.fromValues(0,0,0,0);a._hasHighlights=!1;a._lighting=new S.SceneLighting;a._localOrigins=new M;a._layerRenderers=new Map;a._sortedLayerRenderersDirty=!1;a._sortedLayerRenderers=new E;a._stats=new P.RenderStatsAggregator;a._geometries=
new Map;a._renderTargets={};a._uniqueIdx=0;a.longitudeCyclical=null;a._rctx=b.renderingContext;a._renderContext=new O(a._rctx,null,null,null,null,null);a._stippleTextureRepository=new V.StippleTextureRepository;a._shaderTechniqueRepository=new I.ShaderTechniqueRepository({rctx:a._rctx,viewingMode:1,commonUniformStore:new H.CommonUniformStore,stippleTextureRepository:a._stippleTextureRepository});a._materialRepository=new L(b.textureRepository,a._shaderTechniqueRepository);a._materialRepository.onMaterialChanged=
function(){return a.emitContentChanged()};a._bindParameters={fovY:0,highlightDepthTexture:y.createEmptyDepthTexture(a._rctx),nearFar:[m.near,m.far],origin:null,pixelRatio:null,proj:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,view:null,viewInvTransp:null,viewport:null};a._lighting.set({lights:[new R.AmbientLight(r.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0});return a}C(c,h);c.prototype.dispose=function(){this._layerRenderers.forEach(function(a){return a.dispose()});
this._layerRenderers.clear();for(var b in this._renderTargets)this._renderTargets[b].dispose();this._renderTargets=null;this._bindParameters.highlightDepthTexture.dispose();this._bindParameters.highlightDepthTexture=null};c.prototype.disposeRenderTarget=function(b){var a=this._renderTargets[b];a&&a.dispose();delete this._renderTargets[b]};Object.defineProperty(c.prototype,"updating",{get:function(){return this._sortedLayerRenderersDirty||l.someMap(this._layerRenderers,function(b){return b.updating})},
enumerable:!0,configurable:!0});c.prototype.commitChanges=function(){var b=this,a=!1;this._layerRenderers.forEach(function(d,c){d.commitChanges()&&(a=!0);d.isEmpty&&(b._layerRenderers.delete(c),b._sortedLayerRenderersDirty=!0)});this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),a=!0);this.emitUpdatingChanged();if(a){this.emitContentChanged();var d=l.someMap(this._layerRenderers,function(a){return a.hasHighlights});d!==this._hasHighlights&&(this._hasHighlights=d,this.emitHasHighlightsChanged())}};
c.prototype.getRenderTargetTexture=function(b){return(b=this._renderTargets[b])?b.colorTexture:null};c.prototype.addGeometries=function(b,a){for(var d=0;d<b.length;d++){var e=b[d];null==e.origin&&(e.origin=this._localOrigins.getOrigin(e.center));e.idx=this._uniqueIdx++;this._geometries.set(e.uniqueName,e)}this.ensureLayerRenderer(a).add(b)};c.prototype.removeGeometries=function(b,a){for(var d=0;d<b.length;d++)this._geometries.delete(b[d].uniqueName);(a=this._layerRenderers.get(a))?a.remove(b):u.warn("Attempted to remove geometry for nonexistent layer")};
c.prototype.updateGeometries=function(b,a,d){(a=this._layerRenderers.get(a))?a.modify(b,d):u.warn("Attempted to update geometry for nonexistent layer")};c.prototype.updateHighlights=function(b,a){(a=this._layerRenderers.get(a))?a.modify(b,16):u.warn("Attempted to update highlights for nonexistent layer")};c.prototype.isEmpty=function(){return 0===this._geometries.size&&!x.OVERLAY_DRAW_DEBUG_TEXTURE};Object.defineProperty(c.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"hasWater",{get:function(){return l.someMap(this._layerRenderers,function(b){return b.hasWater})},enumerable:!0,configurable:!0});c.prototype.updateLogic=function(b){var a=!1;this._layerRenderers.forEach(function(d){d.updateLogic(b)&&(a=!0)});return a};c.prototype.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0};c.prototype.draw=function(b,a){return this.drawPass(0,b,a)};c.prototype.drawNormals=function(b,a){return this.drawPass(2,
b,a)};c.prototype.drawHighlights=function(b,a){return this.drawPass(4,b,a)};c.prototype.drawPass=function(b,a,d){var e=this;if(0===d.numViews)return!1;this._pixelRatio=d.pixelRatio*Math.abs(d.views[0].extent[2]-d.views[0].extent[0])/Math.abs(d.views[0].viewport[2]-d.views[0].viewport[0]);if(this.isEmpty()||4===b&&!this.hasHighlights||2===b&&!this.hasWater||!this.hasNonZeroSizedView(d))return!1;var c=d.width,f=d.height;a=this._renderTargets[a];if(!a)return!1;a.resize(c,f);var g=this._rctx,k=m;k.pixelRatio=
d.pixelRatio||1;this._renderContext.pass=b;this._bindParameters.pixelRatio=k.pixelRatio;g.bindFramebuffer(a);g.setClearColor.apply(g,this._clearColor);g.clearSafe(16384);this.updateLightingUniforms();if(x.OVERLAY_DRAW_DEBUG_TEXTURE)for(b=0;b<d.numViews;b++)this.setViewParameters(d.views[b],k),this.drawDebugTexture(c,f,B[d.index%B.length]);0<this._layerRenderers.size&&this._sortedLayerRenderers.forEach(function(a){for(var b=0;b<d.numViews;b++)e.setViewParameters(d.views[b],k),a.draw(e._renderContext,
e._bindParameters,e._stats)});g.bindFramebuffer(null);a.colorTexture.descriptor.hasMipmap&&a.colorTexture.generateMipmap();return!0};c.prototype.createRenderTarget=function(b,a,d,e){for(var c=b,f=0;this._renderTargets[c];)c=b+"_"+ ++f;this._renderTargets[c]=new X(this._rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:e,hasMipmap:a,maxAnisotropy:d,width:0,height:0});return c};c.prototype.getGpuMemoryUsage=function(){var b=0,a;for(a in this._renderTargets)b+=
A.getGpuMemoryUsage(this._renderTargets[a]);return b};c.prototype.getStats=function(){return this._stats.getAggregatedStats()};c.prototype.intersect=function(b,a,d){var e=this,c=0;this._geometries.forEach(function(f){if(!d||d(f)){if(f.material instanceof T||f.material instanceof W||f.material instanceof U){e.intersectRenderGeometry(f,a,0,b,c);var g=e.longitudeCyclical;g&&(f.center[0]-f.bsRadius<g.min&&e.intersectRenderGeometry(f,a,g.range,b,c),f.center[0]+f.bsRadius>g.max&&e.intersectRenderGeometry(f,
a,-g.range,b,c))}c++}})};c.prototype.intersectRenderGeometry=function(b,a,d,e,c){var f=this;d+=b.transformation[12];var g=b.transformation[13];n[0]=a[0]-d;n[1]=a[1]-g;n[2]=1;p[0]=a[0]-d;p[1]=a[1]-g;p[2]=0;b.pixelRatio=this._pixelRatio;b.material.intersect(b,null,b.getShaderTransformation(),e,n,p,function(a,d,g){f.addIntersectionResult(g,b.material.renderPriority,c,e,b.data.layerUid,b.data.graphicUid)},b.calculateShaderTransformation,!0)};c.prototype.addIntersectionResult=function(b,a,d,e,c,f){var g=
{type:"external",metadata:{layerUid:c,graphicUid:f}};c=function(c){c.set(g,null,e.results.terrain.dist,e.results.terrain.normal,e.results.terrain.transformation,a,null,null,b,d);c.intersector="OverlayRenderer"};(null==e.results.min.drapedLayerOrder||a>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||e.results.terrain.dist<=e.results.min.dist)&&c(e.results.min);0!==e.options.store&&(null==e.results.max.drapedLayerOrder||a<e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||e.results.terrain.dist>
e.results.max.dist)&&c(e.results.max);2===e.options.store&&(f=new N.IntersectorResult(e.ray),c(f),e.results.all.push(f))};c.prototype.ensureLayerRenderer=function(b){var a=this,d=this._layerRenderers.get(b);d||(d=new Q.SortedRenderGeometryRenderer(this._rctx,this._materialRepository,function(){return a.emitUpdatingChanged()}),this._layerRenderers.set(b,d),this._sortedLayerRenderersDirty=!0);return d};c.prototype.updateSortedLayerRenderers=function(){var b=this;if(this._sortedLayerRenderersDirty&&
(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var a=l.firstKeyOfMap(this._layerRenderers).view.allLayerViews,d=l.createSetFromValues(l.valuesOfMap(this._layerRenderers));a.forEach(function(a){if(a=b._layerRenderers.get(a))b._sortedLayerRenderers.push(a),d.delete(a)});d.forEach(function(a){b._sortedLayerRenderers.push(a)})}};c.prototype.setViewParameters=function(b,a){a.viewport=b.viewport;var d=b.extent;q.mat4.ortho(a.projectionMatrix,0,d[2]-
d[0],0,d[3]-d[1],a.near,a.far);q.mat4.identity(a.viewMatrix);q.mat4.translate(a.viewMatrix,a.viewMatrix,[-b.extent[0],-b.extent[1],0]);a.setGLViewport(this._rctx);this._renderContext.camera=a;this._bindParameters.view=a.viewMatrix;this._bindParameters.proj=a.projectionMatrix;this._bindParameters.viewInvTransp=a.viewInverseTransposeMatrix;this._bindParameters.viewport=a.fullViewport;this._shaderTechniqueRepository.getProgramsUsingUniform("proj").forEach(function(b){b.setUniformMatrix4fv("proj",a.projectionMatrix)})};
c.prototype.updateLightingUniforms=function(){var b=this;this._shaderTechniqueRepository.getProgramsUsingUniform("lightingMainDirection").forEach(function(a){b._lighting.setUniforms(a)})};c.prototype.hasNonZeroSizedView=function(b){for(var a=0;a<b.numViews;a++){var d=b.views[a];if(d.extent[0]!==d.extent[2]&&d.extent[1]!==d.extent[3])return!0}return!1};c.prototype.emitContentChanged=function(){if(this.onContentChanged)this.onContentChanged()};c.prototype.emitUpdatingChanged=function(){if(this.onUpdatingChanged)this.onUpdatingChanged()};
c.prototype.emitHasHighlightsChanged=function(){if(this.onHasHighlightsChanged)this.onHasHighlightsChanged(this._hasHighlights)};c.prototype.drawDebugTexture=function(b,a,d){var c=this._rctx;this.ensureDebugPatternResources(b,a);b=this._debugPatternProgram;c.bindProgram(b);c.setPipelineState(this._debugPatternPipelineState);b.setUniform4f("color",d[0],d[1],d[2],1);b.setUniform1i("tex",0);c.bindTexture(this._debugPatternTexture,0);c.bindVAO(this._quadVAO);c.drawArrays(5,0,A.vertexCount(this._quadVAO,
"geometry"))};c.prototype.ensureDebugPatternResources=function(b,a){if(!this._debugPatternTexture){for(var d=new Uint8Array(b*a*4),c=0,h=0;h<a;h++)for(var f=0;f<b;f++){var g=Math.floor(f/10),k=Math.floor(h/10);2>g||2>k||10*g>b-20||10*k>a-20?(d[c++]=255,d[c++]=255,d[c++]=255,d[c++]=255):(d[c++]=255,d[c++]=255,d[c++]=255,g&1&&k&1?d[c++]=f&1^h&1?0:255:d[c++]=g&1^k&1?0:128)}this._debugPatternTexture=new Y(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:b,height:a},d);b=
new z.TextureTechniqueConfiguration;b.hasAlpha=!0;this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(z.TextureTechnique,b,this._debugTextureTechnique);this._debugPatternProgram=this._debugTextureTechnique.program;this._debugPatternPipelineState=this._debugTextureTechnique.pipeline;this._quadVAO=y.createQuadVAO(this._rctx,K.Pos3Tex)}};Object.defineProperty(c.prototype,"test",{get:function(){return{layerRenderers:this._layerRenderers}},enumerable:!0,configurable:!0});
w([t.autoDispose()],c.prototype,"_shaderTechniqueRepository",void 0);w([t.autoDispose()],c.prototype,"_stippleTextureRepository",void 0);return c}(F.declared(t.AutoDisposable));h.OverlayRenderer=v;var B=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],m=new J.default;m.near=1;m.far=1E4;var n=r.vec3f64.create(),p=r.vec3f64.create();h.DRAPED_Z=-2});