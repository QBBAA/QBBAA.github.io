// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../request ../../../core/Accessor ../../../core/arrayUtils ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/now ../../../core/promiseUtils ../../../core/accessorSupport/decorators ./AsyncWorkerQueue ../webgl-engine/lib/Util ../../../views/support/Scheduler".split(" "),function(n,m,r,w,p,x,y,z,A,t,u,h,q,B,C,D){function E(d){if(2>d.byteLength)return"unknown";d=new Uint8Array(d,
0,d.byteLength);return 137===d[0]&&80===d[1]?"image/png":71===d[0]&&73===d[1]?"image/gif":66===d[0]&&77===d[1]?"image/bmp":255===d[0]&&216===d[1]?"image/jpeg":"unknown"}Object.defineProperty(m,"__esModule",{value:!0});n=function(d){function c(){var a=null!==d&&d.apply(this,arguments)||this;a.tasks=new Map;a.onLoadQueue=[];a.doneQueue=[];a.updating=!1;return a}w(c,d);c.prototype.setup=function(a,b,c){var e=this;this.loadQueue=new B.AsyncWorkerQueue(function(a,b){return e.startLoading(a,b)},function(a,
b){return e.doneLoadingCallback(a,b)},a,b);c&&(this.taskHandle=c.registerTask(D.Task.STREAM_DATA_LOADER,function(a){return e.update(a)},function(){return 0<e.doneQueue.length||0<e.onLoadQueue.length}))};c.prototype.destroy=function(){this.taskHandle&&(this.taskHandle.remove(),this.taskHandle=null);this.tasks.forEach(function(a){a.abortController&&a.abortController.abort()});this.loadQueue.clear();this.tasks=this.doneQueue=this.onLoadQueue=this.loadQueue=null};Object.defineProperty(c.prototype,"busy",
{get:function(){return this.loadQueue.busy},enumerable:!0,configurable:!0});c.prototype.request=function(a,b,c,e){var d=this,f=h.createResolver();f.__signal=t.isSome(e)?e.signal:null;var F=t.isSome(e)&&e.uid||a,k=this.createOrUpdateTask(a,b,c,F,f);h.onAbort(e,function(){return d.cancelRequest(k,f)});return f.promise};c.prototype.createTask=function(a,b,c,e,d){a={url:a,docType:b,clientType:c,key:e,result:null,status:1,resourceRequest:null,abortController:null,resolvers:[],_cancelledInQueue:!1,startTime:0,
duration:0,size:0};this.updateTask(a,d);this.tasks.set(e,a);1===this.tasks.size&&this._set("updating",!0);this.loadQueue.push(a);return a};c.prototype.cancelRequest=function(a,b){y.removeUnordered(a.resolvers,b);b.reject(h.createAbortError());0===a.resolvers.length&&(2===a.status&&(a.status=4,this.loadQueue.cancel(a),a.abortController.abort(),a.resourceRequest=null,a.abortController=null),a.status=4,this.tasks.delete(a.key),0===this.tasks.size&&this._set("updating",!1))};c.prototype.taskKey=function(a,
b,c){return a+":"+b+":"+c};c.prototype.updateTask=function(a,b){a.resolvers.push(b)};c.prototype.createOrUpdateTask=function(a,b,c,e,d){e=this.taskKey(e,b,c);var f=this.tasks.get(e);return f?(this.updateTask(f,d),f):this.createTask(a,b,c,e,d)};c.prototype.doneLoadingCallback=function(a,b){C.assert(2===a.status);a.status=3;this.taskHandle?this.doneQueue.push({task:a,err:b}):this.doneLoading(a,b)};c.prototype.update=function(a){for(;!a.done&&0<this.onLoadQueue.length;){var b=this.onLoadQueue.shift();
h.throwIfAborted(b.task.abortController);b.task.abortController=null;b.callback(b.task);a.madeProgress()}for(;!a.done&&0<this.doneQueue.length;)b=this.doneQueue.shift(),3!==b.task.status&&(b.err=b.err||h.createAbortError()),this.doneLoading(b.task,b.err),a.madeProgress()};c.prototype.doneLoading=function(a,b){for(var c=a.result instanceof HTMLImageElement?0:a.resolvers.length,e=0,d=a.resolvers;e<d.length;e++){var f=d[e];if(b)h.isAbortError(b)?f.reject(b):f.reject(new z("stream-data-loader:request-error",
"Failed to request resource at '"+a.url+"'. "+b,{url:a.url,error:b}));else{--c;var l=0>=c?a.result:A.clone(a.result);f.resolve(l)}}this.tasks.delete(a.key);0===this.tasks.size&&this._set("updating",!1)};c.prototype.startLoading=function(a,b){var c=this;if(4===a.status)return!1;a.status=2;var d,g;switch(a.docType){case "binary":g="array-buffer";d=0;break;case "image":g="image";break;case "image+type":g="array-buffer";break;default:g="json"}a.startTime=u();a.abortController=h.createAbortController();
a.resourceRequest=p(a.url,{responseType:g,timeout:d,signal:a.abortController.signal});var f=function(){},l=function(d){a.duration=u()-a.startTime;a.size=d instanceof ArrayBuffer?d.byteLength:a.size||0;a.result=d;c.taskHandle?c.onLoadQueue.push({callback:b,task:a}):(a.abortController=null,b(a))},k=function(c){2===a.status&&b(a,c);f()};if("image+type"!==a.docType)return a.resourceRequest.then(function(a){return l(a.data)},k),!0;a.resourceRequest.then(function(b){b=b.data;var c=E(b);g="image";a.size=
b.byteLength;if("unknown"===c)a.resourceRequest=p(a.url,{responseType:g,timeout:d,signal:a.abortController.signal}),a.resourceRequest.then(function(a){return l(a.data)},k);else{b=new Blob([b],{type:c});var e=window.URL.createObjectURL(b);f=function(){return window.URL.revokeObjectURL(e)};a.resourceRequest=p(e,{responseType:g,timeout:d,signal:a.abortController.signal});a.resourceRequest.then(function(a){return l(new v(a.data,c,f))},k)}},k);return!0};Object.defineProperty(c.prototype,"test",{get:function(){return{loadQueue:this.loadQueue}},
enumerable:!0,configurable:!0});r([q.property({readOnly:!0})],c.prototype,"updating",void 0);return c=r([q.subclass("esri.views.3d.support.StreamDataLoader")],c)}(q.declared(x));m.StreamDataLoader=n;var v=function(){return function(d,c,a){this.image=d;this.type=c;this.release=a}}();m.ImageWithType=v;m.default=n});