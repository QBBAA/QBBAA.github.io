// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/compilerUtils ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../layers/graphics/dehydratedFeatures ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../manipulatorDragUtils ../manipulatorUtils ./reshapeUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryUtil".split(" "),
function(u,v,n,A,K,B,C,w,h,D,k,t,E,x,F,r,f,y,G,H,I,J){Object.defineProperty(v,"__esModule",{value:!0});u=function(z){function c(a){a=z.call(this,a)||this;a._vertexManipulatorMaterial=r.createManipulatorMaterial([1,.5,0],1);a._edgeManipulatorMaterial=r.createManipulatorMaterial([.5,.5,.5],1);a._selectedManipulatorMaterial=r.createManipulatorMaterial([1,1,1],1);a._manipulatorGeometry=new I(J.createSphereGeometry(1,16,16),"reshape-manipulator");a._handles=new w;a._manipulatorHandles=new w;a._manipulatorInfos=
[];a._reshapeHelper=null;a._moveManipulator=null;a._moveZManipulator=null;a._numGrabbing=0;a._reshapeEventState=0;a.view=null;a.graphic=null;a.enableZ=!0;a.outputGeometry=null;a.manipulators=null;a._emitter.target=null;return a}A(c,z);c.prototype.initialize=function(){var a=this;this._handles.add(this.watch(["graphic.visible","graphic.layer.visible"],function(){for(var b=a.graphic.visible&&a.graphic.layer.visible,g=0,d=a._manipulatorInfos;g<d.length;g++)d[g].manipulator.visible=!!b;h.isSome(a._moveZManipulator)&&
(a._moveZManipulator.visible=!!b)}))};c.prototype.destroy=function(){this._clear();this._handles.destroy()};Object.defineProperty(c.prototype,"inputGeometry",{get:function(){return h.isSome(this._reshapeHelper)?this._reshapeHelper.geometry:null},set:function(a){this._recreateManipulators(a)},enumerable:!0,configurable:!0});c.prototype.removeSelectedVertices=function(){var a=this._manipulatorInfos.filter(function(a){return a.manipulator.selected&&"vertex"===a.handle.type});this._removeVertices(a)};
c.prototype.manipulatorSelectionChanged=function(){this._updateMoveZManipulatorPosition()};c.prototype._clear=function(){this._manipulatorHandles.removeAll();this.manipulators.removeAll();this._manipulatorInfos=[];this._reshapeHelper=this._moveManipulator=null;this._numGrabbing=0};c.prototype._recreateManipulators=function(a){this._clear();this._reshapeHelper=G.createReshapeHelper(a,"global"===this.view.viewingMode);if(!h.isNone(this._reshapeHelper)){a=x.getGraphicEffectiveElevationInfo(this.graphic);
for(var b=0,g=this._reshapeHelper.components;b<g.length;b++){for(var d=g[b],e=0,c=d.vertices;e<c.length;e++)this._createPerVertexManipulator(c[e],a);e=0;for(d=d.edges;e<d.length;e++)this._createPerVertexManipulator(d[e],a)}this._createGraphicMoveManipulators()}};c.prototype._perGraphicManipulatorDragAction=function(a,b){if("end"!==b.action){var g=[],d=this._manipulatorInfos.some(function(a){return"vertex"===a.handle.type&&a.manipulator.selected}),e=1===a&&d;a=h.expect(this._reshapeHelper);for(var c=
0,m=this._manipulatorInfos;c<m.length;c++)d=m[c],"vertex"!==d.handle.type||d.manipulator.grabbing||e&&!d.manipulator.selected||(h.expect(a).addDelta(d.handle,b.mapDeltaX,b.mapDeltaY,b.mapDeltaZ),g.push(d.handle.pos),this._updateManipulatorPosition(d));if(0!==g.length){e=0;for(c=this._manipulatorInfos;e<c.length;e++)d=c[e],"vertex"!==d.handle.type&&this._updateManipulatorPosition(d);this.outputGeometry=a.commit();g.length===this._manipulatorInfos.length?(this._updateEventState(1),this.emit("move",
{type:"move",dx:b.screenDeltaX,dy:b.screenDeltaY,mover:this.graphic})):(this._updateEventState(2),this.emit("reshape",{type:"reshape",mover:this.graphic}))}}};c.prototype._perVertexManipulatorDragAction=function(a,b){var g="edge"===a.handle.type?this._splitEdgeManipulator(a):a;this._updateEventState(2);!1===a.manipulator.selected&&(this._clearManipulatorSelection(),this._updateMoveZManipulatorPosition());a=b.mapDeltaX;var d=b.mapDeltaY,c=b.mapDeltaZ;if(a||d||c){b=[];for(var l=0,m=this._manipulatorInfos;l<
m.length;l++){var f=m[l];"vertex"===f.handle.type&&(f.manipulator.selected&&!f.manipulator.grabbing||f===g)&&b.push(f)}m=h.expect(this._reshapeHelper);for(f=0;f<b.length;f++)g=b[f],l=g.handle,m.addDelta(l,a,d,c),this._updateManipulatorPosition(g);this.outputGeometry=m.commit();for(a=0;a<b.length;a++)g=b[a],l=g.handle,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(l.left)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(l.right));this.emit("reshape",{type:"reshape",
mover:this.graphic})}};c.prototype._updateEventState=function(a){if(a===this._reshapeEventState)return!1;switch(a){case 0:if(0!==this._numGrabbing)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",
mover:this.graphic}),this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}var b=this._reshapeEventState!==a;this._reshapeEventState=a;return b};c.prototype._createGraphicMoveManipulators=function(){var a=this;this._moveManipulator=
y.createGraphicMoveXYManipulator(this.view,this.graphic);var b=f.createManipulatorDragEventPipeline(this._moveManipulator,function(b,c,e){var g=h.isSome(b.graphic.geometry)?b.graphic.geometry.spatialReference:null;c.next(f.screenToMapXYForGraphic(e,a.view,b.graphic,g)).next(f.addMapDelta()).next(f.addScreenDelta()).next(function(b){a._perGraphicManipulatorDragAction(0,b)})});this._manipulatorHandles.add(b);this._manipulatorHandles.add(this._watchAndUpdateGrabState(this._moveManipulator));this._moveManipulator.events.on("immediate-click",
function(b){a.emit("immediate-click");b.stopPropagation()});this.manipulators.add(this._moveManipulator);this._moveZManipulator=this.enableZ?y.createGraphicMoveZManipulator({view:this.view,graphic:this.graphic}):null;h.isSome(this._moveZManipulator)&&(b=f.createManipulatorDragEventPipeline(this._moveZManipulator,function(b,c){c.next(f.screenToZConstrained(a.view,b.renderLocation,b.location.spatialReference)).next(f.addMapDelta()).next(f.addScreenDelta()).next(function(b){a._perGraphicManipulatorDragAction(1,
b)})}),this._manipulatorHandles.add(b),this._manipulatorHandles.add(this._watchAndUpdateGrabState(this._moveZManipulator)),this.manipulators.add(this._moveZManipulator),this._manipulatorHandles.add(D.init(this.graphic,"geometry",function(){return a._updateMoveZManipulatorPosition()})))};c.prototype._clearManipulatorSelection=function(){for(var a=0,b=this._manipulatorInfos;a<b.length;a++)b[a].manipulator.selected=!1;this._updateMoveZManipulatorPosition()};c.prototype._createPerVertexManipulator=function(a,
b){var c=this;void 0===b&&(b=x.getGraphicEffectiveElevationInfo(this.graphic));b=new F.Manipulator3D({view:this.view,renderObjects:[{geometry:this._manipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:p.Vertex|4},{geometry:this._manipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:p.Edge|4},{geometry:this._manipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8}],radius:5,elevationInfo:b,visible:!(!this.graphic.visible||!this.graphic.layer.visible)});
this._setTypeSpecificManipulatorSettings(b,a);var d={manipulator:b,handle:a};this._manipulatorInfos.push(d);this.manipulators.add(b);this._updateManipulatorPosition(d);this._manipulatorHandles.add(this._watchAndUpdateGrabState(b),b);a=f.createManipulatorDragEventPipeline(b,function(a,b){b.next(f.screenToMapXYForGraphicAtLocation(c.view,c.graphic,a.elevationAlignedLocation,a.location.spatialReference)).next(f.addMapDelta()).next(function(a){c._perVertexManipulatorDragAction(d,a)})});this._manipulatorHandles.add(a);
b.events.on("immediate-click",function(a){return c._manipulatorClickCallback(a,d)});return b};c.prototype._setTypeSpecificManipulatorSettings=function(a,b){switch(b.type){case "vertex":a.state=p.Vertex;a.selectable=!0;a.cursor="move";a.collisionPriority=2;a.hideOnGrab=!0;break;case "edge":a.state=p.Edge;a.selectable=!1;a.cursor="copy";a.collisionPriority=1;a.hideOnGrab=!1;break;default:B.neverReached(b)}};c.prototype._watchAndUpdateGrabState=function(a){var b=this;return a.events.on("grab",function(a){"start"===
a.action?b._numGrabbing++:(b._numGrabbing--,b._updateEventState(0))})};c.prototype._removeManipulator=function(a){a&&(this._manipulatorHandles.remove(a.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(a),1),this.manipulators.remove(a.manipulator))};c.prototype._getManipulatorInfoFromHandle=function(a){if(a)for(var b=0,c=this._manipulatorInfos;b<c.length;b++){var d=c[b];if(a===d.handle)return d}return null};c.prototype._updateManipulatorPosition=function(a){if(a){var b=h.expect(this._reshapeHelper);
"vertex"===a.handle.type?a.manipulator.location=b.getVertexPositionAsPoint(a.handle,q):"edge"===a.handle.type&&(a.manipulator.location=b.getEdgePositionAsPoint(a.handle,.5,q))}};c.prototype._splitEdgeManipulator=function(a){var b=h.expect(this._reshapeHelper).splitEdge(a.handle,.5);a.handle=b;this._setTypeSpecificManipulatorSettings(a.manipulator,a.handle);b.left&&this._createPerVertexManipulator(b.left);b.right&&this._createPerVertexManipulator(b.right);return a};c.prototype._updateMoveZManipulatorPosition=
function(){if(!h.isNone(this._moveZManipulator)){var a=H.sv3d.get();t.vec3.set(a,0,0,0);for(var b=0,c=0,d=this._manipulatorInfos;c<d.length;c++){var e=d[c];"vertex"===e.handle.type&&e.manipulator.selected&&(b++,t.vec3.add(a,a,e.manipulator.renderLocation))}if(0!==b&&(t.vec3.scale(a,a,1/b),q.spatialReference=h.expect(this._reshapeHelper).geometry.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,q))){this._moveZManipulator.elevationAlignedLocation=q;return}r.placeManipulatorAtGraphic(this._moveZManipulator,
this.graphic)}};c.prototype._removeVertices=function(a){for(var b=[],c=h.expect(this._reshapeHelper),d=0;d<a.length;d++){var e=a[d];"vertex"===e.handle.type&&c.canRemoveVertex(e.handle)&&(b.push(e.handle.unnormalizedPos),this._removeManipulator(e),this._removeManipulator(this._getManipulatorInfoFromHandle(e.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(e.handle.right)),(e=c.removeVertex(e.handle))&&this._createPerVertexManipulator(e))}0<b.length&&(this.outputGeometry=c.commit(),
a=this._updateEventState(2),this.emit("vertex-remove",{type:"vertex-remove",removed:b}),a&&this._updateEventState(0),this._updateMoveZManipulatorPosition())};c.prototype._manipulatorClickCallback=function(a,b){"vertex"===b.handle.type&&2===a.button&&this._removeVertices([b]);if("edge"===b.handle.type&&0===a.button){b=this._splitEdgeManipulator(b);this.outputGeometry=h.expect(this._reshapeHelper).commit();var c=this._updateEventState(2);this.emit("vertex-add",{type:"vertex-add",added:[b.handle.unnormalizedPos]});
c&&this._updateEventState(0)}a.stopPropagation()};n([k.property({constructOnly:!0})],c.prototype,"view",void 0);n([k.property({constructOnly:!0})],c.prototype,"graphic",void 0);n([k.property({constructOnly:!0})],c.prototype,"enableZ",void 0);n([k.property()],c.prototype,"inputGeometry",null);n([k.property()],c.prototype,"outputGeometry",void 0);n([k.property({constructOnly:!0})],c.prototype,"manipulators",void 0);return c=n([k.subclass("esri.views.3d.interactive.editingTools.graphicReshape3D.ReshapeOperation")],
c)}(k.declared(C.EventedAccessor));v.ReshapeOperation=u;var q=E.makeDehydratedPoint(0,0,null,null),p;(function(f){f.Vertex=16;f.Edge=32})(p||(p={}))});