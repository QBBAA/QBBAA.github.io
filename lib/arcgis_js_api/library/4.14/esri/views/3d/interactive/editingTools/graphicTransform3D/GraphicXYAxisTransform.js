// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/Handles ../../../../../core/has ../../../../../core/watchUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../manipulatorDragUtils ./graphicTransform3DToolConfig ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/materials/ColorMaterial".split(" "),
function(l,m,D,E,F,G,u,v,n,d,w,p,q,x,y,r,g,e,h,z,t,A){function B(a){return"local"===a.viewingMode?!0:a.scale<e.ALIGN_ARROWS_SCALE_THRESHOLD}Object.defineProperty(m,"__esModule",{value:!0});var k;(function(a){a.Highlighted=512;a.Visible=1024})(k||(k={}));l=function(){function a(b){this._handles=new u;this.arrowManipulatorInfos=[];this.tool=b.tool}a.prototype.destroy=function(){this._clear()};a.prototype._clear=function(){var b=this;this._handles.removeAll();this.arrowManipulatorInfos.forEach(function(a){b.tool.manipulators.remove(a.manipulator)});
this.arrowManipulatorInfos=[]};Object.defineProperty(a.prototype,"focused",{get:function(){return this.arrowManipulatorInfos.some(function(b){return b.manipulator.focused})},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"dragging",{get:function(){return this.arrowManipulatorInfos.some(function(b){return b.manipulator.dragging})},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"arrowRotationAngle",{get:function(){return"local"===this.tool.view.viewingMode||this.tool.view.scale<
e.ALIGN_ARROWS_SCALE_THRESHOLD?this.tool.symbolRotationAngle:0},enumerable:!0,configurable:!0});a.prototype.recreateManipulators=function(){var b=this;this._clear();for(var a=[],c=function(d){var c=f.createArrowManipulator(d);a.push(c);f.tool.manipulators.add(c.manipulator);var e=g.createManipulatorDragEventPipeline(c.manipulator,function(a,c){c.next(g.screenToMapXYForGraphicAtLocation(b.tool.view,b.tool.graphic,a.elevationAlignedLocation)).next(g.constrainToMapAxis(a.location,b.arrowRotationAngle+
(d+1)*Math.PI*.5)).next(function(a){"start"===a.action&&b.tool.emit("graphic-translate-start",{graphic:b.tool.graphic});return a}).next(g.dragGraphic(b.tool.graphic)).next(function(a){switch(a.action){case "start":case "update":(a.translationX||a.translationY||a.translationZ)&&b.tool.emit("graphic-translate",{graphic:b.tool.graphic,dx:a.translationX,dy:a.translationY,dz:a.translationZ,type:"translate"});break;case "end":b.tool.emit("graphic-translate-stop",{graphic:b.tool.graphic})}return a})});f._handles.add(e);
f._handles.add([c.manipulator.events.on("focus",function(){b.tool.updateManipulators()}),c.manipulator.events.on("immediate-click",function(b){b.stopPropagation()})])},f=this,d=0;4>d;d++)c(d);this.arrowManipulatorInfos=a;this.arrowManipulatorInfos.forEach(function(a){r.placeManipulatorAtGraphic(a.manipulator,b.tool.graphic)});this._handles.add([n.init(this.tool.graphic,"geometry",function(){b.arrowManipulatorInfos.forEach(function(a){r.placeManipulatorAtGraphic(a.manipulator,b.tool.graphic)})}),n.init(this.tool.graphic,
["visible","layer.visible"],function(){var a=b.tool.graphic.visible&&b.tool.graphic.layer.visible;b.arrowManipulatorInfos.forEach(function(b){b.manipulator.visible=a})})])};a.prototype.updateManipulators=function(b,a,c){var f=this.tool.symbolRotationAngle,e=d.mat4.identity(h.sm4d.get());0!==f&&d.mat4.rotate(e,e,f,q.vec3f64.fromValues(0,0,1));var f=d.mat4.multiply(h.sm4d.get(),b,e),C=B(this.tool.view)?f:b,g=this.dragging,l=a||v("esri-mobile")?k.Visible:0;this.arrowManipulatorInfos.forEach(function(b){var a=
d.mat4.multiply(h.sm4d.get(),C,b.transform);b.manipulator.state=g?l|(b.manipulator.dragging?k.Highlighted:0):l|(b.manipulator.focused&&c?k.Highlighted:0);b.manipulator.modelTransform=a})};a.prototype.createArrowManipulator=function(b){var a=Math.sqrt(e.DISC_TRANSLATE_ARROW_SIZE*e.DISC_TRANSLATE_ARROW_SIZE*3/4),c=t.createExtrudedTriangle(a,e.DISC_TRANSLATE_ARROW_SIZE/2,e.DISC_TRANSLATE_ARROW_SIZE/2,e.DISC_HEIGHT);t.transformInPlace(c,d.mat4.fromTranslation(h.sm4d.get(),p.vec3.set(h.sv3d.get(),0,-a/
3,0)));var c=new z(c,"graphic-transform-disc-arrow"+b),f=this.createMaterial(),g=this.createMaterial(.5),l=this.createMaterial(0),a=new y.Manipulator3D({view:this.tool.view,renderObjects:[{geometry:c,material:f,stateMask:k.Visible|k.Highlighted},{geometry:c,material:g,stateMask:k.Visible},{geometry:c,material:l,stateMask:0}],autoScaleRenderObjects:!1,radius:a,focusMultiplier:1,touchMultiplier:1,elevationInfo:x.getGraphicEffectiveElevationInfo(this.tool.graphic),collisionType:{type:"disc",direction:q.vec3f64.fromValues(0,
0,1)}}),c=d.mat4.identity(h.sm4d.get());d.mat4.fromZRotation(c,b*Math.PI/2);b=d.mat4.identity(h.sm4d.get());d.mat4.fromTranslation(b,p.vec3.set(h.sv3d.get(),0,e.DISC_TRANSLATE_ARROW_OFFSET,0));f=w.mat4f64.create();d.mat4.multiply(f,c,b);return{manipulator:a,transform:f}};a.prototype.createMaterial=function(a){void 0===a&&(a=1);var b=e.HANDLE_COLOR.concat([a]);a=new A({color:b,transparent:1!==a,cullFace:2},"graphic-transform");a.renderOccluded=2;return a};return a}();m.GraphicXYAxisTransform=l});