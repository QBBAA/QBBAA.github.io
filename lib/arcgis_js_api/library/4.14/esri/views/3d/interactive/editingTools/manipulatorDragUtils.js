// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../geometry ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../core/accessorSupport/utils ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/webMercatorUtils ../../../../support/elevationInfoUtils ../../support/geometryUtils ../../support/geometryUtils ../../support/projectionUtils ../../support/stack ../../../draw/support/drawUtils".split(" "),
function(Q,g,m,R,v,I,h,q,w,l,n,r,J,K,p,x,y,L){function t(a,b){var d=null;return a.events.on("drag",function(c){var e={action:c.action,screenStart:c.start,screenEnd:c.screenPoint};"start"===c.action&&h.isNone(d)&&(d=new u,b(a,d,e));h.isSome(d)&&d.execute(e);"end"===c.action&&h.isSome(d)&&(d=null)})}function z(a,b){var d=n.vec3f64.create(),c=n.vec3f64.create(),e=!1;return function(f){if("start"===f.action){var k=q.screenPointObjectToArray(f.screenStart,q.castScreenPointArray(y.sv2d.get())),k=p.ray.fromScreen(a.state.camera,
k,A);e=p.plane.intersectRay(b,k,d)}if(!e)return null;k=q.screenPointObjectToArray(f.screenEnd,q.castScreenPointArray(y.sv2d.get()));k=p.ray.fromScreen(a.state.camera,k,A);return p.plane.intersectRay(b,k,c)?m({},f,{renderStart:d,renderEnd:c,plane:b}):null}}function B(a,b,d,c){void 0===c&&(c=null);var e=null;return function(f){if("start"===f.action&&(e=a.sceneIntersectionHelper.intersectElevationFromScreen(q.createScreenPointArray(f.screenStart.x,f.screenStart.y),b,d),h.isSome(e)&&h.isSome(c)&&!x.pointToPoint(e,
e,c))||h.isNone(e))return null;var k=a.sceneIntersectionHelper.intersectElevationFromScreen(q.createScreenPointArray(f.screenEnd.x,f.screenEnd.y),b,d);return h.isSome(k)?h.isSome(c)&&!x.pointToPoint(k,k,c)?null:m({},f,{mapStart:e,mapEnd:k}):null}}function C(a,b,d,c){void 0===c&&(c=null);b=J.getGraphicEffectiveElevationInfo(b);d=M(a,d,b);return B(a,b,d,c)}function M(a,b,d){if(!b.hasZ)return 0;switch(d.mode){case "absolute-height":return b.z;case "on-the-ground":return 0;case "relative-to-ground":return a=
(a.elevationProvider.getElevation(b.x,b.y,b.z,b.spatialReference,"ground")||0)+d.offset,b.z-a;case "relative-to-scene":return a=(a.elevationProvider.getElevation(b.x,b.y,b.z,b.spatialReference,"scene")||0)+d.offset,b.z-a}}function N(a,b){var d=O,c=P,e=p.plane.create();a.renderCoordsHelper.worldUpAtPosition(b,d);a=l.vec3.cross(e,d,l.vec3.subtract(c,b,a.state.camera.eye));l.vec3.cross(a,a,d);return p.plane.fromPositionAndNormal(b,a,e)}function D(a,b){var d=null,c=h.isSome(a[b])?a[b].spatialReference:
null;return function(e){if("start"===e.action&&h.isSome(a[b])){var f=a[b],k=e.mapStart.spatialReference;d=h.isNone(f)||"mesh"===f.type?null:f.spatialReference.equals(k)?f.clone():r.canProject(f,k)?r.project(f,k):null}if(h.isNone(d))return null;var f=e.mapEnd.x-e.mapStart.x,k=e.mapEnd.y-e.mapStart.y,E=e.mapEnd.z-e.mapStart.z,g=L.move(d.clone(),f,k,E);g.spatialReference.equals(c)?a[b]=g:a[b]=r.project(g,c);return m({},e,{translationX:f,translationY:k,translationZ:E})}}function F(a){return D(a,"geometry")}
function G(a,b){var d=n.vec3f64.create(),c=l.vec3.length(b);a.renderCoordsHelper.worldUpAtPosition(b,d);var e=n.vec3f64.create(),f=n.vec3f64.create(),k=function(e){l.vec3.subtract(e,e,b);K.vector.projectPoint(d,e,e);"global"===a.viewingMode&&l.vec3.length(e)*I.sign(l.vec3.dot(d,e))<-c+.001&&l.vec3.subtract(e,l.vec3.scale(e,d,.001),b);l.vec3.add(e,e,b);return e};return function(a){a.renderStart=k(l.vec3.copy(e,a.renderStart));a.renderEnd=k(l.vec3.copy(f,a.renderEnd));return a}}function H(a,b){var d=
a.renderCoordsHelper;return function(a){var c=d.fromRenderCoords(a.renderStart,new v.Point,b),f=d.fromRenderCoords(a.renderEnd,new v.Point,b);return h.isSome(c)&&h.isSome(f)?m({},a,{mapStart:c,mapEnd:f}):null}}Object.defineProperty(g,"__esModule",{value:!0});g.createManipulatorDragEventPipeline=t;g.createManipulatorDragEventPipelineMany=function(a,b){for(var d=[],c=0;c<a.length;c++)d.push(t(a[c],b));return w.handlesGroup(d)};g.createManipulatorDragEventPipelineManyOneOf=function(a,b){for(var d=[],
c=null,e=function(a,d,e){h.isNone(c)&&(c=a,b(a,d.next(function(a){"end"===a.action&&(c=null);return a}),e))},f=0;f<a.length;f++)d.push(t(a[f],e));return w.handlesGroup(d)};g.screenToRenderPlane=z;g.screenToMapXY=B;g.screenToMapXYForGraphicAtLocation=C;g.screenToMapXYForGraphic=function(a,b,d,c){a=b.toMap(a.screenStart,{include:[d]});return h.isSome(a)?C(b,d,a,c):null};g.screenToZConstrained=function(a,b,d){var c=null,e=new u;e.next(z(a,N(a,b))).next(G(a,b)).next(H(a,d)).next(function(a){a.mapEnd.x=
a.mapStart.x;a.mapEnd.y=a.mapStart.y;c=a});return function(a){c=null;e.execute(a);return c}};g.constrainToMapAxis=function(a,b){var d=[a.x,a.y,a.z],c=[Math.cos(b),Math.sin(b)];a=Math.sqrt(c[0]*c[0]+c[1]*c[1]);if(0===a)return null;c[0]/=a;c[1]/=a;var e=function(a){var b=(a.x-d[0])*c[0]+(a.y-d[1])*c[1];a.x=d[0]+b*c[0];a.y=d[1]+b*c[1]};return function(a){e(a.mapStart);e(a.mapEnd);return a}};g.dragGeometry=D;g.dragGraphic=F;g.dragGraphicMany=function(a){var b=a.map(function(a){return h.unwrap(F(a))}).filter(function(a){return h.isSome(a)});
return function(a){var c=a.mapEnd.x-a.mapStart.x,d=a.mapEnd.y-a.mapStart.y,f=a.mapEnd.z-a.mapStart.z;b.forEach(function(c){return c(a)});return m({},a,{translationX:c,translationY:d,translationZ:f})}};g.horizontalDegreesOfFreedom=3;g.verticalDegreesOfFreedom=4;g.allDegreesOfFreedom=7;g.addMapDelta=function(a){void 0===a&&(a=g.allDegreesOfFreedom);var b=0,d=0,c=0;return function(e){"start"===e.action&&(b=e.mapStart.x,d=e.mapStart.y,c=e.mapStart.z);var f=a&1?e.mapEnd.x-b:0,g=a&2?e.mapEnd.y-d:0,h=a&
4?e.mapEnd.z-c:0;b=e.mapEnd.x;d=e.mapEnd.y;c=e.mapEnd.z;return m({},e,{mapDeltaX:f,mapDeltaY:g,mapDeltaZ:h,mapDeltaSpatialReference:e.mapStart.spatialReference})}};g.addScreenDelta=function(a){void 0===a&&(a=g.allDegreesOfFreedom);var b=0,d=0;return function(c){"start"===c.action&&(b=c.screenStart.x,d=c.screenStart.y);var e=a&1?c.screenEnd.x-b:0,f=a&2?c.screenEnd.y-d:0;b=c.screenEnd.x;d=c.screenEnd.y;return m({},c,{screenDeltaX:e,screenDeltaY:f})}};g.projectToWorldUp=G;g.convertToMapCoordinates=H;
var u=function(){function a(){this.execute=function(){}}a.prototype.next=function(b){var d=new a;h.isSome(b)&&(this.execute=function(a){a=b(a);h.isSome(a)&&d.execute(a)});return d};return a}();g.EventPipeline=u;var O=n.vec3f64.create(),P=n.vec3f64.create(),A=p.ray.create()});