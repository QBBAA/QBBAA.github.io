// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/iteratorUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../layers/graphics/dehydratedFeatures ../../../../layers/support/labelFormatUtils ../../../../layers/support/layerUtils ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./graphicSymbolUtils ./labelPlacement ../../support/debugFlags ../../webgl-engine/lib/Layer ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextRenderer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureAtlas ../../../support/index".split(" "),
function(z,A,E,r,p,v,F,B,G,H,w,l,m,I,J,x,K,L,M,N,O,P,C,Q,R,S,D){Object.defineProperty(A,"__esModule",{value:!0});z=function(y){function b(){var a=null!==y&&y.apply(this,arguments)||this;a.idHint="__labeler";a._dirty=!1;a.labels=new Map;a.labelsToAdd=new Map;a.labelsToRemove=new Map;a.labelingContexts=[];return a}E(b,y);b.prototype.setup=function(){var a=this;this.handles||(this.handles=new G,this.handles.add([this.view.watch("state.camera",function(){return a.setDirty()}),this.view.watch("pixelRatio",
function(){return a.resetAllLabels()})]));this.textTextureAtlas||(this.textTextureAtlas=new S.default({idHint:this.idHint+"_atlas",view:this.view}),this.hudMaterialCollection=new C(this.view._stage),this.calloutMaterialCollection=new C(this.view._stage));this.handles.add(this.view.resourceController.scheduler.registerTask(D.Task.LABELER,function(c){return a.update(c)},function(){return a.needsUpdate()}))};b.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null);this.textTextureAtlas&&
(this.textTextureAtlas.dispose(),this.textTextureAtlas=null);this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null);this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null);this.labelingContexts=[];this.labels.clear();this.labelsToAdd.clear();this.labelsToRemove.clear()};b.prototype.isActiveLabelingContext=function(a){return a.active&&x.areLabelsVisible(a.layer)};b.prototype.activateLabelingContext=function(a){var c=
this;a.labels.forEach(function(a,e){c.labels.set(e,a);a.graphics3DGraphic.setVisibilityFlag(0,!0,1)});a.active=!0};b.prototype.deactivateLabelingContext=function(a){var c=this;a.labels.forEach(function(a,e){a.graphics3DGraphic.setVisibilityFlag(0,!1,1);a.rendered&&c.labelsToRemove.set(e,a);c.labels.delete(e);c.labelsToAdd.delete(e)});a.active=!1};b.prototype.addLabelTextureToAtlas=function(a){for(var c=0;c<a.graphics3DGraphic._labelGraphics.length;c++){var d=a.graphics3DGraphic._labelGraphics[c];
if(d._labelClass){var e=a.textRenderers[d._labelIndex];e&&this.textTextureAtlas.addTextTexture(e,d.stageObject)}}a.rendered=!0};b.prototype.removeLabelTextureFromAtlas=function(a){for(var c=a.graphics3DGraphic,d=0;d<c._labelGraphics.length;d++){var e=c._labelGraphics[d];e._labelClass&&(e=a.textRenderers[e._labelIndex])&&this.textTextureAtlas.removeTextTexture(e,c._labelGraphics[d].stageObject)}a.rendered=!1};b.prototype.needsUpdate=function(){return this.view.ready&&this.isDirty};b.prototype.update=
function(a){for(var c=this,d=this._dirty=!1,e=function(e){if(!f.isActiveLabelingContext(e))return"continue";if(!f.hasValidLabelClassContext(e)){if(f.hasInvalidLabelClassContext(e))return f.deactivateLabelingContext(e),"continue";f.createLabelClassContext(e);if(f.hasPendingLabelClassContext(e))return f._dirty=!0,"continue";if(!f.hasValidLabelClassContext(e))return"continue"}H.someMap(e.labelsToInitialize,function(b,f){c.ensureGraphics3DResources(b)&&(c.labels.set(f,b),d=!0,a.madeProgress());if(b.visible&&
b.hasTextTextureResources||!b.visible&&b.hasGraphics3DResources)e.labelsToInitialize.delete(f),a.madeProgress();return a.done})&&(f._dirty=!0)},f=this,b=0,k=this.labelingContexts;b<k.length;b++)e(k[b]);a&&d&&this.view.deconflictor.setDirty();this.labelsToRemove.forEach(function(a){return c.removeLabelTextureFromAtlas(a)});this.labelsToRemove.clear();this.labelsToAdd.forEach(function(a){return c.addLabelTextureToAtlas(a)});this.labelsToAdd.clear();this._dirty||this.notifyChange("updating")};b.prototype.hasPendingLabelClassContext=
function(a){return a.labelClassPromise&&!!a.labelClassAbortController};b.prototype.hasValidLabelClassContext=function(a){return a.labelClassContexts&&a.labelClassContexts.length};b.prototype.hasInvalidLabelClassContext=function(a){return null===a.labelClassContexts};b.prototype.createLabelClassContextAsync=function(a){return v(this,void 0,void 0,function(){var c,d,e,b,h,k=this;return p(this,function(f){switch(f.label){case 0:return c=a.labelClassAbortController.signal,[4,a.layer.when()];case 1:f.sent();
l.throwIfAborted(c);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();d=a.graphics3DCore;e=d.layer;b=e.labelingInfo&&e.labelingInfo.filter(function(a){return!!a.symbol});if(!b||0===b.length)return[2,null];h=Array(b.length);return[4,B.forEach(b,function(e,b){return v(k,void 0,void 0,function(){var f,g,k,u;return p(this,function(q){switch(q.label){case 0:return f=e.symbol,g=M.getGraphics3DSymbol(d.getOrCreateGraphics3DSymbol(f)),[4,g.load()];case 1:q.sent();l.throwIfAborted(c);k=null;if(!K.isCalloutSupport(f)||
!f.hasVisibleCallout())return[3,3];k=L.make(f,d.symbolCreationContext);return[4,k.load()];case 2:q.sent(),l.throwIfAborted(c),q.label=3;case 3:return[4,B.result(J.createLabelFunction(e,a.layer.fields.map(function(a){return a.toJSON()}),this.view.spatialReference))];case 4:return u=q.sent(),l.throwIfAborted(c),!0===u.ok&&(h[b]={labelClass:e,labelFunction:u.value,graphics3DSymbol:g,graphics3DCalloutSymbolLayer:k,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(g.symbol)}),
[2]}})})})];case 2:return f.sent(),l.throwIfAborted(c),a.labelClassContexts=h,[2]}})})};b.prototype.createLabelClassContext=function(a){return v(this,void 0,void 0,function(){var c=this;return p(this,function(d){a.labelClassPromise||(a.labelClassPromise=this.createLabelClassContextAsync(a).catch(function(c){if(l.isAbortError(c))throw c;a.labelClassContexts=null}).then(function(){a.labelClassAbortController=null;c.notifyChange("updating")}).catch(function(){}),this.notifyChange("updating"));return[2,
a.labelClassPromise]})})};b.prototype.createTextRenderParameters=function(a){return(a=a.symbolLayers.getItemAt(0))&&"text"===a.type?R.default.fromSymbol(a,this.view.pixelRatio):null};b.prototype.destroyLabelClassContext=function(a){for(var c=0,d=a.labelClassContexts;c<d.length;c++){var e=d[c];--e.graphics3DSymbol.referenced;e.graphics3DSymbol=null}c=a.labelClassAbortController;a.labelClassAbortController=l.createAbortController();c&&c.abort();a.labelClassContexts=[];a.labelClassPromise=null;this.notifyChange("updating")};
b.prototype.createTextSymbolGraphic=function(a,c,d,e,b){a={text:a.text,centerOffset:d.centerOffset,translation:d.translation,elevationOffset:d.elevationOffset,screenOffset:d.screenOffset,anchor:d.anchor,centerOffsetUnits:d.centerOffsetUnits,verticalOffset:d.verticalOffset,debugDrawBorder:O.LABELS_SHOW_BORDER,displayWidth:a.displayWidth,displayHeight:a.displayHeight};n.graphic=c;n.renderingInfo=null;n.layer=e;return b.createLabel(n,a,this.hudMaterialCollection,this.textTextureAtlas)};b.prototype.createLineCalloutGraphic=
function(a,c,d,e,b){c={symbol:c,translation:e.translation,elevationOffset:e.elevationOffset,screenOffset:e.screenOffset,centerOffset:e.centerOffset,centerOffsetUnits:e.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};n.graphic=a;n.renderingInfo=c;n.layer=b;return d.createGraphics3DGraphic(n)};b.prototype.ensureGraphics3DResources=function(a){if(a.hasGraphics3DResources)return!1;var c=a.graphics3DGraphic;if(c.destroyed)return!1;this.ensureTextTextureResources(a);var d=a.labelingContext,
e=d.labelClassContexts;if(!e||0===e.length||!d.emptySymbolLabelSupported&&0===c._graphics.length)return!1;for(var b=!1,h=c.graphic,k=d.layer,g=x.areLabelsVisible(d.layer),u=this.view._stage,l=0;l<e.length;l++){var n=a.textRenderers[l];if(n){var m=e[l],t=m.graphics3DSymbol,r=null;t.symbol&&"label-3d"===t.symbol.type&&(r=t.symbol);var q=t.symbolLayers[0];if(q){var t=m.labelClass,p=N.get({graphics3DGraphic:c,labelSymbol:r,labelClass:t,disablePlacement:d.disablePlacement});if(!w.isNone(p)){q.setElevationInfoOverride(d.elevationInfoOverride);
b=this.createTextSymbolGraphic(n,h,p,k,q);if(!b)return!1;b._labelClass=t;b._labelIndex=l;c.addLabelGraphic(b,u,d.stageLayer);c.setVisibilityFlag(0,g,1);c.clearVisibilityFlag(1,1);c.setVisibilityFlag(3,!1,1);b=!0;m.graphics3DCalloutSymbolLayer&&p.hasLabelVerticalOffset&&(h=this.createLineCalloutGraphic(h,r,m.graphics3DCalloutSymbolLayer,p,k))&&(m.calloutSymbolLayerIndex=c._labelGraphics.length,c.addLabelGraphic(h,u,d.stageLayer));break}}}}d.scaleVisibility&&b&&d.scaleVisibility.updateGraphicLabelScaleVisibility(c);
return a.hasGraphics3DResources=!0};b.prototype.destroyGraphics3DResources=function(a){for(var c=a.labelingContext.labelClassContexts,d=0,e=a.graphics3DGraphic._labelGraphics;d<e.length;d++){var b=e[d];if(null!=b._labelClass){var h=c[b._labelIndex].graphics3DSymbol.symbolLayers[0];if(null!=h)h.onRemoveGraphic(b)}}a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};b.prototype.ensureTextTextureResources=function(a){if(!a.hasTextTextureResources){var c=a.labelingContext,d=c.labelClassContexts;
if(d&&0!==d.length){for(var e=a.graphics3DGraphic.graphic,b=0;b<d.length;b++){var h=d[b];a.textRenderers[b]=null;if(h.textRenderParameters){var k=h.labelFunction,g=void 0;if("arcade"===k.type)try{var l=I.hydrateGraphic(e,c.layer),g=k.evaluate(l)}catch(T){g=null}else g=k.evaluate(e);w.isNone(g)||""===g||(a.textRenderers[b]=new Q.default(g,h.textRenderParameters))}}a.hasTextTextureResources=!0}}};b.prototype.destroyTextTextureResources=function(a){a.textRenderers=[];a.hasTextTextureResources=!1};b.prototype.addGraphic=
function(a,c){var d={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:a,graphics3DGraphic:c,textRenderers:[]};c=c.graphic.uid;a.labels.set(c,d);a.labelsToInitialize.set(c,d);this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};b.prototype.removeGraphic=function(a,c){c=c.graphic.uid;var d=a.labels.get(c);d&&(this.destroyGraphic(d,c),a.labels.delete(c),a.labelsToInitialize.delete(c),this.setDirty(a.graphics3DCore.asyncUpdates),this.view.deconflictor.setDirty())};
b.prototype.destroyGraphic=function(a,c){this.labels.has(c)&&(this.labels.delete(c),this.labelsToAdd.delete(c),this.labelsToRemove.delete(c));a.hasTextTextureResources&&(this.removeLabelTextureFromAtlas(a),this.destroyTextTextureResources(a));a.hasGraphics3DResources&&this.destroyGraphics3DResources(a)};b.prototype.labelingInfoChange=function(a,c){return v(this,void 0,void 0,function(){var d,b,f,h;return p(this,function(e){if(c){d=0;for(b=c;d<b.length;d++)if(f=b[d],h=a.labels.get(f))this.removeGraphic(a,
h.graphics3DGraphic),this.addGraphic(a,h.graphics3DGraphic);return[2]}this.visibilityInfoChange(a);this.resetLabels(a);return[2,this.createLabelClassContext(a)]})})};b.prototype.globalPropertyChanged=function(a,c){for(var d=function(d){var b=new Map;c.labels.forEach(function(a){a=a.graphics3DGraphic;b.set(a.graphic.uid,a)});w.expect(d.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(a,b,function(a){return a._labelGraphics[0]});d.graphics3DCalloutSymbolLayer&&d.graphics3DCalloutSymbolLayer.globalPropertyChanged(a,
b,function(a){return a._labelGraphics[d.calloutSymbolLayerIndex]})},b=0,f=c.labelClassContexts;b<f.length;b++)d(f[b])};b.prototype.visibilityInfoChange=function(a){var c=a.layer.labelsVisible;c&&!a.active&&this.activateLabelingContext(a);!c&&a.active&&this.deactivateLabelingContext(a);this.setDirty(a.graphics3DCore.asyncUpdates)};b.prototype.resetAllLabels=function(){for(var a=0,c=this.labelingContexts;a<c.length;a++)this.resetLabels(c[a])};b.prototype.resetLabels=function(a){var c=this;a.labels.forEach(function(d,
b){c.destroyGraphic(d,b);d.visible=!1;d.rendered=!1;a.labelsToInitialize.set(b,d)});this.destroyLabelClassContext(a);this.setDirty(a.graphics3DCore.asyncUpdates);this.view.deconflictor.setDirty()};b.prototype.findLabelingContext=function(a){for(var c=0,d=this.labelingContexts;c<d.length;c++){var b=d[c];if(b.graphics3DCore===a)return b}return null};b.prototype.addGraphicsOwner=function(a,c,b){var d=this,f=b&&b.emptySymbolLabelSupported||!1,h=b&&b.elevationInfoOverride||null;b=b&&b.disablePlacement||
null;if(!this.findLabelingContext(a)){var k=a.layer,g={graphics3DCore:a,layer:k,scaleVisibility:c,emptySymbolLabelSupported:f,elevationInfoOverride:h,disablePlacement:b,active:a.layer.labelsVisible,labelClassPromise:null,labelClassAbortController:l.createAbortController(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new P(this.idHint+"_"+k.uid,{isPickable:!0},k.uid)};this.view._stage.add(0,g.stageLayer);this.view._stage.addToViewContent([g.stageLayer.id]);this.labelingContexts.push(g);
this.setDirty();return{addGraphic:function(a){return d.addGraphic(g,a)},removeGraphic:function(a){return d.removeGraphic(g,a)},featureReductionChange:function(){},layerLabelsEnabled:function(){return x.areLabelsVisible(g.layer)},labelingInfoChange:function(a){return d.labelingInfoChange(g,a)},elevationInfoChange:function(){return d.globalPropertyChanged("elevationInfo",g)},slicePlaneEnabledChange:function(){return d.globalPropertyChanged("slicePlaneEnabled",g)},visibilityInfoChange:function(){return d.visibilityInfoChange(g)},
reset:function(){return d.resetLabels(g)},clear:function(){},processStageDirty:function(){return d.view._stage.processDirtyLayer(g.stageLayer.id)}}}};b.prototype.removeGraphicsOwner=function(a){var b=this,d=this.findLabelingContext(a);d&&(a=this.labelingContexts.indexOf(d),this.labelingContexts.splice(a,1),d.labels.forEach(function(a){return b.removeGraphic(d,a.graphics3DGraphic)}),a=d.stageLayer.id,this.view._stage.removeFromViewContent([a]),this.view._stage.remove(0,a),d.stageLayer=null,this.setDirty())};
b.prototype.setLabelGraphicVisibility=function(a,b){a=a.graphic.uid;var c=this.labels.get(a);c&&(b&&!c.rendered?(this.labelsToAdd.set(a,c),this.labelsToRemove.delete(a),c.hasTextTextureResources||c.labelingContext.labelsToInitialize.set(a,c)):!b&&c.rendered&&(this.labelsToRemove.set(a,c),this.labelsToAdd.delete(a)),c.visible=b,this.setDirty(c.labelingContext.graphics3DCore.asyncUpdates))};Object.defineProperty(b.prototype,"isDirty",{get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty},
enumerable:!0,configurable:!0});b.prototype.setDirty=function(a){void 0===a&&(a=!0);var b=this._dirty;this._dirty||(this._dirty=!0);a||this.update(D.noBudget);b!==this._dirty&&this.notifyChange("updating")};Object.defineProperty(b.prototype,"updating",{get:function(){var a=this;return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.labelingContexts.some(function(b){return a.hasPendingLabelClassContext(b)})},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"test",{get:function(){return{textTextureAtlas:this.textTextureAtlas}},enumerable:!0,configurable:!0});r([m.property({constructOnly:!0})],b.prototype,"view",void 0);r([m.property()],b.prototype,"textTextureAtlas",void 0);r([m.property({type:Boolean,readOnly:!0,dependsOn:["textTextureAtlas.updating"]})],b.prototype,"updating",null);return b=r([m.subclass("esri.views.3d.layers.graphics.Labeler")],b)}(m.declared(F));A.Labeler=z;var n={graphic:null,renderingInfo:null,layer:null}});