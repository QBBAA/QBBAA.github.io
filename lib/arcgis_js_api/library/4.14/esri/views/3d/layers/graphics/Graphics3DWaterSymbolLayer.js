// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Color ../../../../core/maybe ../../../../core/unitUtils ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/math/common ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./polygonUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/WaterMaterial ../../webgl-engine/materials/internal/waterMaterialUtils".split(" "),
function(n,v,C,D,E,F,G,r,H,x,y,I,t,J,K,l,w,L,p,M,N,O,q,P,Q,R,z,A){Object.defineProperty(v,"__esModule",{value:!0});n=function(n){function d(a,b,e,d){return n.call(this,a,b,e,d)||this}D(d,n);d.prototype.doLoad=function(){return F(this,void 0,void 0,function(){var a,b;return E(this,function(e){a=A.waterParameterDefaultsLocal;b=C({},a);this._updateMaterialParameters(b);b.isDraped=!0;this._drapedMaterial=new z.WaterMaterial(b,"waterDraped");this._context.stage.add(3,this._drapedMaterial);this._updateMaterialParameters(a);
this._material=new z.WaterMaterial(a,"water");this._context.stage.add(3,this._material);return[2]})})};d.prototype.destroy=function(){n.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._material=null);this._drapedMaterial&&(this._context.stage.remove(3,this._drapedMaterial.id),this._drapedMaterial=null)};d.prototype.createGraphics3DGraphic=function(a){a=a.graphic;if(!this._validateGeometryType(a.geometry,d.validGeometryTypes,this.symbolLayer.type)||
!this._validateGeometry(a.geometry))return null;var b="graphic"+a.uid,e=this.getGraphicElevationContext(a);return"on-the-ground"===e.mode?this._createAsOverlay(a,b):this._createAs3DShape(a,e,b,a.uid)};d.prototype.layerOpacityChanged=function(){var a=this._material.getParameters().color,b=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),e=1>b||this.needsDrivenTransparentPass;this._material.setParameterValues({color:[a[0],a[1],a[2],b],transparent:e});this._drapedMaterial.setParameterValues({color:[a[0],
a[1],a[2],b],transparent:e});return!0};d.prototype.layerElevationInfoChanged=function(a,b,e){var f=this._elevationContext.mode;e=p.elevationModeChangeUpdateType(d.elevationModeChangeTypes,e,f);if(e!==p.SymbolUpdateType.UPDATE)return e;var c=p.needsElevationUpdates2D(f);return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return c})};d.prototype.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});this._drapedMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});
return!0};d.prototype.physicalBasedRenderingChanged=function(){return!0};d.prototype.pixelRatioChanged=function(){return!0};d.prototype._createAs3DShape=function(a,b,e,d){a=q.geometryAsPolygon(a.geometry);if(r.isNone(a))return null;f.renderData=q.geometryToRenderInfo(a,this._context.elevationProvider,this._context.renderCoordsHelper,b);var c=f.renderData.position.length/3;f.uvCoords=new Float64Array(2*c);f.idHint=e;f.outNum=0;f.outGeometries=[];f.outTransforms=[];f.outMaterials=[];this._create3DShapeGeometries(f);
this._logGeometryCreationWarnings(f.renderData,a.rings,"rings","WaterSymbol3DLayer");if(0===f.outNum)return null;this._createUVCoordsFromVertices(f.uvCoords,f.renderData.mapPosition,c,this._context.elevationProvider.spatialReference);e=new Q({geometries:f.outGeometries,materials:f.outMaterials,transformations:f.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:d},idHint:e});e=new N(this,e,f.outGeometries,null,null,L.perVertexElevationAligner,b);e.alignedSampledElevation=
f.renderData.sampledElevation;e.needsElevationUpdates=p.needsElevationUpdates2D(b.mode);return e};d.prototype._createUVCoordsFromVertices=function(a,b,e,f){f=H.getMetersPerUnitForSR(f);w.empty(k);for(var c=0;c<e;c++)I.vec2.set(B,b[3*c+0],b[3*c+1]),w.expandPointInPlace(k,B);J.vec4.scale(k,k,f);c=k[1]%d.unitSizeOfTexture;u[0]=k[0]-k[0]%d.unitSizeOfTexture;u[1]=k[1]-c;for(c=0;c<e;c++)a[2*c+0]=(b[3*c+0]*f-u[0])/d.unitSizeOfTexture,a[2*c+1]=(b[3*c+1]*f-u[1])/d.unitSizeOfTexture};d.prototype._create3DShapeGeometries=
function(a){for(var b=a.uvCoords,e=0,d=a.renderData.polygons;e<d.length;e++){var c=d[e],f=c.count,g=c.index,h=c.position,k=c.mapPosition,c=c.holeIndices;if(r.isSome(this._context.clippingExtent)&&(l.empty(m),l.expandWithBuffer(m,k),!l.intersectsClippingArea(m,this._context.clippingExtent)))continue;c=x(k,c,3);0!==c.length&&(c=new Uint32Array(c),f=new Float64Array(b.buffer,2*g*b.BYTES_PER_ELEMENT,2*f),h=q.createWaterGeometryData({indices:c,attributeData:{position:h,uv0:f,mapPosition:k}}),h=new P(h,
a.idHint),a.outGeometries.push(h),a.outMaterials.push(this._material),a.outTransforms.push(y.mat4f64.IDENTITY),a.outNum++)}};d.prototype._updateMaterialParameters=function(a){var b=this.symbolLayer.color;r.isSome(b)&&(a.color=G.toUnitRGBA(b));b=this._getCombinedOpacity(b,{hasIntrinsicColor:!0});a.color=[a.color[0],a.color[1],a.color[2],b];a.transparent=1>b||this.needsDrivenTransparentPass;a.waveDirection=r.isSome(this.symbolLayer.waveDirection)?d.headingVectorFromAngle(this.symbolLayer.waveDirection):
t.vec2f64.fromValues(0,0);b=A.wavePresets[this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize];a.waveStrength=b.waveStrength;a.waveTextureRepeat=b.textureRepeat;a.waveVelocity=b.waveVelocity;a.flowStrength=b.perturbationStrength;a.slicePlaneEnabled=this._context.slicePlaneEnabled};d.prototype._createAsOverlay=function(a,b){var e=q.geometryAsPolygon(a.geometry);if(r.isNone(e))return null;this._drapedMaterial.renderPriority=this._renderPriority+this._renderPriorityDelta/2;g.renderData=
q.geometryToRenderInfoDraped(e,this._context.overlaySR);g.idHint=b;b=g.renderData.position.length/3;g.uvCoords=new Float64Array(2*b);g.outNum=0;g.outGeometries=[];g.outBoundingBox=l.empty();g.layerUid=this._context.layer.uid;g.graphicsUid=a.uid;this._createAsOverlayWater(g);this._logGeometryCreationWarnings(g.renderData,e.rings,"rings","WaterSymbol3DLayer");if(0===g.outNum)return null;this._createUVCoordsFromVertices(g.uvCoords,g.renderData.position,b,e.spatialReference);return 0<g.outNum?new M(this,
g.outGeometries,g.outBoundingBox):null};d.prototype._createAsOverlayWater=function(a){for(var b=a.uvCoords,e=0,d=a.renderData.polygons;e<d.length;e++){var c=d[e],f=c.position,g=c.holeIndices,h=c.index,c=c.count;l.empty(m);l.expandWithBuffer(m,f);l.intersectsClippingArea(m,this._context.clippingExtent)&&(l.expand(a.outBoundingBox,m),g=x(f,g,3),0!==g.length&&(g=new Uint32Array(g),h=new Float64Array(b.buffer,2*h*b.BYTES_PER_ELEMENT,2*c),f=q.createWaterGeometryData({indices:g,attributeData:{position:f,
uv0:h}}),h=new R(f),h.data.layerUid=a.layerUid,h.data.graphicUid=a.graphicsUid,h.material=this._drapedMaterial,c=m,h.center=[.5*(c[0]+c[3]),.5*(c[1]+c[4]),0],h.bsRadius=.5*Math.sqrt((c[3]-c[0])*(c[3]-c[0])+(c[4]-c[1])*(c[4]-c[1])),h.transformation=y.mat4f64.create(),h.name=a.idHint,h.uniqueName=a.idHint+"#"+f.id,a.outGeometries.push(h),a.outNum++))}};d.headingVectorFromAngle=function(a){var b=t.vec2f64.create();a=K.toRadian(a);b[0]=Math.sin(a);b[1]=Math.cos(a);return b};Object.defineProperty(d.prototype,
"test",{get:function(){var a=this;return{create3DShape:function(b){return a._createAs3DShape(b.graphic,b.elevationContext,b.idHint,b.graphicUid)}}},enumerable:!0,configurable:!0});d.validGeometryTypes=["polyline","polygon","extent"];d.unitSizeOfTexture=100;d.elevationModeChangeTypes={definedChanged:p.SymbolUpdateType.RECREATE,staysOnTheGround:p.SymbolUpdateType.NONE,onTheGroundChanged:p.SymbolUpdateType.RECREATE};return d}(O.default);v.Graphics3DWaterSymbolLayer=n;var u=t.vec2f64.create(),k=w.create(),
B=t.vec2f64.create(),m=l.create(),f={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},g={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};v.default=n});