// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/PooledArray ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingRect ./deconflictorDebug ../../support/debugFlags ../../support/earthUtils ../../support/geometryUtils ../../support/geometryUtils/sphere ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/Util ../../webgl-engine/materials/HUDMaterial ../../webgl-engine/materials/internal/MaterialUtil ../../../support/index".split(" "),
function(H,I,Q,R,D,S,T,J,U,k,V,r,W,y,K,u,t,v,X,Y,z,Z,aa,L,ba,B,E){function F(f){f=f.layer;return!(!f||!f.featureReduction||"selection"!==f.featureReduction.type)}function ca(f){(f=f.graphics3DCore.graphics3DGraphics)&&f.forEach(function(b){return b.clearVisibilityFlag(3)})}function da(f){var b,a,c,d,w,e;return R(this,function(g){switch(g.label){case 0:if(!Map.prototype.entries)return[3,5];b=f.entries();a=b.next();g.label=1;case 1:return a.done?[3,4]:[4,a.value[1]];case 2:g.sent(),g.label=3;case 3:return a=
b.next(),[3,1];case 4:return[3,9];case 5:c=Array(f.size),d=0,f.forEach(function(a){return c[d++]=a}),w=0,e=c,g.label=6;case 6:if(!(w<e.length))return[3,9];a=e[w];return[4,a];case 7:g.sent(),g.label=8;case 8:return w++,[3,6];case 9:return[2]}})}Object.defineProperty(I,"__esModule",{value:!0});var M=u.vec4f64.create(),A=u.vec4f64.create(),N=u.vec4f64.create(),ea=u.vec4f64.create(),O=z.sphere.create(),C=z.ray.create(),P=K.vec3f64.create(),fa=t.create(),ga=t.create(),ha=function(){return function(){this.posView=
this.yMax=this.yMin=this.xMax=this.xMin=0;this.pooled=this.visible=this.culled=!1}}(),ia=function(){return function(f,b,a){void 0===a&&(a={});this.graphics3DGraphic=f;this.slicePlaneEnabled=b;this.info=a}}(),ja=function(){return function(f,b){void 0===b&&(b=new Map);this.graphics3DCore=f;this.graphics=b}}();H=function(f){function b(){var a,c,d=null!==f&&f.apply(this,arguments)||this;d.handles=new T;d.dirty=!1;d.state=0;d.contexts=[];d.graphics=(a={},a[0]={active:new Map,visible:new k,remove:new k},
a[1]={active:new Map,visible:new k,remove:new k},a);d.iterators=(c={},c[0]={active:null,visible:null,remove:null,sort:null},c[1]={active:null,visible:null,remove:null,sort:null},c);d.accBinsNumX=15;d.accBinsNumY=20;d.accBinsSizeX=0;d.accBinsSizeY=0;d.accBins=null;d.accNumTests=0;d._iconMarginFactor=-.1;d.slicePlaneViewSpace=null;return d}Q(b,f);Object.defineProperty(b.prototype,"iconMarginFactor",{get:function(){return this._iconMarginFactor},set:function(a){this._iconMarginFactor=a;this.setDirty()},
enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;this.handles.add([this.view.watch("state.camera",function(){a.updateSlicePlane();a.setDirtyUrgent()}),this.view.watch("map.ground.opacity",function(c,d){1!==c&&1!==d||a.setDirtyUrgent()}),V.init(this.view,"slicePlane",function(){return a.updateSlicePlane()})]);this.frameWorker=this.view.resourceController.scheduler.registerTask(E.Task.DECONFLICTOR_DELAYED,function(c){return a.update(c)},function(){return a.needsUpdate()})};
b.prototype.updateSlicePlane=function(){var a=this.view&&this.view.slicePlane;a?(this.slicePlaneViewSpace||(this.slicePlaneViewSpace=z.boundedPlane.create()),z.boundedPlane.transform(a,this.view.state.camera.viewMatrix,this.slicePlaneViewSpace),this.slicePlaneChanged()):this.slicePlaneViewSpace&&(this.slicePlaneViewSpace=null,this.slicePlaneChanged())};b.prototype.slicePlaneChanged=function(){for(var a=0,c=this.contexts;a<c.length;a++)if(c[a].graphics3DCore.symbolCreationContext.slicePlaneEnabled){this.setDirty();
break}};b.prototype.destroy=function(){this.handles.destroy();this.handles=null;this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null);this.iterators=this.graphics=null};b.prototype.addGraphicsOwner=function(a){var c=this,d=this.findDeconflictionContext(a),b;-1!==d?b=this.contexts[d]:(b=new ja(a),this.contexts.push(b),this.setDirtyUrgent());return{addGraphic:function(a){return c.addGraphic(b,a)},removeGraphic:function(a){return c.removeGraphic(b,a)},labelingInfoChange:function(){return c.globalLabelingInfoChanged(b)},
visibilityInfoChange:function(){},featureReductionChange:function(){return c.globalFeatureReductionChanged(b)},slicePlaneEnabledChange:function(){return c.globalSlicePlaneEnabledChanged(b)},clear:function(){return b.graphics.forEach(function(a){return c.removeGraphic(b,a.graphics3DGraphic)})}}};b.prototype.removeGraphicsOwner=function(a){var c=this;a=this.findDeconflictionContext(a);if(-1!==a){var d=this.contexts.splice(a,1)[0];d.graphics.forEach(function(a){return c.removeGraphic(d,a.graphics3DGraphic)});
this.setDirtyUrgent()}};b.prototype.setInitialIconVisibilityFlag=function(a,c){a=!(this.graphicSupportsDeconfliction(c)&&F(a));c.setVisibilityFlag(3,a,0)};b.prototype.setDirtyUrgent=function(){!this.dirty&&0<this.contexts.length&&(this.dirty=!0,this.notifyChange("updating"));this.frameWorker.task=E.Task.DECONFLICTOR_IMMEDIATE};b.prototype.setDirty=function(){!this.dirty&&0<this.contexts.length&&(this.dirty=!0,this.notifyChange("updating"),this.frameWorker.task=E.Task.DECONFLICTOR_DELAYED)};Object.defineProperty(b.prototype,
"updating",{get:function(){return 0!==this.state||this.dirty},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updatingProgress",{get:function(){if(!this.updating)return 1;var a=this.state/9;return this.dirty?.5*a:a},enumerable:!0,configurable:!0});b.prototype.needsUpdate=function(){return this.view.ready&&null!=this.view.state&&this.updating};b.prototype.update=function(a){switch(this.state){case 0:this.startUpdate(),a.madeProgress();case 1:if(this.state=1,!this.processActiveGraphics(0,
a))break;case 2:if(this.state=2,!this.cleanVisibleGraphics(0,a))break;case 3:if(this.state=3,!this.sortVisibleGraphics(0,a))break;case 4:this.state=4;if(!this.deconflictVisibleGraphics(0,a))break;v.drawAccelerationStruct(this,this.graphics[0].visible);case 5:if(this.state=5,!this.processActiveGraphics(1,a))break;case 6:if(this.state=6,!this.cleanVisibleGraphics(1,a))break;case 7:if(this.state=7,!this.sortVisibleGraphics(1,a))break;case 8:this.state=8;if(!this.deconflictVisibleGraphics(1,a))break;
v.drawAccelerationStruct(this,this.graphics[1].visible);default:this.state=0,this.notifyChange("updating")}};b.prototype.findDeconflictionContext=function(a){for(var c=0;c<this.contexts.length;c++)if(this.contexts[c].graphics3DCore===a)return c;return-1};b.prototype.globalFeatureReductionChanged=function(a){var c=F(a.graphics3DCore);c||ca(a);this.modifyGraphics(a,c,0)};b.prototype.globalLabelingInfoChanged=function(a){this.modifyGraphics(a,a.graphics3DCore.labelsEnabled,1)};b.prototype.globalSlicePlaneEnabledChanged=
function(a){var c=a.graphics3DCore.symbolCreationContext.slicePlaneEnabled;a.graphics.forEach(function(a){a.slicePlaneEnabled=c});this.setDirtyUrgent()};b.prototype.modifyGraphics=function(a,c,d){var b=this;c?a.graphics.forEach(function(a){return b.addToActiveGraphics(a,d)}):a.graphics.forEach(function(a){return b.removeFromActiveGraphics(a,d)});this.setDirtyUrgent()};b.prototype.graphicSupportsDeconfliction=function(a){var c=a._graphics;if(!c||!c.length||a.isDraped())return!1;for(a=0;a<c.length;a++)if(this.graphics3DGraphicsLayerSupportsDeconfliction(c[a]))return!0;
return!1};b.prototype.graphics3DGraphicsLayerSupportsDeconfliction=function(a){if(U.isNone(a)||"object3d"!==a.type)return!1;a=a.stageObject;return 1===(a?a.getNumGeometryRecords():0)&&a.getGeometryRecord(0).material instanceof ba?!0:!1};b.prototype.addGraphic=function(a,c){var d=c.graphic.uid;c=new ia(c,a.graphics3DCore.symbolCreationContext.slicePlaneEnabled);a.graphics.set(d,c);F(a.graphics3DCore)&&this.addToActiveGraphics(c,0);a.graphics3DCore.labelsEnabled&&this.addToActiveGraphics(c,1);this.setDirty()};
b.prototype.removeGraphic=function(a,c){c=c.graphic.uid;var d=a.graphics.get(c);d&&(this.removeFromActiveGraphics(d,0),this.removeFromActiveGraphics(d,1),a.graphics.delete(c),this.setDirty())};b.prototype.startUpdate=function(){v.prepare(this.view);this.dirty=!1;this.camera=this.view.state.camera;this.initBins(this.camera.fullWidth,this.camera.fullHeight);this.resetIterators()};b.prototype.addToActiveGraphics=function(a,c){a.info[c]=new ha;this.graphics[c].active.set(a.graphics3DGraphic.graphic.uid,
a)};b.prototype.removeFromActiveGraphics=function(a,c){this.removeFromVisibleGraphics(a,c);var d=a.graphics3DGraphic;d.destroyed||d.clearVisibilityFlag(3,c);delete a.info[c];this.graphics[c].active.delete(a.graphics3DGraphic.graphic.uid)};b.prototype.addToVisibleGraphics=function(a,c){var d=a.info[c];d&&!d.pooled&&(this.graphics[c].visible.push(a),d.pooled=!0)};b.prototype.removeFromVisibleGraphics=function(a,c){var d=a.info[c];d&&d.pooled&&(this.graphics[c].remove.push(a),d.pooled=!1)};b.prototype.processActiveGraphics=
function(a,c){for(var d=this.ensureActiveGraphicsIterator(a),b="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this.camera&&0<this.camera.relativeElevation;!c.done;){c.madeProgress();var e=d.next();if(e.done)return this.resetActiveGraphicsIterator(a),!0;var g=(e=e.value)&&e.info[a];g&&(this.collectGraphics3DGraphics(e,a,b),g.culled?this.removeFromVisibleGraphics(e,a):this.addToVisibleGraphics(e,a))}return!1};b.prototype.cleanVisibleGraphics=function(a,c){for(var d=this.graphics[a],
b=this.ensureRemoveGraphicsIterator(a);!c.done;){var e=b.next();c.madeProgress();if(e.done)return d.remove.clear(),this.resetRemoveGraphicsIterator(a),!0}return!1};b.prototype.sortVisibleGraphics=function(a,c){for(var d=this.ensureSortGraphicsIterator(a);!c.done;){var b=d.next();c.madeProgress();if(b.done)return this.resetSortGraphicsIterator(a),!0}return!1};b.prototype.deconflictVisibleGraphics=function(a,c){for(var b=this.ensureVisibleGraphicsIterator(a),w=1===a;!c.done;){c.madeProgress();var e=
b.next();if(e.done)return this.resetVisibleGraphicsIterator(a),!0;var e=e.value,g=e.info[a];if(g&&!g.culled){var f=e.graphics3DGraphic,f=!(w&&!f.isVisible())&&!this.doesIntersectExistingPoly(e,a);(g.visible=f)&&this.addToBins(e,a);this.setGraphicVisibility(e,a,f);v.drawPoly(g,f)}}return!1};b.prototype.resetIterators=function(){this.iterators[0].active=null;this.iterators[0].visible=null;this.iterators[0].remove=null;this.iterators[0].sort=null;this.iterators[1].active=null;this.iterators[1].visible=
null;this.iterators[1].remove=null;this.iterators[1].sort=null};b.prototype.ensureActiveGraphicsIterator=function(a){var c=this.graphics[a];a=this.iterators[a];a.active||(a.active=da(c.active));return a.active};b.prototype.resetActiveGraphicsIterator=function(a){this.iterators[a].active=null};b.prototype.ensureVisibleGraphicsIterator=function(a){var c=this.graphics[a];a=this.iterators[a];a.visible||(a.visible=c.visible.iterableForEach());return a.visible};b.prototype.resetVisibleGraphicsIterator=
function(a){this.iterators[a].visible=null};b.prototype.ensureRemoveGraphicsIterator=function(a){var c=this.graphics[a];a=this.iterators[a];a.remove||(a.remove=c.visible.iterableRemoveMany(c.remove));return a.remove};b.prototype.resetRemoveGraphicsIterator=function(a){this.iterators[a].remove=null};b.prototype.ensureSortGraphicsIterator=function(a){var c=this.graphics[a],b=this.iterators[a];b.sort||(b.sort=c.visible.iterableSort(function(c,b){return c.info[a]&&b.info[a]?b.info[a].posView-c.info[a].posView:
Number.MAX_VALUE}));return b.sort};b.prototype.resetSortGraphicsIterator=function(a){this.iterators[a].sort=null};b.prototype.collectGraphics3DGraphics=function(a,c,b){var d=a.graphics3DGraphic;if(!d.destroyed){var e=a.info[c];if(d.isVisible(0,3)){d=(c=1===c)?d._labelGraphics:d._graphics;c=c?0:this.iconMarginFactor;for(var g=t.empty(fa),f,h,p=0;p<d.length;p++){var n=d[p];if(this.graphics3DGraphicsLayerSupportsDeconfliction(n)){var q=n.stageObject,x=q.getGeometryRecord(0),l=x.material,m=this.camera,
k=x.geometry.data.getVertexAttr();if(b&&(O.radius=Y.earthRadius,y.vec3.sub(C.direction,q.getCenter(),this.camera.eye),y.vec3.copy(C.origin,this.camera.eye),Z.intersectRay(O,C,P))){var r=1-Math.abs(Math.tan(y.vec3.angle(q.getCenter(),C.direction)))/this.view.width,r=Math.pow(r,4),u=y.vec3.sqrDist(this.camera.eye,P),v=y.vec3.sqrDist(this.camera.eye,q.getCenter());if(r*v>u){e.culled=!0;return}}if(!h){h=q.getCenter();x=x.origin.vec3;B.transformToWorld(h,x,M);B.transformToView(M,x,m.viewMatrix,A);l.applyVerticalOffsetTransformation(A,
k[L.VertexAttrConstants.NORMAL].data,q.objectTransformation,m,G);if(a.slicePlaneEnabled&&this.slicePlaneViewSpace&&z.boundedPlane.extrusionContainsPoint(this.slicePlaneViewSpace,A)){e.culled=!0;return}q=k[L.VertexAttrConstants.AUXPOS1].data;k="screen"!==l.getParameters().centerOffsetUnits;B.transformToProjection(A,m.projectionMatrix,k?q:K.vec3f64.ZEROS,N);h=B.transformToNDC(N,ea);k||(h[0]+=q[0]/m.fullWidth*2,h[1]+=q[1]/m.fullHeight*2);if(-1>h[0]||-1>h[1]||-1>h[2]||1<=h[0]||1<=h[1])break;f=A[2];!X.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&
e.visible&&(f*=.7)}n=n.getScreenSize(ka);n[0]*=m.pixelRatio;n[1]*=m.pixelRatio;aa.applyPrecomputedScaleFactorVec2(n,G.factor,n);l=t.offset(l.calculateRelativeScreenBounds(n,G.factorAlignment.scale,ga),J.lerp(0,m.fullWidth,.5+.5*h[0]),J.lerp(0,m.fullHeight,.5+.5*h[1]));0!==c&&(m=c*Math.min(t.width(l),t.height(l)),l[0]-=m,l[1]-=m,l[2]+=m,l[3]+=m);t.expand(g,l)}}null==f?e.culled=!0:(e.xMin=g[0],e.yMin=g[1],e.xMax=g[2],e.yMax=g[3],e.posView=f,e.culled=!1)}else e.culled=!0}};b.prototype.doesIntersectExistingPoly=
function(a,c){var b=a.graphics3DGraphic.graphic.uid;a=a.info[c];for(var f=Math.floor(a.xMin/this.accBinsSizeX);f<=Math.floor(a.xMax/this.accBinsSizeX);f++)if(!(0>f||f>=this.accBinsNumX))for(var e=Math.floor(a.yMin/this.accBinsSizeY);e<=Math.floor(a.yMax/this.accBinsSizeY);e++)if(!(0>e||e>=this.accBinsNumY))for(var g=this.accBins[f][e],k=0;k<g.length;k++){var h=g.data[k],p=h.info[c];if(p&&p.visible&&h.graphics3DGraphic.graphic.uid!==b&&(this.accNumTests++,!(p.xMin>a.xMax||p.xMax<a.xMin||p.yMin>a.yMax||
p.yMax<a.yMin)))return!0}return!1};b.prototype.initBins=function(a,c){if(null==this.accBins){this.accBins=[];for(var b=0;b<this.accBinsNumX;b++){this.accBins.push([]);for(var f=this.accBins[this.accBins.length-1],e=0;e<this.accBinsNumY;e++)f.push(new k)}}for(b=0;b<this.accBinsNumX;b++)for(e=0;e<this.accBinsNumY;e++)this.accBins[b][e].clear();this.accBinsSizeX=a/this.accBinsNumX;this.accBinsSizeY=c/this.accBinsNumY;this.accNumTests=0};b.prototype.addToBins=function(a,c){var b=a.info[c];c=Math.floor(b.xMax/
this.accBinsSizeX);for(var f=Math.floor(b.yMin/this.accBinsSizeY),e=Math.floor(b.yMax/this.accBinsSizeY),b=Math.floor(b.xMin/this.accBinsSizeX);b<=c;b++)if(!(0>b||b>=this.accBinsNumX))for(var g=f;g<=e;g++)0>g||g>=this.accBinsNumY||this.accBins[b][g].push(a)};b.prototype.setGraphicVisibility=function(a,b,d){a=a.graphics3DGraphic;a.destroyed||(a.setVisibilityFlag(3,d,b),1===b&&this.view.labeler.setLabelGraphicVisibility(a,d))};D([r.property({constructOnly:!0})],b.prototype,"view",void 0);D([r.property({type:Boolean,
readOnly:!0})],b.prototype,"updating",null);return b=D([r.subclass("esri.views.3d.layers.graphics.Deconflictor")],b)}(r.declared(S));I.Deconflictor=H;var G={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},ka=W.vec2f64.create()});