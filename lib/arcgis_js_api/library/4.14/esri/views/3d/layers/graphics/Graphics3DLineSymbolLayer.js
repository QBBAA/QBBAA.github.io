// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/assignHelper ../../../../Color ../../../../geometry ../../../../core/Error ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../renderers/support/renderingInfoUtils ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./lineUtils ../support/FastSymbolUpdates ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/RibbonLineMaterial".split(" "),
function(h,v,B,C,D,E,F,x,G,d,k,y,H,r,I,J,t,K,L,u,w,z,M,N,O,P,A){Object.defineProperty(v,"__esModule",{value:!0});h=function(h){function b(a,c,b,m){a=h.call(this,a,c,b,m)||this;a._uniformSize=1;return a}B(b,h);b.prototype.doLoad=function(){return D(this,void 0,void 0,function(){var a;return C(this,function(c){this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};
this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?z.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};if(!this._drivenProperties.size){a=null!=this.symbolLayer.size?this.symbolLayer.size:k.px2pt(1);if(0>a)throw new G("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=a}return[2]})})};b.prototype.getMaterialParameters=function(a){var c=
this._getCombinedOpacityAndColor(d.get(this.symbolLayer,"material","color"));a={width:1,color:c,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:1>c[3]||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:a,stipplePattern:this.symbolLayer.stipplePattern?P.createStipplePattern(this.symbolLayer.stipplePattern.map(k.pt2px)):null,stippleOffColor:this.symbolLayer.stippleOffColor?F.toUnitRGBA(this.symbolLayer.stippleOffColor):
null,stippleIntegerRepeats:!0};this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(a.width=k.pt2px(1)):(c=null!=this.symbolLayer.size?this.symbolLayer.size:k.px2pt(1),a.width=k.pt2px(c));return this._fastUpdates&&this._fastUpdates.visualVariables?E({},a,this._fastUpdates.materialParameters):a};Object.defineProperty(b.prototype,"lineMaterial",{get:function(){d.isNone(this._lineMaterial)&&(this._lineMaterial=new A(this.getMaterialParameters(!1),this._getIdHint("_ribbonlinemat")),
this._context.stage.add(3,this._lineMaterial));return this._lineMaterial},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"ringMaterial",{get:function(){d.isNone(this._ringMaterial)&&(this._ringMaterial=new A(this.getMaterialParameters(!0),this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._ringMaterial));return this._ringMaterial},enumerable:!0,configurable:!0});b.prototype.destroy=function(){h.prototype.destroy.call(this);d.isSome(this._lineMaterial)&&(this._context.stage.remove(3,
this._lineMaterial.id),this._lineMaterial=null);d.isSome(this._ringMaterial)&&(this._context.stage.remove(3,this._ringMaterial.id),this._ringMaterial=null)};b.prototype.getDrivenSize=function(a){return this._drivenProperties.size&&a.size?k.pt2px(I.getDriverAxisSizeValue(a.size)):1};b.prototype.getSizeFeatureAttributeData=function(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?u.getAttributeValue(this._fastUpdates.visualVariables.size.field,a):null};b.prototype.getDrivenColor=
function(a){var c=H.vec4f64.fromValues(1,1,1,1);this._drivenProperties.color&&a.color&&(c[0]=a.color[0],c[1]=a.color[1],c[2]=a.color[2],0<a.color.length&&(c[3]=a.color[3]));this._drivenProperties.opacity&&a.opacity&&(c[3]=a.opacity);return c};b.prototype.getColorFeatureAttributeData=function(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?u.getAttributeValue(this._fastUpdates.visualVariables.color.field,a):null};b.prototype.getOpacityFeatureAttributeData=function(a){return this._fastUpdates.enabled&&
this._fastUpdates.visualVariables.opacity?u.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,a):null};b.prototype.createGraphics3DGraphic=function(a){var c=a.graphic,f=c.geometry;if(!this._validateGeometryType(c.geometry,b.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(f))return null;var f="graphic"+c.uid,m=this.getGraphicElevationContext(c);return"on-the-ground"===m.mode?this._createAsOverlay(a,f,this._context.layer.uid):this._createAs3DShape(a,m,f,c.uid)};b.prototype.applyRendererDiff=
function(a,c){for(var b in a.diff)switch(b){case "visualVariables":if(z.updateFastSymbolUpdatesState(this._fastUpdates,c,this._vvConvertOptions))d.isSome(this._lineMaterial)&&this._lineMaterial.setParameterValues(this._fastUpdates.materialParameters),d.isSome(this._ringMaterial)&&this._ringMaterial.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};b.prototype.layerOpacityChanged=function(){d.isSome(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial);
d.isSome(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial);return!0};b.prototype.updateMaterialLayerOpacity=function(a){var c=a.getParameters().color,b=d.get(this.symbolLayer,"material","color"),b=this._getCombinedOpacity(b);a.setParameterValues({color:[c[0],c[1],c[2],b],transparent:1>b||this.needsDrivenTransparentPass})};b.prototype.layerElevationInfoChanged=function(a,c,f){var m=this._elevationContext.mode;f=t.elevationModeChangeUpdateType(b.elevationModeChangeTypes,f,m);
if(f!==t.SymbolUpdateType.UPDATE)return f;var Q=t.needsElevationUpdates2D(m);return this.updateGraphics3DGraphicElevationInfo(a,c,function(){return Q})};b.prototype.slicePlaneEnabledChanged=function(){d.isSome(this._lineMaterial)&&this._lineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});d.isSome(this._ringMaterial)&&this._ringMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};b.prototype.physicalBasedRenderingChanged=function(){return!0};
b.prototype.pixelRatioChanged=function(){return!0};b.prototype._getGeometryAsPolygonOrPolyline=function(a){switch(a.type){case "extent":if(a instanceof x.Extent)return x.Polygon.fromExtent(a);break;case "polygon":case "polyline":return a}return null};b.prototype._createAs3DShape=function(a,b,f,m){var c=this._getGeometryAsPolygonOrPolyline(a.graphic.geometry),l="polygon"===c.type?c.rings:c.paths,n=[],h=[],e=[],k=r.create(),p=w.geometryToRenderInfo(c,this._context.elevationProvider,this._context.renderCoordsHelper,
b);this._logGeometryCreationWarnings(p,l,"polygon"===c.type?"rings":"paths","LineSymbol3DLayer");for(l=0;l<p.lines.length;l++){var q=p.lines[l],g=q.position,q=q.mapPosition;if(d.isSome(this._context.clippingExtent)&&(r.empty(k),r.expandWithBuffer(k,q),!r.intersectsClippingArea(k,this._context.clippingExtent)))continue;g=this._createGeometryData(a,g,q,c.type);g=new M(g,f+"path"+l);n.push(g);h.push("polygon"===c.type?this.ringMaterial:this.lineMaterial);e.push(y.mat4f64.IDENTITY)}if(0===n.length)return null;
a=new N({geometries:n,materials:h,transformations:e,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:m},idHint:f});n=new L(this,a,n,null,null,J.perVertexElevationAligner,b);n.alignedSampledElevation=p.sampledElevation;n.needsElevationUpdates=t.needsElevationUpdates2D(b.mode);return n};b.prototype._createGeometryData=function(a,b,f,m){var c=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color;return w.createGeometryData({removeDuplicateStartEnd:"polygon"===m?1:0,uniformSize:this._uniformSize,
attributeData:{position:b,mapPosition:f,size:this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?null:this.getDrivenSize(a.renderingInfo),color:c?null:this.getDrivenColor(a.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(a.graphic),colorFeature:this.getColorFeatureAttributeData(a.graphic),opacityFeature:this.getOpacityFeatureAttributeData(a.graphic)}})};b.prototype._createAsOverlay=function(a,b,f){var c=a.graphic,d=this._getGeometryAsPolygonOrPolyline(c.geometry),l="polygon"===
d.type?d.rings:d.paths,n="polygon"===d.type?this.ringMaterial:this.lineMaterial;n.renderPriority=this._renderPriority;var h=[],e=r.create(),k=r.empty(),p=w.geometryToRenderInfoDraped(d,this._context.overlaySR);this._logGeometryCreationWarnings(p,l,"polygon"===d.type?"rings":"paths","LineSymbol3DLayer");if(0<l.length){l=p.lines;for(p=0;p<l.length;++p){var q=l[p];r.empty(e);r.expandWithBuffer(e,q.position);if(r.intersectsClippingArea(e,this._context.clippingExtent)){r.expand(k,e);var q=this._createGeometryData(a,
q.position,null,d.type),g=new O(q);g.data.layerUid=f;g.data.graphicUid=c.uid;g.material=n;g.center=[.5*(e[0]+e[3]),.5*(e[1]+e[4]),0];g.bsRadius=.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*(e[4]-e[1]));g.transformation=y.mat4f64.create();g.name=b;g.uniqueName=b+"#"+q.id;h.push(g)}}return new K(this,h,k)}return null};b.validGeometryTypes=["polyline","polygon","extent"];b.elevationModeChangeTypes={definedChanged:t.SymbolUpdateType.RECREATE,staysOnTheGround:t.SymbolUpdateType.NONE,onTheGroundChanged:t.SymbolUpdateType.RECREATE};
return b}(u.Graphics3DSymbolLayer);v.Graphics3DLineSymbolLayer=h;v.default=h});