// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/asyncUtils ../../../core/Logger ../../../core/promiseUtils ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4f64 ../../../geometry/Extent ../../../geometry/support/aaBoundingRect ./LayerView3D ./support/overlayImageUtils ./support/projectExtentUtils ../support/debugFlags ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ../webgl-engine/materials/DefaultMaterial ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),
function(v,O,z,h,A,q,m,B,C,r,w,D,e,E,x,l,F,t,G,H,I,J,K,L,M){var y=C.getLogger("esri.views.3d.layers.DynamicLayerView3D");v=function(u){function d(){var a=null!==u&&u.apply(this,arguments)||this;a.supportsDraping=!0;a.hasDraped=!0;a.fullExtentInLocalViewSpatialReference=null;a.maximumDataResolution=null;a._images=[];a._extents=[];a.updateWhenStationary=!0;return a}z(d,u);d.prototype.initialize=function(){var a=this;this.addResolvingPromise(G.toViewIfLocal(this).then(function(c){return a._set("fullExtentInLocalViewSpatialReference",
c)}));this.updatingHandles.add(this,"suspended",function(){return a._suspendedChangeHandler()});this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(function(){a._isScaleRangeActive()&&a.notifyChange("suspended")},function(){}));this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,"scaleRangeId",function(){return a.notifyChange("suspended")});this.updatingHandles.add(this,"fullOpacity",function(c){return a._opacityChangeHandler(c)})};d.prototype.destroy=function(){this.clear()};
d.prototype.setDrapingExtent=function(a,c,f,b,d,g){var n=this._clippedExtent(c,N);c=t.computeImageExportSize(c,n,b);g*=this.view.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){b=this.layer.imageMaxWidth;var e=this.layer.imageMaxHeight;if(c.width>b){var k=b/c.width;c.height=Math.floor(c.height*k);c.width=b;g*=k}c.height>e&&(k=e/c.height,c.width=Math.floor(c.width*k),c.height=e,g*=k)}b=this._extents[a];b&&l.equals(b.extent,n)&&!this._imageSizeDiffers(n,b.imageSize,c)||(this._extents[a]=
{extent:l.create(n),spatialReference:f,imageSize:c,renderLocalOrigin:d,pixelRatio:g},this.suspended||this._fetch(a))};d.prototype.getGraphicFromGraphicUid=function(){return null};d.prototype.clear=function(){for(var a=0;a<this._images.length;a++)this._clearImage(a)};d.prototype.doRefresh=function(a){return m(this,void 0,void 0,function(){var c,f;return q(this,function(b){switch(b.label){case 0:if(this.suspended)return[2];c=[];for(f=0;f<this._extents.length;f++)this._extents[f]&&c.push(this._fetch(f,
a));return[4,r.eachAlways(c)];case 1:return b.sent(),[2]}})})};d.prototype.canResume=function(){if(!this.inherited(arguments))return!1;if(this._isScaleRangeLayer()){var a=this.layer,c=a.minScale,a=a.maxScale;if(0<c||0<a){var f=this.view.scale;if(f<a||0<c&&f>c)return!1}}return!0};d.prototype.isUpdating=function(){return this._images.some(function(a){return!!a.loadingPromise})};d.prototype.processResult=function(a,c,f){return m(this,void 0,void 0,function(){return q(this,function(b){if(c instanceof
HTMLImageElement||c instanceof HTMLCanvasElement)a.image=c;return[2]})})};d.prototype.findExtentInfoAt=function(a){for(var c=0,f=this._extents;c<f.length;c++){var b=f[c],d=b.extent;if((new x(d[0],d[1],d[2],d[3],b.spatialReference)).contains(a))return b}return null};d.prototype.getFetchOptions=function(){};d.prototype.redraw=function(a,c){return m(this,void 0,void 0,function(){var d=this;return q(this,function(b){switch(b.label){case 0:return[4,B.forEach(this._images,function(b,f){return m(d,void 0,
void 0,function(){return q(this,function(d){switch(d.label){case 0:return b?[4,a(b,c)]:[2];case 1:return d.sent(),this._createStageObjects(f,b.image),this.emit("draped-data-change"),[2]}})})})];case 1:return b.sent(),[2]}})})};d.prototype._imageSizeDiffers=function(a,c,d){if(!this.maximumDataResolution||H.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;var b=l.width(a)/this.maximumDataResolution.x;a=l.height(a)/this.maximumDataResolution.y;a=Math.abs(a/c.height-a/d.height);return 1.5<Math.abs(b/c.width-
b/d.width)||1.5<a?!0:!1};d.prototype._fetch=function(a,c){return m(this,void 0,void 0,function(){var d,b,n,g,e,h,k,m,p=this;return q(this,function(f){switch(f.label){case 0:if(this.suspended)return[2];d=this._extents[a];b=d.extent;n=new x(b[0],b[1],b[2],b[3],d.spatialReference);this._images[a]||(this._images[a]={texture:null,material:null,rendergeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:l.create(b)});g=this._images[a];g.loadingAbortController&&
(g.loadingAbortController.abort(),g.loadingAbortController=null);if(0===n.width||0===n.height)return this._clearImage(a),[2];e=r.createAbortController();g.loadingAbortController=e;r.onAbort(c,function(){return e.abort()});h=e.signal;k=this._waitFetchReady(h).then(function(){var a=A({requestAsImageElement:!0,pixelRatio:d.pixelRatio},p.getFetchOptions(),{signal:h}),b=d.imageSize;return p.layer.fetchImage(n,b.width,b.height,a)}).then(function(a){if(w.isAborted(h))throw y.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),
w.createAbortError();return p.processResult(g,a)});g.loadingPromise=k;r.always(k,function(){k===g.loadingPromise&&(g.loadingPromise=null,g.loadingAbortController=null)});m=k.then(function(){l.set(g.renderExtent,b);p._createStageObjects(a,g.image);p.notifyChange("updating");p.emit("draped-data-change")}).catch(function(a){a&&!r.isAbortError(a)&&y.error(a);p.notifyChange("updating");throw a;});this.notifyChange("updating");return[4,m];case 1:return f.sent(),[2]}})})};d.prototype._clearImage=function(a){a=
this._images[a];var c=this.view._stage;a&&(a.rendergeometry&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([a.rendergeometry],this),a.rendergeometry=null),a.texture&&(c.remove(4,a.texture.id),a.texture=null),a.material&&(c.remove(3,a.material.id),a.material=null),a.loadingAbortController&&(a.loadingAbortController.abort(),a.loadingAbortController=null),a.loadingPromise=null,a.image=null,a.pixelData=null)};d.prototype._createStageObjects=function(a,c){var d=this.view._stage,b=
this._images[a];b.texture&&(d.remove(4,b.texture.id),b.texture=null);c?(b.texture=new J(c,"dynamicLayer",{width:c.width,height:c.height,wrap:{s:33071,t:33071}}),d.add(4,b.texture)):b.material&&(d.remove(3,b.material.id),b.material=null);!b.material&&b.texture?(b.material=new K({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.fullOpacity,textureId:b.texture.id,receiveSSAO:!1},"dynamicLayer"),d.add(3,b.material)):b.material&&c&&b.material.setParameterValues({textureId:b.texture.id});c=this.view.basemapTerrain.overlayManager.renderer;
if(b.material){var e=void 0,d=this._extents[a].renderLocalOrigin;if(0===a)e=t.createGeometryForExtent(b.renderExtent,-1);else if(1===a){a=this._images[0].renderExtent;if(!a)return;e=t.createOuterImageGeometry(a,b.renderExtent,-1)}else{console.error("DynamicLayerView3D._createStageObjects: Invalid extent idx");return}a=new I(e);a.material=b.material;a.origin=d;a.transformation=E.mat4f64.create();a.name="dynamicLayer";a.uniqueName="dynamicLayer#"+e.id;c.addGeometries([a],this);b.rendergeometry&&c.removeGeometries([b.rendergeometry],
this);b.rendergeometry=a}else b.rendergeometry&&(c.removeGeometries([b.rendergeometry],this),b.rendergeometry=null)};d.prototype._isScaleRangeLayer=function(){return"minScale"in this.layer&&"maxScale"in this.layer};d.prototype._isScaleRangeActive=function(){return this._isScaleRangeLayer()?0<this.layer.minScale||0<this.layer.maxScale:!1};d.prototype._clippedExtent=function(a,c){if("local"!==this.view.viewingMode)return l.set(c,a);var d=this.view.basemapTerrain,b=d.extent;return d.ready&&b?l.intersection(a,
b,c):l.set(c,a)};d.prototype._opacityChangeHandler=function(a){for(var c=0,d=this._images;c<d.length;c++){var b=d[c];b&&b.material&&b.material.setParameterValues({opacity:a})}this.emit("draped-data-change")};d.prototype._suspendedChangeHandler=function(){this.suspended?(this.clear(),this.emit("draped-data-change")):this.refresh()};d.prototype._waitFetchReady=function(a){return m(this,void 0,void 0,function(){return q(this,function(c){switch(c.label){case 0:return this.updateWhenStationary?[4,D.whenOnce(this.view,
"stationary",a)]:[3,2];case 1:c.sent(),c.label=2;case 2:return[2]}})})};h([e.property()],d.prototype,"layer",void 0);h([e.property({dependsOn:["view.scale","layer.minScale","layer.maxScale"]})],d.prototype,"suspended",void 0);h([e.property({type:Boolean})],d.prototype,"supportsDraping",void 0);h([e.property({type:Boolean})],d.prototype,"hasDraped",void 0);h([e.property({readOnly:!0})],d.prototype,"fullExtentInLocalViewSpatialReference",void 0);h([e.property()],d.prototype,"updating",void 0);return d=
h([e.subclass("esri.views.3d.layers.DynamicLayerView3D")],d)}(e.declared(M.RefreshableLayerView(F.LayerView3D(L))));var N=l.create();return v});