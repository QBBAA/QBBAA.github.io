// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Color ../../../../Color ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../geometry/support/aaBoundingBox ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ./polygonUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/NativeLineMaterial ../../webgl-engine/materials/RibbonLineMaterial".split(" "),
function(p,u,B,C,D,E,F,n,w,x,t,h,G,q,H,I,J,K,y,r,z,L,A,M,N,v,O){Object.defineProperty(u,"__esModule",{value:!0});p=function(p){function g(a,c,d,b){a=p.call(this,a,c,d,b)||this;a._hasOutline=!1;return a}B(g,p);g.prototype.doLoad=function(){return D(this,void 0,void 0,function(){return C(this,function(a){this._prepareFillResources();this._prepareOutlineResources();return[2]})})};g.prototype._prepareFillResources=function(){var a=n.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacityAndColor(a);
this._material=new M({color:a,transparent:1>a[3]||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},this._getIdHint("_colormat"));this._context.stage.add(3,this._material)};g.prototype._prepareOutlineResources=function(){var a=this.symbolLayer.outline;if(this._isValidOutline(a)){this._hasOutline=!0;var c;c=w.pt2px(a.size);var d=a.stipplePattern?N.createStipplePattern(a.stipplePattern.map(w.pt2px)):null,a=a.stippleOffColor?F.toUnitRGBA(a.stippleOffColor):
null;c=1.5<c?new O({width:c,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:d,stippleIntegerRepeats:!0,stippleOffColor:a},this._getIdHint("_outline_ribbonlinemat")):new v({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:c,stipplePattern:d,stippleIntegerRepeats:!0,stippleOffColor:a},this._getIdHint("_outline_nativelinemat"));this._outlineMaterial=c;this._context.stage.add(3,this._outlineMaterial)}};
g.prototype._isValidOutline=function(a){return n.isSome(a)&&a.size&&0<a.size&&n.isSome(a.color)};g.prototype.destroy=function(){p.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._material=null);this._outlineMaterial&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)};g.prototype.createGraphics3DGraphic=function(a){var c=a.graphic;if(!this._validateGeometryType(c.geometry,g.validGeometryTypes,this.symbolLayer.type)||
!this._validateGeometry(c.geometry))return null;var d="graphic"+c.uid;a=this._getVertexOpacityAndColor(a.renderingInfo,Uint8Array,255);var b=this.getGraphicElevationContext(c);return"on-the-ground"===b.mode?this._createAsOverlay(c,a,d):this._createAs3DShape(c,a,b,d)};g.prototype.layerOpacityChanged=function(){var a=this._material.getParameters().color,c=n.get(this.symbolLayer,"material","color"),c=this._getCombinedOpacity(c);this._material.setParameterValues({color:[a[0],a[1],a[2],c],transparent:1>
c||this.needsDrivenTransparentPass});this._outlineMaterial&&(a=this._outlineMaterial.getParameters().color,this._outlineMaterial.setParameterValues({color:[a[0],a[1],a[2],this._getOutlineOpacity()]}));return!0};g.prototype.layerElevationInfoChanged=function(a,c,d){var b=this._elevationContext.mode;d=q.elevationModeChangeUpdateType(g.elevationModeChangeTypes,d,b);if(d!==q.SymbolUpdateType.UPDATE)return d;var e=q.needsElevationUpdates2D(b);return this.updateGraphics3DGraphicElevationInfo(a,c,function(){return e})};
g.prototype.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});this._outlineMaterial&&this._outlineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};g.prototype.physicalBasedRenderingChanged=function(){return!0};g.prototype.pixelRatioChanged=function(){return!0};g.prototype._createAs3DShape=function(a,c,d,b){var e=r.geometryAsPolygon(a.geometry);if(n.isNone(e))return null;k.renderData=
r.geometryToRenderInfo(e,this._context.elevationProvider,this._context.renderCoordsHelper,d);k.idHint=b;k.color=c;k.outNum=0;k.outGeometries=[];k.outTransforms=[];k.outMaterials=[];this._createAs3DShapeFill(k);this._hasOutline&&this._createAs3DShapeOutline(k);this._logGeometryCreationWarnings(k.renderData,e.rings,"rings","FillSymbol3DLayer");if(0===k.outNum)return null;a=new L({geometries:k.outGeometries,materials:k.outMaterials,transformations:k.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,
graphicUid:a.uid},idHint:b});a=new I(this,a,k.outGeometries,null,null,G.perVertexElevationAligner,d);a.alignedSampledElevation=k.renderData.sampledElevation;a.needsElevationUpdates=q.needsElevationUpdates2D(d.mode);return a};g.prototype._createAs3DShapeFill=function(a){for(var c=a.renderData.polygons,d=0;d<c.length;++d){var b=c[d],e=b.position,f=b.mapPosition,b=b.holeIndices;if(n.isSome(this._context.clippingExtent)&&(h.empty(l),h.expandWithBuffer(l,f),!h.intersectsClippingArea(l,this._context.clippingExtent)))continue;
b=x(f,b,3);0!==b.length&&(b=new Uint32Array(b),e=r.createColorGeometryData({indices:b,attributeData:{position:e,color:a.color,mapPosition:f}}),e=new z(e,a.idHint),a.outGeometries.push(e),a.outMaterials.push(this._material),a.outTransforms.push(t.mat4f64.IDENTITY),a.outNum++)}};g.prototype._createAs3DShapeOutline=function(a){if(this._hasOutline)for(var c=a.renderData.outlines,d=0;d<c.length;++d){var b=c[d],e=b.position,b=b.mapPosition;if(n.isSome(this._context.clippingExtent)&&(h.empty(l),h.expandWithBuffer(l,
b),!h.intersectsClippingArea(l,this._context.clippingExtent)))continue;e=y.createGeometryData({removeDuplicateStartEnd:this._outlineMaterial instanceof v?0:1,attributeData:{position:e,mapPosition:b}});e=new z(e,a.idHint+"outline"+d);a.outGeometries.push(e);a.outMaterials.push(this._outlineMaterial);a.outTransforms.push(t.mat4f64.IDENTITY);a.outNum++}};g.prototype._createAsOverlay=function(a,c,d){var b=r.geometryAsPolygon(a.geometry);if(n.isNone(b))return null;this._material.renderPriority=this._renderPriority+
this._renderPriorityDelta/2;this._hasOutline&&(this._outlineMaterial.renderPriority=this._renderPriority);m.renderData=r.geometryToRenderInfoDraped(b,this._context.overlaySR);m.idHint=d;m.color=c;m.outNum=0;m.outGeometries=[];m.outBoundingBox=h.empty();m.layerUid=this._context.layer.uid;m.graphicsUid=a.uid;this._createAsOverlayFill(m);this._hasOutline&&this._createAsOverlayOutline(m);this._logGeometryCreationWarnings(m.renderData,b.rings,"rings","FillSymbol3DLayer");return 0<m.outNum?new H(this,m.outGeometries,
m.outBoundingBox):null};g.prototype._createAsOverlayFill=function(a){for(var c=a.renderData.polygons,d=0;d<c.length;++d){var b=c[d],e=b.position,b=b.holeIndices;h.empty(l);h.expandWithBuffer(l,e);if(h.intersectsClippingArea(l,this._context.clippingExtent)&&(b=x(e,b,3),0!==b.length)){h.expand(a.outBoundingBox,l);b=new Uint32Array(b);e=r.createColorGeometryData({indices:b,attributeData:{position:e,color:a.color}});b=new A(e);b.data.layerUid=a.layerUid;b.data.graphicUid=a.graphicsUid;b.material=this._material;
var f=l;b.center=[.5*(f[0]+f[3]),.5*(f[1]+f[4]),0];b.bsRadius=.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]));b.transformation=t.mat4f64.create();b.name=a.idHint;b.uniqueName=a.idHint+"#"+e.id;a.outGeometries.push(b);a.outNum++}}};g.prototype._createAsOverlayOutline=function(a){if(this._hasOutline)for(var c=a.renderData.outlines,d=0;d<c.length;++d){var b=c[d].position;h.empty(l);h.expandWithBuffer(l,b);if(h.intersectsClippingArea(l,this._context.clippingExtent)){h.expand(a.outBoundingBox,
l);var b=y.createGeometryData({removeDuplicateStartEnd:this._outlineMaterial instanceof v?0:1,attributeData:{position:b}}),e=new A(b);e.data.layerUid=a.layerUid;e.data.graphicUid=a.graphicsUid;e.material=this._outlineMaterial;var f=l;e.center=[.5*(f[0]+f[3]),.5*(f[1]+f[4]),0];e.bsRadius=.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]));e.transformation=t.mat4f64.create();e.name=a.idHint+"outline";e.uniqueName=a.idHint+"outline#"+b.id;a.outGeometries.push(e);a.outNum++}}};g.prototype._getOutlineOpacity=
function(){var a=n.get(this.symbolLayer,"outline","color");return this._getLayerOpacity()*(n.isSome(a)?a.a:0)};g.prototype._getOutlineColor=function(){var a=n.get(this.symbolLayer,"outline","color"),c=this._getOutlineOpacity();return K.mixinColorAndOpacity(n.isSome(a)?E.toUnitRGB(a):null,c)};Object.defineProperty(g.prototype,"test",{get:function(){var a=this;return{createAsOverlay:function(c,d,b){return a._createAsOverlay(c,d,b)},createAs3DShape:function(c,d,b,e){return a._createAs3DShape(c,d,b,e)}}},
enumerable:!0,configurable:!0});g.validGeometryTypes=["polyline","polygon","extent"];g.elevationModeChangeTypes={definedChanged:q.SymbolUpdateType.RECREATE,staysOnTheGround:q.SymbolUpdateType.NONE,onTheGroundChanged:q.SymbolUpdateType.RECREATE};return g}(J.default);u.Graphics3DPolygonFillSymbolLayer=p;var l=h.create(),k={idHint:null,renderData:null,color:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},m={idHint:null,renderData:null,color:null,outNum:0,outBoundingBox:null,
outGeometries:null,outMaterials:null,outTransforms:null};u.default=p});