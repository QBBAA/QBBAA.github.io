// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/Evented ../../../../core/Logger ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingRect ../../webgl-engine/lib/Intersector".split(" "),function(C,D,u,
m,v,w,x,h,y,z,n,k,p,A){var g=p.empty(),q=z.mat4f64.create(),b=k.vec3f64.create(),r=k.vec3f64.create(),t=k.vec3f64.create(),l={spatialReference:null,extent:g,context:"scene"},B=x.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");return function(k){function c(a){return k.call(this,a)||this}u(c,k);c.prototype.initialize=function(){var a=this.layerView.view;this.view=a;this.renderCoordsHelper=a.renderCoordsHelper;this.intersector=new A(a.viewingMode);this.intersector.options.store=0;a=this.layerView.layer.fullExtent;
this.zmin=a.zmin;this.zmax=a.zmax};c.prototype.getElevation=function(a,c,d,f){b[0]=a;b[1]=c;b[2]=d;if(!this.renderCoordsHelper.toRenderCoords(b,f,b))return B.error("could not project point for elevation alignment"),null;c=this.layerView.elevationOffset;a=this.zmin+c;c=this.zmax+c;n.vec3.copy(r,b);n.vec3.copy(t,b);this.renderCoordsHelper.setAltitude(c,r);this.renderCoordsHelper.setAltitude(a,t);this.intersector.reset(r,t);this.intersectionHandler.intersect(this.intersector,null,r,t);return this.intersector.results.min.getIntersectionPoint(b)?
this.renderCoordsHelper.getAltitude(b):null};c.prototype.layerChanged=function(){this.spatialReference&&(l.extent=this.computeLayerExtent(),l.spatialReference=this.spatialReference,this.emit("elevation-change",l))};c.prototype.objectChanged=function(a){this.spatialReference&&(l.extent=this.computeObjectExtent(a),l.spatialReference=this.spatialReference,this.emit("elevation-change",l))};c.prototype.computeObjectExtent=function(a){p.empty(g);this.expandExtent(a,g);return g};c.prototype.computeLayerExtent=
function(){p.empty(g);for(var a=0,b=this.layerView.getLoadedNodes();a<b.length;a++)this.expandExtent(b[a],g);return g};c.prototype.expandExtent=function(a,c){var d=a.renderObb;if(d)for(y.mat4.fromQuat(q,d.quaternion),q[12]=d.center[0],q[13]=d.center[1],q[14]=d.center[2],a=0;8>a;++a)b[0]=a&1?d.halfSize[0]:-d.halfSize[0],b[1]=a&2?d.halfSize[1]:-d.halfSize[1],b[2]=a&4?d.halfSize[2]:-d.halfSize[2],n.vec3.transformMat4(b,b,q),this.renderCoordsHelper.fromRenderCoords(b,b,this.spatialReference),p.expand(c,
b);else if(a.renderMbs){var f=a.renderMbs[3],d=n.vec3.copy(r,a.renderMbs);d[0]-=f;d[1]-=f;d[2]-=f;var e=n.vec3.copy(t,a.renderMbs);e[0]+=f;e[1]+=f;e[2]+=f;for(a=0;8>a;++a)b[0]=a&1?d[0]:e[0],b[1]=a&2?d[1]:e[1],b[2]=a&4?d[2]:e[2],this.renderCoordsHelper.fromRenderCoords(b,b,this.spatialReference),p.expand(c,b)}return c};m([h.property({constructOnly:!0})],c.prototype,"layerView",void 0);m([h.property({constructOnly:!0})],c.prototype,"intersectionHandler",void 0);m([h.property()],c.prototype,"view",void 0);
m([h.property({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],c.prototype,"spatialReference",void 0);return c=m([h.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],c)}(h.declared(w.EventedMixin(v)))});