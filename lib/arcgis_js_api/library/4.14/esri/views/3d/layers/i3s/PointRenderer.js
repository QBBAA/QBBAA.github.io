// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f32 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../geometry/support/aaBoundingBox ./PointHighlights ../../support/geometryUtils ../../support/geometryUtils ../../support/orientedBoundingBox ../../webgl-engine/lib/ComponentUtils ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl-engine/lib/intersectorUtils ../../webgl-engine/materials/internal/MaterialUtil ../../webgl-engine/shaders/PointRendererTechnique ../../../webgl/BufferObject ../../../webgl/VertexArrayObject".split(" "),
function(r,t,H,A,Q,R,m,S,D,T,q,U,V,W,I,J,X,Y,K,B,P,Z){function E(b,a,c,g,d){if(c.drawScreenSpace)return c.fixedSize*a*g;d=(d?256:64)*a*g;return c.drawFixedSize?Math.min(c.fixedSize/2,d):0<c.screenMinSize?Math.min(Math.max(c.screenMinSize*a*g,b/2),d):Math.min(b/2,d)}Object.defineProperty(t,"__esModule",{value:!0});var aa={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};r=function(){function b(a){var c=
this;this._params=a;this.type="Point";this._highlights=new U.PointHighlights({forEachNode:function(a){return c.forEachNode(a)},addHighlight:function(a,d,b,f){return c.addHighlight(a,d,b,f)},removeHighlight:function(a,d){return c.removeHighlight(a,d)}});this.canRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=q.create(q.POSITIVE_INFINITY);this._techniqueConfig=
new B.PointRendererTechniqueConfiguration;this.tempMatrix4=Q.mat4f32.create();this.tempVec3=S.vec3f32.create();this.nodes=[]}Object.defineProperty(b.prototype,"needsHighlight",{get:function(){return this._highlights.hasHighlights},enumerable:!0,configurable:!0});b.prototype.initializeRenderContext=function(a){this._initContext=a;this._techniqueRep=this._initContext.shaderTechniqueRep;a.requestRender()};b.prototype.uninitializeRenderContext=function(){};b.prototype.intersect=function(a,c,g,d){var b=
this,f=D.vec3f64.create(),l=D.vec3f64.create(),t=D.vec3f64.create(),L=D.vec3f64.create(),u=W.plane.create(),v=a.camera.perScreenPixelRatio/2,p=a.camera.near,w=this._getSizeParams();m.vec3.subtract(l,d,g);var M=1/m.vec3.length(l);m.vec3.scale(l,l,M);m.vec3.negate(t,l);T.vec4.set(u,l[0],l[1],l[2],-m.vec3.dot(l,g));var r=function(){return function(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""}}(),x=new r,y=new r,A=[],N=q.create(),O=q.create(this._clipBox);q.offset(O,
-g[0],-g[1],-g[2],O);for(var n=function(h){var F=h.splatSize*H._scaleFactor,e=I.minimumDistancePlane(h.obb,u),k=I.maximumDistancePlane(h.obb,u),e=e-(w.drawScreenSpace?0:E(F,e+p,w,v,h.isLeaf)),k=k-(w.drawScreenSpace?0:E(F,k+p,w,v,h.isLeaf)),e=null!=x.dist&&null!=y.dist&&x.dist<e*M&&y.dist>k*M;if(0>k||e)return"continue";k=E(F,k+p,w,v,h.isLeaf);if(!I.intersectLine(h.obb,g,l,k))return"continue";var z=k*k;I.toAaBoundingBox(h.obb,N);q.offset(N,-g[0],-g[1],-g[2],N);var B=!q.contains(O,N);m.vec3.subtract(L,
h.origin,g);for(var k=h.coordinates.length/3,e=function(e){f[0]=L[0]+h.coordinates[3*e];f[1]=L[1]+h.coordinates[3*e+1];f[2]=L[2]+h.coordinates[3*e+2];if(B&&!q.containsPoint(O,f))return"continue";var k=m.vec3.dot(f,l),n=m.vec3.squaredLength(f)-k*k;if(n>z)return"continue";var G=k+p,u=w.drawScreenSpace?0:E(F,G,w,v,h.isLeaf);if(0>k-u)return"continue";G=E(F,G-u,w,v,h.isLeaf);if(n>G*G)return"continue";var C=(k-u)*M,k=function(a){var c=a.point;null==c&&(c=D.vec3f64.create());c[0]=h.origin[0]+h.coordinates[3*
e];c[1]=h.origin[1]+h.coordinates[3*e+1];c[2]=h.origin[2]+h.coordinates[3*e+2];a.point=c;a.dist=C;a.normal=t;a.node=h;a.pointId=e;a.layerUid=b.layerUid};(null==x.dist||C<x.dist)&&(null==c||c(g,d,C))&&k(x);0!==a.options.store&&(null==y.dist||C>y.dist)&&(null==c||c(g,d,C))&&k(y);2!==a.options.store||null!=c&&!c(g,d,C)||(n=new r,k(n),A.push(n))},n=0;n<k;n++)e(n)},H=this,e=0,z=this.nodes;e<z.length;e++)n(z[e]);var J=function(a){var c=a.node,d=a.pointId;return{type:"external",point:a.point,metadata:{layerUid:a.layerUid,
createGraphic:function(){return b._params.createGraphic(c,d,a.point)}}}},n=function(a,c){var d=J(c);a.set(d,c.layerUid+"/"+c.node.id+"/"+c.pointId,c.dist,c.normal,R.mat4f64.IDENTITY,void 0);a.intersector="PointRenderer"};null!=x.dist&&(e=a.results.min,(null==e.dist||x.dist<e.dist)&&n(e,x));null!=y.dist&&0!==a.options.store&&(e=a.results.max,(null==e.dist||y.dist>e.dist)&&n(e,y));if(2===a.options.store)for(e=V.ray.fromPoints(g,d),z=0;z<A.length;z++){var K=A[z],B=new Y.IntersectorResult(e);n(B,K);a.results.all.push(B)}};
b.prototype.render=function(a){if(0!==a.pass&&1!==a.pass&&4!==a.pass)return!1;for(var c=1===a.pass,g=a.rctx,d=0,b=this.nodes;d<b.length;d++){var f=b[d];null==f.vao&&this._initNode(a,f)}d=this._getSizeParams();f=this.selectTechnique(a.pass,d);b=f.program;if(null==b||0===this.nodes.length)return!0;var l=this._clipBox,r=!q.equals(l,q.POSITIVE_INFINITY,function(a,c){return a===c});r||(m.vec3.set(this.tempVec3,-Infinity,-Infinity,-Infinity),b.setUniform3fv("uClipMin",this.tempVec3),m.vec3.set(this.tempVec3,
Infinity,Infinity,Infinity),b.setUniform3fv("uClipMax",this.tempVec3));g.bindProgram(b);f.bindPipelineState(g);b.setUniformMatrix4fv("uProjectionMatrix",a.camera.projectionMatrix);c&&b.setUniform2f("nearFar",a.camera.near,a.camera.far);a.isHighlightPass&&K.bindHighlightRendering(g,{viewport:a.camera.fullViewport,highlightDepthTexture:a.highlightDepthTexture},b);c=a.camera.pixelRatio;d.drawFixedSize&&b.setUniform2f("uPointScale",d.fixedSize*c,a.camera.fullHeight);for(var t=this._slicePlaneEnabled?
a.sliceHelper&&a.sliceHelper.plane:null,u=0,v=this.nodes;u<v.length;u++)if(f=v[u],0!==f.coordinates.length&&(!a.isHighlightPass||f.highlights)){b.setUniform2f("uScreenMinMaxSize",d.screenMinSize*c,(f.isLeaf?256:64)*c);d.drawFixedSize||b.setUniform2f("uPointScale",f.splatSize*this._scaleFactor*c,a.camera.fullHeight/c);var p=f.origin;r&&(m.vec3.set(this.tempVec3,l[0]-p[0],l[1]-p[1],l[2]-p[2]),b.setUniform3fv("uClipMin",this.tempVec3),m.vec3.set(this.tempVec3,l[3]-p[0],l[4]-p[1],l[5]-p[2]),b.setUniform3fv("uClipMax",
this.tempVec3));A.mat4.identity(this.tempMatrix4);A.mat4.translate(this.tempMatrix4,this.tempMatrix4,p);A.mat4.multiply(this.tempMatrix4,a.camera.viewMatrix,this.tempMatrix4);b.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4);t&&K.bindSlicePlane(p,t,b);g.bindVAO(f.vao);a.isHighlightPass?this._renderHighlightFragments(g,f):g.drawArrays(0,0,f.coordinates.length/3)}return!0};b.prototype._renderHighlightFragments=function(a,c){var b=c.highlights;if(b){c=H.unwrap(b[0].component);for(var d=c+1,
m=1;m<b.length;m++){var f=H.unwrap(b[m].component);f!==d&&(d-=c,0<d&&a.drawArrays(0,c,d),c=f);d=f+1}b=d-c;0<b&&a.drawArrays(0,c,b)}};Object.defineProperty(b.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==a&&(this._scaleFactor=a,this._requestRender())},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(a){this._minSizePx!==a&&(this._minSizePx=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"size",{get:function(){return this._size},set:function(a){this._size!==a&&(this._size=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"sizePx",{get:function(){return this._sizePx},set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"clippingBox",{set:function(a){q.set(this._clipBox,a||q.POSITIVE_INFINITY)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"slicePlane",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!0,configurable:!0});b.prototype.addNode=function(a){this.nodes.push(a);this._highlights.nodeAdded(a);this._requestRender()};b.prototype.removeNode=function(a){var c=this,b=null;this.nodes=this.nodes.filter(function(d){return d.id===
a?(b=d,d.vao&&(d.vao.dispose(!0),d.vao=null),c._highlights.nodeRemoved(d),!1):!0});this._requestRender();return b};b.prototype.forEachNode=function(a){this.nodes.forEach(a)};b.prototype.removeAll=function(){this.nodes.forEach(function(a){a.vao&&(a.vao.dispose(!0),a.vao=null)});this._highlights.removeAll();this.nodes=[];this._requestRender()};b.prototype.highlight=function(a,c){return this._highlights.add(a,c)};b.prototype.addHighlight=function(a,c,b,d){a.highlights=J.addHighlight(a.highlights,c,b,
d);this._requestRender()};b.prototype.removeHighlight=function(a,c){a.highlights=J.removeHighlight(a.highlights,c);this._requestRender()};b.prototype._initNode=function(a,c){a=a.rctx;c.vao=new Z(a,X.Default3D,aa,{positions:P.createVertex(a,35044,c.coordinates),colors:P.createVertex(a,35044,c.rgb)})};b.prototype._requestRender=function(){this._initContext&&this._initContext.requestRender()};b.prototype._getSizeParams=function(){var a=this._useFixedSizes,c=a&&!this._useRealWorldSymbolSizes,b=c?this._sizePx:
this._size,d=this._minSizePx;a&&(d=0);return{drawScreenSpace:c,drawFixedSize:a,fixedSize:b,screenMinSize:d}};b.prototype.selectTechnique=function(a,b){this._techniqueConfig.drawScreenSize=b.drawScreenSpace;this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled;this._techniqueConfig.output=1===a?1:4===a?4:0;return this._techniqueRep.acquireAndReleaseExisting(B.PointRendererTechnique,this._techniqueConfig,this._technique)};return b}();t.PointRenderer=r;(function(b){b.isInstanceOfNode=function(a){return a.hasOwnProperty("splatSize")}})(r=
t.PointRenderer||(t.PointRenderer={}));t.PointRenderer=r});