// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/ArrayPool ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/now ../../../../../core/promiseUtils ../../../../../core/watchUtils ../../../../../core/workers ../../../../../core/accessorSupport/decorators ../../../../../geometry/Extent ../../../../../geometry/support/jsonUtils ../../../../../layers/graphics/featureConversionUtils ../../../../../tasks/operations/query ../../../engine ./BaseController ./EditsQueue ../support/DataTile ../support/DataTileFeaturesIndex ../support/Tile ../support/TileUpdateQueue ../../../tiling/TileQueue".split(" "),
function(l,L,R,x,A,r,f,S,T,C,U,M,B,V,W,u,X,N,D,O,Y,E,Z,F,aa,G,ba,P){Object.defineProperty(L,"__esModule",{value:!0});var H=U.getLogger("esri.views.2d.layers.features.controllers.OnDemandController");l=C("esri-featurelayer-webgl");C=C("esri-mobile");var I=l&&"object"===typeof l&&null!=l.maxDrillLevel?l.maxDrillLevel:C?1:4,Q=l&&"object"===typeof l&&null!=l.maxRecordCountFactor?l.maxRecordCountFactor:C?1:3,ca=l&&"object"===typeof l&&null!=l.enablePBFQuery?l.enablePBFQuery:!0,J=new Set,z=[],da=function(){function g(d,
a){this.objectIdField=a;this.client=W.openWithPorts(d)}g.prototype.destroy=function(){this.client.close();this.client=null};g.prototype.executeQuery=function(d,a){return f(this,void 0,void 0,function(){var b;return r(this,function(c){switch(c.label){case 0:return[4,this.client.invoke("queryFeatures",d.toJSON(),a)];case 1:return b=c.sent(),[2,D.convertFromFeatureSet(b,this.objectIdField)]}})})};return g}(),ea=function(){function g(d){this.source=d}g.prototype.destroy=function(){};g.prototype.executeQuery=
function(d,a){return f(this,void 0,void 0,function(){var b;return r(this,function(c){switch(c.label){case 0:return[4,O.executeQueryPBF(this.source,d,{type:"optimized"},a)];case 1:return b=c.sent().data,[2,b]}})})};return g}(),fa=function(){function g(d,a){this.source=d;this.objectIdField=a}g.prototype.destroy=function(){};g.prototype.executeQuery=function(d,a){return f(this,void 0,void 0,function(){var b;return r(this,function(c){switch(c.label){case 0:return[4,O.executeQuery(this.source,d,a)];case 1:return b=
c.sent().data,[2,D.convertFromFeatureSet(b,this.objectIdField)]}})})};return g}();E=function(g){function d(){var a=null!==g&&g.apply(this,arguments)||this;a.type="on-demand";a._queryInfoHash=null;a._dataTileIndex=new aa.default;a._editsQueue=new Z.EditsQueue({processEdits:a._processEdits.bind(a)});a._featuresInFlight=new Map;return a}R(d,g);d.prototype.initialize=function(){var a=this,b=this._createFeatureStore();b.onFeatureAdd=this.onFeatureAdd.bind(this);b.onFeatureRemove=this.onFeatureRemove.bind(this);
this._set("featureStore",b);this._dataTileIndex.featureStore=this.featureStore;this._dataTileIndex.forEach(function(a){return a.done=!1});this._fetchQueue=new P({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(b,c){return a._fetchTile(b,a.queryInfo,c)}});this._patchQueue=new P({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(b,c){return a._fetchTile(b.dataTile,b.queryInfo,c)}});this._updateQueue=new ba.default({tileInfoView:this.tileStore.tileScheme,
process:function(b,c,h){return a._updateTile(b,c,h)}});var c=this.service,b=c.capabilities,h=c.source,c=c.objectIdField;Array.isArray(h)?this.sourceAdapter=new da(h,c):this.sourceAdapter=ca&&b.query.supportsFormatPBF?new ea(h):new fa(h,c);this.handles.add([this.watch("updating",function(b){return!b&&a.onIdle()})]);this.featureStore.events.on("valueRangesChanged",function(b){a.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:b.valueRanges}})})};d.prototype.destroy=function(){this._fetchQueue.clear();
this._patchQueue.clear();this._updateQueue.clear();this._editsQueue.destroy();this.queryEngine.destroy();this.sourceAdapter.destroy()};Object.defineProperty(d.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.featureStore)},enumerable:!0,configurable:!0});Object.defineProperty(d.prototype,"updating",{get:function(){return!this.viewState||this._fetchQueue.updating||this._patchQueue.updating||this._updateQueue.updating||this._editsQueue.updating},enumerable:!0,configurable:!0});
d.prototype.update=function(a,b){return f(this,void 0,void 0,function(){var c,h,d,w,p,K,t=this;return r(this,function(e){switch(e.label){case 0:return this.validateConfig(a),c=JSON.stringify(this.config.filters),h=this.renderer.getAttributeHash(),d=a.availableFields.filter(function(a){return-1===t.availableFields.indexOf(a)}),w=this.config.definitionExpression,this._set("config",a),w!==this.config.definitionExpression&&this._set("queryEngine",this._createQueryEngine(this.featureStore)),[4,this.updatePixelBuffer()];
case 1:return e.sent(),p=c!==JSON.stringify(a.filters),K=h!==this.renderer.getAttributeHash(),b?K?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,3]:[3,6];case 2:e.sent(),e.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return e.sent(),[4,this.featureStore.update(p,a)];case 5:return e.sent(),this.refresh(),[2];case 6:return d.length?[4,this._handleAttributeChange(d)]:[3,8];case 7:e.sent(),e.label=8;case 8:return"heatmap"===this.renderer.type?
[2]:K?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,10];case 9:e.sent(),this.featureStore.forEach(function(a){return t.attributeStore.setAttributeData(a.localId,a,t.geometryInfo,t.viewParams)}),e.label=10;case 10:return[4,this.attributeStore.updateFilters(this)];case 11:return e.sent(),[4,this.featureStore.update(p,a)];case 12:return e.sent(),[4,this.attributeStore.sendUpdates()];case 13:return e.sent(),[2]}})})};d.prototype.invalidate=function(){return f(this,void 0,
void 0,function(){var a,b,c;return r(this,function(d){a=0;for(b=this.tileStore.tiles;a<b.length;a++)c=b[a],this._updateQueue.push(c.id,Date.now());return[2]})})};d.prototype.onIdle=function(){this.featureStore.sweepClusters()};d.prototype.onEdits=function(a){var b=this;this._fetchQueue.pause();this._fetchQueue.reset();return this._editsQueue.push(a).then(function(){b._editsQueue.updating||b._fetchQueue.resume()})};d.prototype.queryFeatures=function(a){return this.queryEngine.executeQuery(a)};d.prototype.queryFeatureCount=
function(a){return this.queryEngine.executeQueryForCount(a)};d.prototype.queryObjectIds=function(a){return this.queryEngine.executeQueryForIds(a)};d.prototype.queryExtent=function(a){return this.queryEngine.executeQueryForExtent(a)};d.prototype.queryStatistics=function(){return f(this,void 0,void 0,function(){var a,b,c,d=this;return r(this,function(h){switch(h.label){case 0:return c=b=a=0,[4,B.all(this.tileStore.tiles.map(function(h){return f(d,void 0,void 0,function(){var d,k,w,e,q,m,n,v,y,f,g;return r(this,
function(p){switch(p.label){case 0:return d=this.queryInfo,k=d.returnCentroid,w=d.returnGeometry,e=this._pixelBuffer,q={pixelBuffer:e,returnGeometry:w,returnCentroid:k,returnOutline:this.returnOutline},m=M(),[4,this.featureStore.executeTileQuery(h,this.spatialReference,q)];case 1:n=p.sent().features;v=M();c+=v-m;a+=n.length;y=0;for(f=n;y<f.length;y++)g=f[y],g.geometry&&(N.isPolygon(g.geometry)?b+=g.geometry.rings.reduce(function(a,b){return a+b.length},0):N.isPolyline(g.geometry)&&(b+=g.geometry.paths.reduce(function(a,
b){return a+b.length},0)));return[2]}})})}))];case 1:return h.sent(),[2,A({},this.featureStore.storeStatistics,{displayedFeatureCount:a,displayedVertexCount:b,displayPreProcessTime:c})]}})})};d.prototype.refresh=function(){return f(this,void 0,void 0,function(){var a=this;return r(this,function(b){switch(b.label){case 0:return this._queryInfoHash=Math.random().toString(),this._dataTileIndex.clear(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.clear(),
this._updateQueue.clear(),this.featureStore.startMarkingUsedFeatures(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),[4,V.whenFalseOnce(this._fetchQueue,"updating")];case 1:return b.sent(),this.featureStore.sweep(),this.featureStore.forEach(function(b){return a.attributeStore.setAttributeData(b.localId,b,a.geometryInfo,a.viewParams)}),this.attributeStore.sendUpdates(),this._updateQueue.resume(),[2]}})})};d.prototype.setViewState=function(a){var b=this,c=this.viewState&&this.viewState.scale;
this.inherited(arguments);this._fetchQueue.state=a;this._updateQueue.state=a;c!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.featureStore.forEach(function(a){return b.attributeStore.setAttributeData(a.localId,a,b.geometryInfo,b.viewParams)}),this.attributeStore.sendUpdates())};d.prototype.getAggregate=function(a){return this.featureStore.getAggregate(a)};d.prototype.getAggregateValueRanges=function(){return this.featureStore.getAggregateValueRanges()};d.prototype.onTileUpdate=function(a){this._manageTiles(a.added,
a.removed);this.featureStore.onTileUpdate(a)};d.prototype.onFeatureAdd=function(a){if(this._featuresInFlight.has(a.objectId)){var b=this._featuresInFlight.get(a.objectId).attributes;a.attributes=A({},b,a.attributes);this._featuresInFlight.delete(a.objectId)}a.localId=this.attributeStore.createLocalId(a.objectId);this.attributeStore.setAttributeData(a.localId,a,this.geometryInfo,this.viewParams)};d.prototype._handleAttributeChange=function(a){return f(this,void 0,void 0,function(){return r(this,function(b){switch(b.label){case 0:return[4,
this._fetchChangedFields(a)];case 1:return b.sent(),[2]}})})};d.prototype._fetchChangedTileFields=function(a,b){return f(this,void 0,void 0,function(){var c;return r(this,function(d){return(c=this._dataTileIndex.get(a.id))?[2,this._fetchChangedTileFieldsDrill(c,b)]:[2]})})};d.prototype._fetchChangedTileFieldsDrill=function(a,b,c){void 0===c&&(c=0);return f(this,void 0,void 0,function(){var d,k,w,p,g,t,e,q,m,n,f=this;return r(this,function(h){switch(h.label){case 0:return d=A({},this.queryInfo,{returnGeometry:!1,
returnCentroid:!1,outFields:b.concat([this.service.objectIdField])}),a.returnExceeded=a.returnExceeded||c>=I,k=a.key,w={key:k,dataTile:a,queryInfo:d},[4,this._patchQueue.push(w)];case 1:p=h.sent();if(!(p.exceededTransferLimit&&c<I))return[3,3];g=a.tile.createChildTiles();t=g.map(function(b){var c=new F.default;c.tile=b;c.displayTile=a.displayTile;return c});return[4,B.all(t.map(function(a){return f._fetchChangedTileFieldsDrill(a,b,c+1)}))];case 2:return h.sent(),[2];case 3:e=0;for(q=p.features;e<
q.length;e++)m=q[e],this.featureStore.has(m.objectId)?(n=this.featureStore.getFeature(m.objectId),n.attributes=A({},n.attributes,m.attributes)):this._featuresInFlight.set(m.objectId,m);return[2]}})})};d.prototype._fetchChangedTileFieldsPaged=function(a,b,c){void 0===c&&(c=0);return f(this,void 0,void 0,function(){var d,k,w,p,g,f,e,q,m,n,v;return r(this,function(h){switch(h.label){case 0:return d=this.service.capabilities.query.supportsMaxRecordCountFactor,k=this.service.tileMaxRecordCount,w=k*(d?
1:Q),p=A({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:b.concat([this.service.objectIdField]),resultOffset:c*w,num:w}),a.returnExceeded=!0,g=a.key,f={key:g,dataTile:a,queryInfo:p},[4,this._patchQueue.push(f)];case 1:e=h.sent();q=0;for(m=e.features;q<m.length;q++)n=m[q],this.featureStore.has(n.objectId)?(v=this.featureStore.getFeature(n.objectId),v.attributes=A({},v.attributes,n.attributes)):this._featuresInFlight.set(n.objectId,n);return e.exceededTransferLimit?[2,this._fetchChangedTileFieldsPaged(a,
b,c+1)]:[2]}})})};d.prototype._fetchChangedFields=function(a){return f(this,void 0,void 0,function(){var b,c,d=this;return r(this,function(h){switch(h.label){case 0:return b=this.tileStore.tiles,c=b.map(function(b){return d._fetchChangedTileFields(b,a)}),[4,B.all(c)];case 1:return h.sent(),[2]}})})};d.prototype._manageTiles=function(a,b){void 0===b&&(b=null);for(var c=this._dataTileIndex,d=this._fetchQueue,k=this._updateQueue,w="esriGeometryPoint"===this.service.geometryType,p=function(a){var b=c.get(a.id);
b?(b.displayTile=a,w?c.forEach(function(c){G.isChildOf(c,b)&&(c.displayTile=a)}):b.done=!1):(b=new F.default,b.tile=a.clone(),b.displayTile=a,c.add(b));g._processDataTile(b)},g=this,f=0;f<a.length;f++){var e=a[f];p(e)}if(b)for(a=0;a<b.length;a++)e=b[a],J.add(e),k.abort(e.id);c.forEach(function(a){J.has(a.displayTile)&&z.push(a)});for(k=0;k<z.length;k++)e=z[k],d.abort(e.id),c.delete(e);z.length=0;J.clear()};d.prototype._processDataTile=function(a){var b=this,c=a.key,d=this._fetchQueue,k=c.id,f=this._queryInfoHash,
c=c.level-a.displayTile.key.level>=I;this._dataTileIndex.add(a);if(a.done||d.has(k)){if(a.queryInfoHash!==f||a.returnExceeded!==c)if(a.done)a.done=!1;else if(d.isOngoing(k))d.abort(k);else{a.queryInfoHash=f;a.returnExceeded=c;return}}else a.queryInfoHash=f,a.returnExceeded=c;a.done?this._invalidateTile(a.displayTile):d.has(k)||d.push(a).then(function(c){return b._handleResponse(a,c)}).catch(function(c){B.isAbortError(c)||H.error(new T("featurelayer-controller:tile-error","Encountered an error when handling tile response",
c));a.done=!0;b._invalidateTile(a.displayTile)})};d.prototype._handleResponse=function(a,b){a.done=!0;D.hydrateOptimizedFeatureSet(b);if(b.exceededTransferLimit)if(a.returnExceeded)this._dataTileIndex.setTileFeatures(a,b.features),this._deleteChildrenDataTiles(a);else{b=a.tile.createChildTiles();for(var c=0;c<b.length;c++){var d=b[c],k=new F.default;k.tile=d;k.displayTile=a.displayTile;this._processDataTile(k)}S.release(b)}else this._dataTileIndex.setTileFeatures(a,b.features),this._deleteChildrenDataTiles(a);
this._invalidateTile(a.tile)};d.prototype._deleteChildrenDataTiles=function(a){this._dataTileIndex.forEach(function(b){G.isChildOf(b,a)&&z.push(b)});for(var b=0;b<z.length;b++){var c=z[b];this._fetchQueue.abort(c.id);this._dataTileIndex.delete(c)}z.length=0};d.prototype._fetchTile=function(a,b,c){return f(this,void 0,void 0,function(){var d,k,f,g,l,t,e,q,m,n,v;return r(this,function(h){switch(h.label){case 0:return d=new X({xmin:a.bounds[0],ymin:a.bounds[1],xmax:a.bounds[2],ymax:a.bounds[3],spatialReference:this.spatialReference}),
k=this.service.geometryType,f="esriGeometryPoint"===k?a.tile:a.displayTile,g=f.extent,l=f.resolution,t=a.returnExceeded,e=this._createQuery(d,g,l,b,Q,t),[4,this.sourceAdapter.executeQuery(e,c)];case 1:q=h.sent();if("esriGeometryPolygon"===k)for(m=0,n=q.features;m<n.length;m++)v=n[m],v.geometry=D.removeCollinearVectices(v.geometry,v.geometry,k,!1,!1);return[2,q]}})})};d.prototype._invalidateTile=function(a){var b=this._updateQueue,c=0;for(a=this.tileStore.intersections(a,this._pixelBuffer);c<a.length;c++){var d=
a[c].tile;b.push(d.id,d.updateTimestamp)}};d.prototype._updateTile=function(a,b,d){return f(this,void 0,void 0,function(){var c,f,g,p,l,t,e,q,m,n,v,y,u=this;return r(this,function(h){switch(h.label){case 0:return c=this.tileStore.get(a),f=this.queryInfo,g=f.returnCentroid,p=f.returnGeometry,l=this._pixelBuffer,t={pixelBuffer:l,returnGeometry:p,returnCentroid:g,returnOutline:this.returnOutline},[4,this.featureStore.executeTileQuery(c,this.spatialReference,t)];case 1:return e=h.sent(),q=e.features,
m=e.objectIds,[4,this.attributeStore.sendUpdates()];case 2:return h.sent(),n={geometryType:this.service.geometryType,features:q,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:c.transform},v=[],y=!0,this._dataTileIndex.forEach(function(a){c.id!==a.id&&G.isChildOf(a,c)&&y&&!a.done&&(y=!1)}),y&&c&&c.objectIds.forEach(function(a){m.has(a)||(a=u.attributeStore.getLocalId(a),v.push(a))}),m.forEach(function(a){c.objectIds.add(a)}),c.updateTimestamp=b,[2,this.processor.onTileData(c,
{clear:!0,addOrUpdate:n.features,remove:v,transformParams:Y.Utils.getTransformParams(n)},d).catch(function(a){B.isAbortError(a)||H.error("update-tile",a)})]}})})};d.prototype._processEdits=function(a,b,c){return f(this,void 0,void 0,function(){var d,g,l,p,u,t=this;return r(this,function(e){switch(e.label){case 0:return d=this._createTempQueryEngine(),g=this._createObjectIdsQuery(a),a.length?[4,this.sourceAdapter.executeQuery(g)]:[3,2];case 1:l=e.sent(),D.hydrateOptimizedFeatureSet(l),this._dataTileIndex.addOrUpdateFeatures(l.features),
d.featureStore.addMany(l.features),e.label=2;case 2:return p=b.concat(a).map(function(a){return t.attributeStore.getLocalId(a)}),this._dataTileIndex.deleteFeaturesById(b),this.attributeStore.sendUpdates(),u=A({},this.queryInfo,{pixelBuffer:this._pixelBuffer,returnOutline:this.returnOutline}),this.tileStore.tiles.map(function(a){return f(t,void 0,void 0,function(){var b,e;return r(this,function(f){switch(f.label){case 0:return[4,d.featureStore.executeTileQuery(a,this.spatialReference,u)];case 1:return b=
f.sent().features,e={transform:a.transform,hasZ:!1,hasM:!1},[2,this.processor.onTileData(a,{addOrUpdate:b,remove:p,transformParams:e},c).catch(function(a){B.isAbortError(a)||H.error("update-tile",a)})]}})})}),d.destroy(),[2]}})})};d.prototype._createObjectIdsQuery=function(a){var b=this._createDefaultQuery(this.queryInfo);b.objectIds=a;return b};x([u.property()],d.prototype,"_fetchQueue",void 0);x([u.property()],d.prototype,"_patchQueue",void 0);x([u.property()],d.prototype,"_updateQueue",void 0);
x([u.property()],d.prototype,"_editsQueue",void 0);x([u.property({readOnly:!0})],d.prototype,"featureStore",void 0);x([u.property()],d.prototype,"sourceAdapter",void 0);x([u.property({readOnly:!0,dependsOn:["featureStore","service"]})],d.prototype,"queryEngine",null);x([u.property({dependsOn:["viewState","_fetchQueue.updating","_updateQueue.updating","_patchQueue.updating","_editsQueue.updating"]})],d.prototype,"updating",null);return d=x([u.subclass("esri.views.2d.layers.features.controllers.OnDemandController")],
d)}(u.declared(E.default));L.default=E});