// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../geometry ../../../Graphic ../../../core/Error ../../../core/Handles ../../../core/has ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/screenUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../layers/graphics/data/projectionSupport ../../../layers/support/PixelBlock ../../../layers/support/TileInfo ../../../layers/support/rasterDatasets/RawBlockCache ../../../layers/support/rasterFunctions/pixelUtils ../../../layers/support/rasterFunctions/rasterProjectionHelper ../engine ../engine/ImageryBitmapSource ./LayerView2D ./support/ExportStrategy ./support/popupUtils2D ../tiling/TileInfoView ../tiling/TileQueue ../tiling/TileStrategy ../../layers/LayerView ../../layers/RefreshableLayerView ../../layers/TileImageryLayerView".split(" "),
function(X,Y,E,y,r,k,z,F,A,G,B,H,t,m,I,C,n,J,K,L,u,v,l,w,M,N,O,P,Q,R,S,T,U,V){var D=H.getLogger("esri.views.2d.layers.TileImageryLayerView2D"),W=[0,0];return function(x){function c(){var a=null!==x&&x.apply(this,arguments)||this;a._handles=new G;a._tileStrategy=null;a._tileInfoView=null;a._fetchQueue=null;a._strategy=null;a._blockCacheRegistryId=null;a._tileInfo=null;a._fullExtent=null;a._bitmapView=null;a._bitmapView2=null;a._emptyTilePixelBlock=null;a._previousSrcResolution=null;a._needBlockCacheUpdate=
!1;a.useWebGLForProcessing=!0;a.useProgressiveUpdate=!0;a.container=new w.Container;a.datumTransformation=null;a.layer=null;return a}E(c,x);c.prototype.initialize=function(){var a=this.layer.tileInfo,b;a&&a.spatialReference||(b=new A("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));a=this.view.spatialReference;J.doesBrowserSupportProjection(a,this.layer.spatialReference)?this._fullExtent=l.projectExtent(this.layer.fullExtent,a,this.datumTransformation):
b=new A("layerview:projection-not-supported","The layer requires projection engine, which is not supported in current browser",{layer:this.layer});b&&this.addResolvingPromise(m.reject(b))};Object.defineProperty(c.prototype,"resampling",{get:function(){return!1},enumerable:!0,configurable:!0});c.prototype.hitTest=function(a,b){if(this.useProgressiveUpdate)return null;if(this.suspended)return m.resolve(null);a=this.view.toMap(I.createScreenPoint(a,b));return m.resolve(new F({attributes:{},geometry:a}))};
c.prototype.update=function(a){this.useProgressiveUpdate?(this._fetchQueue.pause(),this._fetchQueue.state=a.state,this._tileStrategy.update(a),this._fetchQueue.resume()):this._strategy.update(a);var b=!this.useProgressiveUpdate||this._needBlockCacheUpdate;if(this.layer.raster&&b){var b=a.state.extent,d=this._previousViewResolution===a.state.resolution?this._previousSrcResolution:l.projectResolution(new z.Point({x:a.state.resolution,y:a.state.resolution,spatialReference:this.view.spatialReference}),
this.layer.spatialReference,this._fullExtent,this.datumTransformation);u.update(this.layer.raster.url,this._blockCacheRegistryId,b.toJSON?b:z.Extent.fromJSON(b),a.state.resolution,d,this.layer.raster.ioConfig.sampling);this._previousViewResolution=a.state.resolution;this._previousSrcResolution=d;this._needBlockCacheUpdate=!1}this.notifyChange("updating")};c.prototype.attach=function(){var a=this;this.layer.increaseRasterJobHandlerUsage();null==this.useWebGLForProcessing&&(this.useWebGLForProcessing=
this.layer._symbolizer.canRenderInWebGL);B("esri-webgl-texture-float")&&B("esri-webgl-color-buffer-float")||(this.useWebGLForProcessing=!1);this.useWebGLForProcessing&&(this.container.stage.context.gl.getExtension("WEBGL_color_buffer_float"),this.container.stage.context.gl.getExtension("OES_texture_float"));this.layer.hasTilingEffects&&(this.useProgressiveUpdate=!1);this._tileInfo=this._createTileInfo();this._tileInfoView=new Q(this._tileInfo,this._fullExtent);this._fetchQueue=new R({tileInfoView:this._tileInfoView,
concurrency:10,process:function(b,c){return a.fetchTile(b,c)}});this._tileStrategy=new S({cachePolicy:"keep",resampling:this.resampling,acquireTile:function(b){return a.acquireTile(b)},releaseTile:function(b){return a.releaseTile(b)},cacheSize:40,tileInfoView:this._tileInfoView});this._bitmapView=new w.RasterTileContainer(this._tileInfoView,this.clips);this.container.addChild(this._bitmapView);this._bitmapView2=new w.BitmapContainer(this.clips);this._strategy=new O({container:this._bitmapView2,imageNormalizationSupported:!1,
fetchSource:this._fetchImage.bind(this),requestUpdate:function(){return a.requestUpdate()}});this.container.addChild(this._bitmapView2);this._handles.add([C.watch(this,"layer.hasTilingEffects",function(b){a.useProgressiveUpdate=!b;a.requestUpdate()}),C.watch(this,["layer.interpolation","layer.bandIds","layer.renderer"],m.debounce(function(){return a.redrawImage()})),this.clips.on("change",function(){a._bitmapView.setClips(a.clips);a._bitmapView2.setClips(a.clips)})]);var b=this.layer.raster;this._blockCacheRegistryId=
u.register(b.url,b.rasterInfo)};c.prototype.detach=function(){this.layer.decreaseRasterJobHandlerUsage();this.container.removeChild(this._bitmapView);this._bitmapView.removeAllChildren();this._tileStrategy.destroy();this._strategy.destroy();this._fetchQueue.clear();this.container.removeAllChildren();this._fetchQueue=this._tileStrategy=this._tileInfoView=null;u.unregister(this.layer.raster.url,this._blockCacheRegistryId)};c.prototype.moveStart=function(){this.useProgressiveUpdate&&this.requestUpdate()};
c.prototype.viewChange=function(){this.useProgressiveUpdate&&this.requestUpdate()};c.prototype.moveEnd=function(){this.requestUpdate()};c.prototype.redrawImage=function(){return k(this,void 0,void 0,function(){var a,b,c,e=this;return r(this,function(d){this.layer.updateRenderer();this.useProgressiveUpdate&&(a=this.layer,b=a.bandIds,c=a.interpolation,this._bitmapView.children.forEach(function(a){a.bitmap.symbolizerParameters=e.layer._symbolizer.generateWebGLParameters(v.extractBands(a.bitmap.source,
b),!e.useWebGLForProcessing);a.bitmap.bandIds=b;a.bitmap.interpolation=c}));this.container.requestRender();return[2]})})};c.prototype.createFetchPopupFeaturesQueryGeometry=function(a,b){return P.createQueryGeometry(a,b,this.view)};c.prototype.doRefresh=function(){return k(this,void 0,void 0,function(){var a=this;return r(this,function(b){if(this.updateRequested||this.suspended)return[2];this._fetchQueue.reset();this._tileStrategy.tiles.forEach(function(b){return a._enqueueTileFetch(b)});this.notifyChange("updating");
return[2]})})};c.prototype.isUpdating=function(){return 0<this._fetchQueue.length};c.prototype.acquireTile=function(a){var b;a=this._bitmapView.createTile(a);var c=a.bitmap;b=this._tileInfoView.getTileCoords(W,a.key);c.x=b[0];c.y=b[1];c.resolution=this._tileInfoView.getTileResolution(a.key);b=this._tileInfoView.tileInfo.size;c.width=b[0];c.height=b[1];this._enqueueTileFetch(a);this.requestUpdate();this._needBlockCacheUpdate=!0;return a};c.prototype.releaseTile=function(a){var b=this;this._fetchQueue.abort(a.key.id);
this._bitmapView.removeChild(a);a.once("detach",function(){a.destroy();b.requestUpdate()});this.requestUpdate()};c.prototype.fetchTile=function(a,b){return k(this,void 0,void 0,function(){var c,e,f,h,g,p,q;return r(this,function(d){switch(d.label){case 0:c=!t.isNone(b)&&b.signal,e={timestamp:this.refreshTimestamp,tileInfo:this._tileInfo,signal:t.unwrap(c),registryId:this._blockCacheRegistryId,requestRawData:this.useWebGLForProcessing,srcResolution:this._previousSrcResolution,datumTransformation:this.datumTransformation},
d.label=1;case 1:return d.trys.push([1,5,,6]),[4,this.layer.fetchTile(a.level,a.row,a.col,e)];case 2:f=d.sent();if(null===f)return[2,null];h=f.srcExtent;g=f.pixelBlock;return this.useWebGLForProcessing?[3,4]:[4,this.layer.applyRenderer(g)];case 3:return p=d.sent(),[2,{srcExtent:h,pixelBlock:p}];case 4:return[2,f];case 5:q=d.sent();if(!m.isAbortError(q))return[2,null];throw q;case 6:return[2]}})})};c.prototype._createTileInfo=function(){var a=this.layer.tileInfo,b=this.view.spatialReference,c=l.projectPoint(a.origin,
b),e=L.create({spatialReference:b,size:512});if(0===e.origin.x||e.origin.x>c.x)e.origin=l.projectPoint(a.origin,b);return e};c.prototype._enqueueTileFetch=function(a){return k(this,void 0,void 0,function(){var b,c,e,f,h,g,p=this;return r(this,function(d){switch(d.label){case 0:if(this._fetchQueue.has(a.key.id))return[2];d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this._fetchQueue.push(a.key)];case 2:return b=d.sent(),c=this.layer,e=c.bandIds,f=c.interpolation,b&&"pixelBlock"in b?(a.bitmap.source=
b.pixelBlock,a.bitmap.symbolizerParameters=this.layer._symbolizer.generateWebGLParameters(v.extractBands(b.pixelBlock,e),!this.useWebGLForProcessing),a.bitmap.transformGrid||(a.bitmap.transformGrid=b.transformGrid)):(h=this._createEmptyTilePixelBlock(),a.bitmap.source=h,a.bitmap.symbolizerParameters=this.layer._symbolizer.generateWebGLParameters(h,!this.useWebGLForProcessing),a.bitmap.transformGrid=null),a.bitmap.bandIds=e,a.bitmap.width=this._tileInfoView.tileInfo.size[0],a.bitmap.height=this._tileInfoView.tileInfo.size[1],
a.bitmap.interpolation=f,a.attached&&a.bitmap.updateTexture(),a.once("attach",function(){return p.requestUpdate()}),this._bitmapView.addChild(a),[3,4];case 3:return g=d.sent(),m.isAbortError(g)||D.error(g),[3,4];case 4:return this.requestUpdate(),[2]}})})};c.prototype._createEmptyTilePixelBlock=function(){if(!this._emptyTilePixelBlock){var a=this._tileInfoView.tileInfo.size[0],b=this._tileInfoView.tileInfo.size[1];this._emptyTilePixelBlock=new K({width:a,height:b,pixels:[new Uint8Array(a*b)],mask:new Uint8Array(a*
b),pixelType:"u8"})}return this._emptyTilePixelBlock};c.prototype._fetchImage=function(a,b,c,e){return k(this,void 0,void 0,function(){var d,h,g,p,q,k,l,n;return r(this,function(f){switch(f.label){case 0:d=!t.isNone(e)&&e.signal,h={timestamp:this.refreshTimestamp,signal:t.unwrap(d),srcResolution:this._previousSrcResolution,registryId:this._blockCacheRegistryId},f.label=1;case 1:return f.trys.push([1,4,,5]),[4,this.layer.fetchPixels(a,b,c,h)];case 2:g=f.sent();if(null===g)return[2,null];p=g.pixelBlock;
q=v.extractBands(p,this.layer.bandIds);return[4,this.layer.applyRenderer(q)];case 3:return k=f.sent(),l=new M.default(k,g.srcExtent.clone()),l.filter=function(a){return a},this.notifyChange("updating"),[2,l];case 4:return n=f.sent(),m.isAbortError(n)||D.error(n),[3,5];case 5:return[2]}})})};y([n.property({dependsOn:["layer.interpolation?"]})],c.prototype,"resampling",null);return c=y([n.subclass("esri.views.2d.layers.TileImageryLayerView2D")],c)}(n.declared(V.TileImageryLayerView(U.RefreshableLayerView(N.LayerView2D(T)))))});