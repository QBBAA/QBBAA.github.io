// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/screenUtils ../../../../../../core/libs/gl-matrix-2/mat2d ../../../../../../core/libs/gl-matrix-2/mat2df32 ../../../../../../core/libs/gl-matrix-2/vec2 ../../../../../../core/libs/gl-matrix-2/vec2f32 ../../../../../../symbols/cim/enums ../../color ../../number ../../materialKey/MaterialKey ./util ./WGLBaseMarkerTemplate ./WGLDynamicMeshTemplate ../../util/Result".split(" "),
function(q,x,z,D,E,l,A,F,r,B,G,n,e,C,g,H,I,J){Object.defineProperty(x,"__esModule",{value:!0});var K=3.14159265359/180,b=B.vec2f32.create(),p=F.mat2df32.create(),L=E.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");q=function(q){function k(b,d,e){var c=q.call(this,d)||this;c._cimMarkerLayer=d;g.isFunction(d.color)?c._dynamicPropertyMap.set("_fillColor",function(a,c,b){return n.premultiplyAlphaRGBA(d.color(a,c,b))}):c._fillColor=n.premultiplyAlphaRGBA(d.color);g.isFunction(d.outlineColor)?
c._dynamicPropertyMap.set("_outlineColor",function(a,c,b){return n.premultiplyAlphaRGBA(d.outlineColor(a,c,b))}):c._outlineColor=n.premultiplyAlphaRGBA(d.outlineColor);g.isFunction(d.size)?c._dynamicPropertyMap.set("_size",function(a,c,b){return l.pt2px(d.size(a,c,b))}):c._size=l.pt2px(d.size);g.isFunction(d.scaleX)?c._dynamicPropertyMap.set("_scaleX",d.scaleX):c._scaleX=d.scaleX;g.isFunction(d.offsetX)?c._dynamicPropertyMap.set("xOffset",function(a,c,b){return l.pt2px(d.offsetX(a,c,b))}):c.xOffset=
l.pt2px(d.offsetX);g.isFunction(d.offsetY)?c._dynamicPropertyMap.set("yOffset",function(a,c,b){return l.pt2px(d.offsetY(a,c,b))}):c.yOffset=l.pt2px(d.offsetY);g.isFunction(d.outlineWidth)?c._dynamicPropertyMap.set("_outlineWidth",function(a,c,b){return l.pt2px(d.outlineWidth(a,c,b))}):c._outlineWidth=l.pt2px(d.outlineWidth);g.isFunction(d.rotation)?c._dynamicPropertyMap.set("_angle",d.rotation):c._angle=d.rotation;g.isFunction(e)?c._dynamicPropertyMap.set("_scaleFactor",e):c._scaleFactor=e;c._bitSet=
(d.alignment===G.Alignment.MAP?1:0)|(d.colorLocked?1:0)<<1|(d.scaleSymbolsProportionally?1:0)<<3;c._materialKey=C.createMaterialKey(c.geometryType,b,!1);return c}z(k,q);k.fromCIMMarker=function(b,d,e){return new k(b,d,e)};k.prototype.bindFeature=function(g,d,q){var c=this;this._dynamicPropertyMap.forEach(function(a,b){c[b]=a(g,d,q)});var a=this._cimMarkerLayer.materialHash,a="function"===typeof a?a(g,d,q):a;if((a=this._materialCache.get(a))&&J.ok(a.spriteMosaicItem)&&a.spriteMosaicItem){var a=a.spriteMosaicItem,
k=this._cimMarkerLayer.sizeRatio,u=a.width/a.height*this._scaleX,v=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,f=this._size,t=f*u,n=this.xOffset*this._scaleFactor,y=this.yOffset*this._scaleFactor,h=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/l.pt2px(this._cimMarkerLayer.frameHeight):1,x=this._outlineWidth*h,z=l.pt2px(this._cimMarkerLayer.referenceSize),m=0,h=0,w=this._cimMarkerLayer.anchorPoint;w&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?
this._size&&(m=-w.x/(this._size*u),h=w.y/this._size):(m=w.x,h=w.y));this._sizeOutlineWidth=e.i8888to32(Math.round(Math.sqrt(256*t)),Math.round(Math.sqrt(256*f)),Math.round(Math.sqrt(256*x)),Math.round(Math.sqrt(256*z)));A.mat2d.identity(p);A.mat2d.translate(p,p,B.vec2f32.fromValues(n,-y));v&&A.mat2d.rotate(p,p,K*v);u=a.rect.x;v=a.rect.y;n=u+a.rect.width;y=v+a.rect.height;m=.5-((.5+m)*a.width+1)/a.rect.width;h=.5-((.5+h)*a.height+1)/a.rect.height;t=t*k*this._scaleFactor;f=f*k*this._scaleFactor;k=Math.round(64*
k);t*=a.rect.width/a.width;f*=a.rect.height/a.height;m=(m-.5)*t;h=(h-.5)*f;this._bitestAndDistRatio=e.i8888to32(0,0,this._bitSet,k);r.vec2.set(b,m,h);r.vec2.transformMat2d(b,b,p);this._offsetUpperLeft=e.i1616to32(16*b[0],16*b[1]);this._texUpperLeft=e.i1616to32(u,v);r.vec2.set(b,m+t,h);r.vec2.transformMat2d(b,b,p);this._offsetUpperRight=e.i1616to32(16*b[0],16*b[1]);this._texUpperRight=e.i1616to32(n,v);r.vec2.set(b,m,h+f);r.vec2.transformMat2d(b,b,p);this._offsetBottomLeft=e.i1616to32(16*b[0],16*b[1]);
this._texBottomLeft=e.i1616to32(u,y);r.vec2.set(b,m+t,h+f);r.vec2.transformMat2d(b,b,p);this._offsetBottomRight=e.i1616to32(16*b[0],16*b[1]);this._texBottomRight=e.i1616to32(n,y);f=C.MarkerMaterialKey.load(this._materialKey);f.sdf=a.sdf;f.pattern=!0;f.textureBinding=a.textureBinding;this._materialKey=f.data}else L.error(D("mapview-cim","Encountered an error when binding feature"))};return k}(H.default(I.default));x.default=q});