// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/screenUtils ../../alignmentUtils ../../color ../../fontUtils ../../materialKey/MaterialKey ./util ./WGLBaseTextTemplate ./WGLDynamicMeshTemplate ../../util/BidiText".split(" "),function(n,u,x,g,r,p,v,w,c,y,z,A){Object.defineProperty(u,"__esModule",{value:!0});var t=new Set;n=function(n){function m(q,a,f){var b=n.call(this,a)||this;b._horizontalAlignment="center";b._verticalAlignment="middle";b._glyphs=[];
b._cimTextLayer=a;c.isFunction(a.color)?b._dynamicPropertyMap.set("_color",function(b,e,d){return p.premultiplyAlphaRGBA(a.color(b,e,d))}):b._color=p.premultiplyAlphaRGBA(a.color);c.isFunction(a.color)?b._dynamicPropertyMap.set("_haloColor",function(b,e,d){return p.premultiplyAlphaRGBA(a.outlineColor(b,e,d))}):b._haloColor=p.premultiplyAlphaRGBA(a.outlineColor);var k;c.isFunction(a.size)||(k=Math.min(Math.round(g.pt2px(a.size*a.sizeRatio)),127));b._dynamicPropertyMap.set("_size",function(b,e,d){return c.isFunction(a.size)?
Math.min(Math.round(g.pt2px(a.size(b,e,d)*a.sizeRatio)),127):k});c.isFunction(a.outlineSize)?b._dynamicPropertyMap.set("_haloSize",function(b,e,d){return Math.min(Math.floor(5*g.pt2px(a.outlineSize(b,e,d)*a.sizeRatio)),127)}):b._haloSize=Math.min(Math.floor(5*g.pt2px(a.outlineSize*a.sizeRatio)),127);var h;c.isFunction(a.offsetX)||(h=Math.round(g.pt2px(a.offsetX*a.sizeRatio)));b._dynamicPropertyMap.set("_xOffset",function(b,e,d){return c.isFunction(a.offsetX)?Math.round(g.pt2px(a.offsetX(b,e,d)*a.sizeRatio)):
h});var l;c.isFunction(a.offsetY)||(l=Math.round(g.pt2px(a.offsetY*a.sizeRatio)));b._dynamicPropertyMap.set("_yOffset",function(b,e,d){return c.isFunction(a.offsetY)?Math.round(g.pt2px(a.offsetY(b,e,d)*a.sizeRatio)):l});c.isFunction(a.decoration)?b._dynamicPropertyMap.set("_decorationTop",function(b,e,d){return v.getFontDecorationTop(a.decoration(b,e,d))}):b._decorationTop=v.getFontDecorationTop(a.decoration);c.isFunction(a.angle)?b._dynamicPropertyMap.set("_angle",a.angle):b._angle=a.angle;c.isFunction(a.horizontalAlignment)?
b._dynamicPropertyMap.set("_horizontalAlignment",a.horizontalAlignment):b._horizontalAlignment=a.horizontalAlignment;c.isFunction(a.verticalAlignment)?b._dynamicPropertyMap.set("_verticalAlignment",a.verticalAlignment):b._verticalAlignment=a.verticalAlignment;c.isFunction(f)?b._dynamicPropertyMap.set("_scaleFactor",f):b._scaleFactor=f;c.isFunction(a.text)?b._dynamicPropertyMap.set("_text",a.text):b._text=a.text;f=Math.min(Math.round(g.pt2px(a.referenceSize*a.sizeRatio)),127);b._referenceSize=Math.round(Math.sqrt(256*
f));b._materialKey=w.createMaterialKey(b.geometryType,q,!1);q=w.TextMaterialKey.load(b._materialKey);q.sdf=!0;b._bitset=a.colorLocked?1:0;b._materialKey=q.data;return b}x(m,n);m.fromCIMText=function(c,a,f){return new m(c,a,f)};m.prototype.analyze=function(c,a,f,b){var k=this._cimTextLayer;a="string"===typeof k.text?k.text:"function"===typeof k.text?k.text(a,f,b):"";var h=this._glyphs;t.clear();for(f=0;f<a.length;f++)t.add(a.charCodeAt(f));var l=[];t.forEach(function(a){if(h.length<a||void 0===h[a])l[a]=
a});return c.getCIMMosaicItem(k.cim,l).then(function(a){if(a.glyphMosaicItems&&0<a.glyphMosaicItems.length)for(var b=a.glyphMosaicItems,d=0;d<b.length;d++)void 0!==b[d]&&(h[d]=b[d]);return a})};m.prototype.bindFeature=function(c,a,f){var b=this;this._dynamicPropertyMap.forEach(function(d,e){b[e]=d(c,a,f)});if(this._text&&0!==this._text.length){this._size*=this._scaleFactor;this._scale=this._size/24;this._xOffset*=this._scaleFactor;this._yOffset*=this._scaleFactor;this._justify=r.getJustification(this._horizontalAlignment||
"center");this._xAlignD=r.getXAnchorDirection(this._horizontalAlignment||"center");this._yAlignD=-r.getYAnchorDirection(this._verticalAlignment||"baseline");this._baseline="baseline"===(this._verticalAlignment||"baseline");for(var k=this._glyphs,h=A.bidiText(this._text),l=h[0],h=h[1],g=[],e=0;e<l.length;e++)g[l.charCodeAt(e)]=k[l.charCodeAt(e)];this.bindTextInfo(g,l,h);this._computeGlyphs(this._shapedGlyphs,this._shapedBox)}else this._shapedBox=this._shapedGlyphs=this._computedGlyphs=null};return m}(y.default(z.default));
u.default=n});