// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.15/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/now ../../../webgl ./RenderBucket ../webgl/TiledDisplayObject".split(" "),function(n,u,w,v,e,q,x){Object.defineProperty(u,"__esModule",{value:!0});n=function(n){function b(a,y,c,b){c=n.call(this,a,c,b,[4096,4096])||this;c._referenced=0;c._symbolFadeHold=null;c._vectorTileData=null;c._setData=!1;c._symbolUpdateData=null;c._memoryUsed=t;c.rotation=0;c.layerData={};c.status="loading";c._referenced=1;c.styleLayers=y;c.id=
a.id;return c}w(b,n);Object.defineProperty(b.prototype,"hasSymbolBuckets",{get:function(){return!1},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isHoldingForFade",{get:function(){return null!==this._symbolFadeHold},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isSymbolFadeDone",{get:function(){return!this._symbolFadeHold||this._symbolFadeHold<v()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"wasRequested",{get:function(){return"errored"===
this.status||"loaded"===this.status||"reloading"===this.status},enumerable:!0,configurable:!0});b.prototype.setData=function(a,b,c){this._vectorTileData=a;this.client=b;this.refKeys=c;this._memoryUsed=t;this.ready();this._setData=!0};b.prototype.updateSymbolData=function(a){a&&(this._symbolUpdateData=a,this.requestRender())};b.prototype.updateTileData=function(a){this._vectorTileData=a;this.stage.requestRender();this._memoryUsed=t};b.prototype.clearSymbolFadeHold=function(){this._symbolFadeHold=null};
b.prototype.setSymbolHoldDuration=function(a){this._symbolFadeHold=v()+a};b.prototype.hasData=function(){return 0<Object.keys(this.layerData).length};b.prototype.dispose=function(){this.isReady&&this.client&&this.client.invoke("destructTileData",this.id);this._deleteBufferMemory();this.destroy();this._memoryUsed=t};b.prototype.release=function(){return 0===--this._referenced?(this.dispose(),this.attached=!1,this.stage=null,!0):!1};b.prototype.reference=function(){++this._referenced};Object.defineProperty(b.prototype,
"referenced",{get:function(){return this._referenced},enumerable:!0,configurable:!0});b.prototype.getMemoryUsage=function(){var a=this;this._memoryUsed===t&&(this._memoryUsed=z.reduce(function(b,c){return a[c]?b+a[c].size:b},0),this.texture&&(this._memoryUsed+=this.texture.descriptor.width*this.texture.descriptor.height*4),this._vectorTileData&&this._vectorTileData.bufferData&&(this._memoryUsed+=this._vectorTileData.bufferData.reduce(function(a,c){return a+c.byteLength},this._vectorTileData.bufferDataInfo.byteLength+
this._vectorTileData.bucketDataInfo.byteLength)));return this._memoryUsed/(this._referenced||1)};b.prototype.commitChanges=function(){if(this._vectorTileData||this._symbolUpdateData)this._vectorTileData?(this._deleteBufferMemory(),this._createRenderBuckets(),this._createBufferObjects(),this._vectorTileData=null):this._symbolUpdateData&&(this._updateSymbolData(this._symbolUpdateData),this._symbolUpdateData=null)};b.prototype._deleteBufferMemory=function(){for(var a=0,b="fillVertexArrayObject fillDDVertexArrayObject outlineVertexArrayObject lineVertexArrayObject lineDDVertexArrayObject iconVertexArrayObject iconDDVertexArrayObject textVertexArrayObject textDDVertexArrayObject circleVertexArrayObject fillVertexBuffer fillDDVertexBuffer fillIndexBuffer outlineVertexBuffer outlineDDVertexBuffer outlineIndexBuffer lineVertexBuffer lineDDVertexBuffer lineIndexBuffer iconVertexBuffer iconDDVertexBuffer iconIndexBuffer textVertexBuffer textDDVertexBuffer textIndexBuffer circleVertexBuffer circleIndexBuffer texture".split(" ");a<
b.length;a++){var c=b[a];this[c]&&(this[c].dispose(),this[c]=null)}this.layerData={};this.triangleCount=0};b.prototype._createRenderBuckets=function(){for(var a=new Uint32Array(this._vectorTileData.bucketDataInfo),b=a.length,c=0;c<b;){var g=a[c];switch(a[c+1]){case 0:(new q.BackgroundRenderBucket).layerID=g;c+=2;break;case 1:var d=new q.FillRenderBucket;d.layerID=g;d.triangleElementStart=a[c+2];d.triangleElementCount=a[c+3];d.outlineElementStart=a[c+4];d.outlineElementCount=a[c+5];if(0!==d.triangleElementCount||
0!==d.outlineElementCount)this.layerData[g]=d;c+=6;break;case 2:d=new q.LineRenderBucket;d.layerID=g;d.triangleElementStart=a[c+2];d.triangleElementCount=a[c+3];0<d.triangleElementCount&&(this.layerData[g]=d);c+=4;break;case 3:d=new q.SymbolRenderBucket;d.layerID=g;d.isSDF=0!==a[c+2];var f=c+3,e=a[f];f++;for(var l=0;l<e;l++){var m=a[f],k=a[f+1],p=a[f+2];d.iconPerPageElementsMap.set(m,[k,p]);f+=3}var r=a[f];f++;for(l=0;l<r;l++)m=a[f],k=a[f+1],p=a[f+2],d.glyphPerPageElementsMap.set(m,[k,p]),f+=3;if(0<
d.iconPerPageElementsMap.size||0<d.glyphPerPageElementsMap.size)this.layerData[g]=d;c+=5+3*e+3*r;break;case 4:d=new q.CircleRenderBucket;d.layerID=g;d.triangleElementStart=a[c+2];d.triangleElementCount=a[c+3];0<d.triangleElementCount&&(this.layerData[g]=d);c+=4;break;default:console.error("Bad bucket type!"),c+=2}}};b.prototype.attach=function(){return this._setData};b.prototype.attachWithContext=function(a){this.stage={context:a};this.attached=this.attach()};b.prototype._updateSymbolData=function(a){if(!a||
!a.bucketDataInfo)return!0;var b=new Uint32Array(a.bucketDataInfo),c=b.length;if(0===c)return!0;if(!this.isReady)return this.requestRender(),!1;for(var g=this.stage.context,d=new Uint32Array(a.bufferDataInfo),f=d.length,h=0,l=0;l<f;l+=2,h++)switch(d[l]){case 10:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null);this.iconVertexBuffer=e.BufferObject.createVertex(g,35044,a.bufferData[h]);break;case 11:this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=
null);this.iconDDVertexBuffer=e.BufferObject.createVertex(g,35044,a.bufferData[h]);break;case 12:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null);this.iconIndexBuffer=e.BufferObject.createIndex(g,35044,a.bufferData[h]);break;case 13:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null);this.textVertexBuffer=e.BufferObject.createVertex(g,35044,a.bufferData[h]);break;case 14:this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=
null);this.textDDVertexBuffer=e.BufferObject.createVertex(g,35044,a.bufferData[h]);break;case 15:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=e.BufferObject.createIndex(g,35044,a.bufferData[h])}a={};for(var m in this.layerData)3!==this.layerData[m].type&&(a[m]=this.layerData[m]);this.layerData=a;g=this.styleLayers.layers;for(d=0;d<c;){m=b[d];f=new q.SymbolRenderBucket;f.layerID=m;f.isSDF=0!==b[d+2];g.length>f.layerID&&g[f.layerID].type===f.type&&
(a[f.layerID]=f);var k=d+3;m=b[k];k++;for(h=0;h<m;h++){var l=b[k],p=b[k+1],r=b[k+2];f.iconPerPageElementsMap.set(l,[p,r]);k+=3}var n=b[k];k++;for(h=0;h<n;h++)l=b[k],p=b[k+1],r=b[k+2],f.glyphPerPageElementsMap.set(l,[p,r]),k+=3;d+=5+3*m+3*n}this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null);this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null);this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),
this.textVertexArrayObject=null);this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null);return!0};b._createBufferToObject=function(){var a=[];a[1]={create:e.BufferObject.createVertex,var:"fillVertexBuffer"};a[2]={create:e.BufferObject.createVertex,var:"fillDDVertexBuffer"};a[3]={create:e.BufferObject.createIndex,var:"fillIndexBuffer"};a[4]={create:e.BufferObject.createVertex,var:"outlineVertexBuffer"};a[5]={create:e.BufferObject.createVertex,var:"outlineDDVertexBuffer"};
a[6]={create:e.BufferObject.createIndex,var:"outlineIndexBuffer"};a[7]={create:e.BufferObject.createVertex,var:"lineVertexBuffer"};a[8]={create:e.BufferObject.createVertex,var:"lineDDVertexBuffer"};a[9]={create:e.BufferObject.createIndex,var:"lineIndexBuffer"};a[10]={create:e.BufferObject.createVertex,var:"iconVertexBuffer"};a[11]={create:e.BufferObject.createVertex,var:"iconDDVertexBuffer"};a[12]={create:e.BufferObject.createIndex,var:"iconIndexBuffer"};a[13]={create:e.BufferObject.createVertex,
var:"textVertexBuffer"};a[14]={create:e.BufferObject.createVertex,var:"textDDVertexBuffer"};a[15]={create:e.BufferObject.createIndex,var:"textIndexBuffer"};a[16]={create:e.BufferObject.createVertex,var:"circleVertexBuffer"};a[17]={create:e.BufferObject.createIndex,var:"circleIndexBuffer"};return a};b.prototype._createBufferObjects=function(){for(var a=this.stage.context,e=new Uint32Array(this._vectorTileData.bufferDataInfo),c=e.length,g=0;g<c;g+=2){var d=g/2;if(!(0>=e[g+1]||0===this._vectorTileData.bufferData[d].byteLength)){var f=
e[g],h=b.bufferToObject[f];h?this[h.var]?this[h.var].setData(this._vectorTileData.bufferData[d]):this[h.var]=h.create(a,35044,this._vectorTileData.bufferData[d]):console.error("Bad buffer type "+f)}}};b.bufferToObject=b._createBufferToObject();return b}(x.TiledDisplayObject);u.VectorTile=n;var t=-1,z="fillVertexBuffer fillDDVertexBuffer fillIndexBuffer outlineVertexBuffer outlineDDVertexBuffer outlineIndexBuffer lineVertexBuffer lineDDVertexBuffer lineIndexBuffer iconVertexBuffer iconDDVertexBuffer iconIndexBuffer textVertexBuffer textDDVertexBuffer textIndexBuffer circleVertexBuffer circleIndexBuffer".split(" ")});